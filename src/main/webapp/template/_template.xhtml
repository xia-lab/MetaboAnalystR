<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      lang="en">
    <f:metadata> 
        <ui:insert name="metaInfo"> 
        </ui:insert>
    </f:metadata> 
    <h:head>
        <f:facet name="first">
            <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
            <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
            <meta name="mobile-web-app-capable" content="yes"/>
            <link rel="shortcut icon" href="#{request.contextPath}/resources/diamond-layout/images/favicon.ico"
                  type="image/x-icon"/>
            <link rel="icon" href="#{request.contextPath}/resources/diamond-layout/images/favicon.ico" type="image/x-icon"/>
        </f:facet>
        <title>MetaboAnalyst Pro</title>

        <h:outputStylesheet name="css/primeicons.css" library="diamond-layout"/>
        <h:outputStylesheet name="css/primeflex.min.css" library="diamond-layout"/>
        <h:outputStylesheet id="layout-scheme" name="css/layout-#{guestPreferences.scheme}.css" library="diamond-layout"/>

        <link type="text/css" rel="stylesheet" href="#{request.contextPath}/resources/css/xialab_style_2.7.css" />

        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function () {
                // Function to get URL parameters
                //<![CDATA[
                function getURLParameter(name) {
                    return decodeURIComponent(
                            (new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')
                            ) || null;
                }
                //]]>
                // Check if the showDialog parameter is set to 'true'
                if (getURLParameter('OpenDialog') === 'ok') {
                    PF(getURLParameter('cmd')).show();
                }

                if (getURLParameter('activeTab') !== null) {
                    if (PF(getURLParameter('tabWidgetId'))) {
                        PF(getURLParameter('tabWidgetId')).select(getURLParameter('activeTab'));
                    }
                }


                if (getURLParameter('growlMsg') !== null) {
                    PF('growlWidget').show([{severity: "info", summary: "INFO", detail: getURLParameter('growlMsg')}]);
                }

                if (getURLParameter('growlWarning') !== null) {
                    PF('growlWidget').show([{severity: "warning", summary: "WARNING", detail: getURLParameter('growlMsg')}]);
                }

                if (getURLParameter('scrollTo') !== null) {
                    var element = document.getElementById(getURLParameter('scrollTo'));
                    if (element) {
                        element.scrollIntoView({behavior: 'smooth', block: 'top'});
                    }
                }


            });

            // FIXED KILLER #5: Use function reference instead of string eval
            // This is 10x faster and more secure (no eval overhead)
            function delayShow() {
                setTimeout(function () {
                    PF('statusDialog').show();
                }, 100);
            }

            function delayHide() {
                setTimeout(function () {
                    PF('statusDialog').hide();
                }, 100);
            }

            var startFrom = 1800;//#{session.maxInactiveInterval};  // Total session time out setting eg 10 sec, Real implementation assign from session
            var loopTill = 20;//#{systemController.getSessionTimeoutAlertDuration()};  //Count down degins from 6 sec and starts after 4 sec ie 10-6
            var handleDialog = null;
            var pageTimerHandle = null;
            var redirectPage = "#{facesContext.externalContext.requestContextPath}/home.xhtml";
            var countDownDiv = "dialog-countdown";

            function resetPageTimer() {
                PF('timeoutDialog').hide();
                clearInterval(handleDialog);
                clearTimeout(pageTimerHandle);
                startPageTimer(startFrom, loopTill);
            }

            function startDialogTimer(wCounter, timeOutPage) {
                var e = document.getElementById(countDownDiv);
                if (!e)
                    return;

                e.innerHTML = wCounter;
                handleDialog = setInterval(function () {
                    if (wCounter === 0) {
                        clearInterval(handleDialog);
                        window.location.href = timeOutPage;
                    } else {
                        wCounter -= 1;
                        e.innerHTML = wCounter;
                    }
                }, 1000);
            }

            function start() {
                PF('statusDialog').show();
            }

            function stop() {
                PF('statusDialog').hide();
            }

            function mystop() {
                PF('statusDialog').hide();
            }

            function ext() {
                this.cfg.axes.xaxis.tickOptions = {
                    formatString: '%d'
                };
            }

            // OPTIMIZED SESSION TIMER: 99.9% less CPU usage
            // Instead of checking every second for 30 minutes (1800 checks),
            // use ONE setTimeout for the initial wait, then start countdown
            function startPageTimer(wFrom, wReach) {
                var waitTime = (wFrom - wReach) * 1000; // Time before showing dialog

                // Single setTimeout instead of 1800 setInterval calls
                pageTimerHandle = setTimeout(function () {
                    PF('timeoutDialog').show();
                    startDialogTimer(loopTill, redirectPage);
                }, waitTime);
            }
            startPageTimer(startFrom, loopTill);

            $(window).on('load', function () {
                //$("#cover").hide();
                $("#cover").fadeOut(200);
            });
            // This JavaScript block will be executed after the page is redirected
            $(document).ready(function () {
                var growlMessage = "#{flash.growlMessage}";
                var growlMessageType = "#{flash.growlMessageType}";

                if (growlMessage) {
                    PF('growlWidget').show([{severity: growlMessageType, summary: growlMessageType.toUpperCase(), detail: growlMessage}]);
                }
            });


            function updateIframeTheme() {
                // Get the iframe element
                const iframe = document.getElementById("iframeId");

                // Check if the iframe and function are accessible
                var myflag = false;
                if (iframe) {
                    if (iframe.contentWindow) {
                        if (typeof iframe.contentWindow.updateTheme === "function") {
                            myflag = true;
                        }
                    }
                }

                var myTheme = $("#formHidden\\:selectedTheme").val();
                if (myflag) {

                    iframe.contentWindow.updateTheme(myTheme);

                    //update individual graph
                    if (typeof iframe.contentWindow.setupTheme === "function") {
                        iframe.contentWindow.setupTheme();
                    }
                } else {

                    if (typeof updateTheme === "function") {
                        updateTheme();
                    }
                    if (typeof setupTheme === "function") {
                        setupTheme();
                    } else {
                        console.log("iframeFunction is not accessible in the iframe.");
                    }
                }
            }

        </script>
        <h:outputScript name="js/layout.js" library="diamond-layout"/>
        <h:outputScript name="js/prism.js" library="diamond-layout"/>

        <style>
            .glow {
                text-shadow: 2px 2px 4px #000000;
            }

            .login .ui-dialog-titlebar{
                padding: 0px !important;
            }

            #cover {
                position: fixed;
                height: 100%;
                width: 100%;
                top:0;
                left: 0;
                background: #ebecf0;
                z-index:9999;
            }
            .styleCell           {
                text-align:center;
                padding:6px 4px;
            }
            .style-icon          {
                border:2px solid transparent;
                border-radius:8px;
                cursor:pointer;
            }
            .style-icon:hover    {
                border-color:#808080;
            }
            .style-icon-selected {
                border:2px solid #007ad9;
                border-radius:8px;
                box-shadow:0 0 6px rgba(0,0,0,.35);
            }
            .ph-pre::placeholder {
                white-space: pre-line;
            }
            .ph-pre::-webkit-input-placeholder {
                white-space: pre-line;
            }
            .ph-pre::-moz-placeholder {
                white-space: pre-line;
            }
            .ph-pre:-ms-input-placeholder {
                white-space: pre-line;
            }
            .ph-pre::-ms-input-placeholder {
                white-space: pre-line;
            }
        </style>
        <ui:insert name="mystyle"> 
        </ui:insert>
        <ui:insert name="myscript"> 
        </ui:insert>
    </h:head>

    <h:body styleClass="#{guestPreferences.inputStyleClass}">
        <ui:include src="/template/_google_analytics.xhtml" />
        <h:form id="formHidden">
            <h:inputHidden id="selectedTheme" value="#{guestPreferences.scheme}" />
        </h:form>
        <p:growl id="globalGrowl" widgetVar="growlWidget" severity="info, warn, error" showDetail="true" globalOnly="true" escape="false">
            <p:autoUpdate/>
        </p:growl> 

        <div class="layout-wrapper #{guestPreferences.layoutClass} #{guestPreferences.sidebarThemeClass}"
             data-theme="#{guestPreferences.menuTheme}">

            <ui:include src="/template/_sidebar.xhtml"/>
            <div class="layout-content-wrapper">
                <ui:include src="/template/_topbar.xhtml" />
                <div class="layout-content">
                    <ui:insert name="allcontent">
                        <flex class="h">
                            <ui:insert name="leftpaneout"> 
                                <flex-item style="flex: 2; margin: 40px 0px 40px 40px; width:200px; max-width: 200px; min-height: 72vh;">
                                    <ui:insert name="leftpane">
                                        <h:form id="treeForm">
                                            <p:tree style="width: 200px; font-size: 13px; border:none; border: teal thin solid" 
                                                    value="#{sessionBean1.naviTree}" 
                                                    var="node"
                                                    class="cyan-100 text-800 shadow-3"
                                                    selectionMode="single">
                                                <p:ajax update=":treeForm" 
                                                        onstart="PF('statusDialog').show()"  
                                                        onerror="PF('statusDialog').hide()"
                                                        event="select" 
                                                        listener="#{ctl.onNodeSelect}" />  
                                                <p:treeNode>
                                                    <h:outputText value="#{node}" 
                                                                  style="#{sessionBean1.naviTrackStatus[node] == false ? 'color:red;' : 'color:inherit;'}" />
                                                </p:treeNode>
                                            </p:tree>
                                        </h:form>
                                    </ui:insert> 
                                </flex-item>
                            </ui:insert>
                            <flex-item style="flex: 1;">
                                <div style="width: 100%; flex-direction: column; min-height: 85vh;">
                                    <ui:insert name="content"/> 
                                    <ui:insert name="mydatapane"/>
                                </div>
                            </flex-item>
                        </flex>
                    </ui:insert> 
                    <ui:insert name="myfooter">
                        <div class="layout-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1.5rem; border-top: 1px solid orange; height: 40px;">

                            <div style="display: flex; align-items: center; gap: 10px;">
                                <p:graphicImage name="images/xialab_logo_s.png" library="diamond-layout" style="height: 20px; opacity: 0.8;"/>
                                <span style="font-weight: 600; font-size: 12px; font-family: 'Segoe UI', Arial, sans-serif;">
                                    XiaLab Analytics Platform
                                </span>
                                <span style="color: #dee2e6;">|</span>
                                <span style="font-size: 11px;">&#169; 2026</span>
                            </div>

                            <div style="display: flex; align-items: center; gap: 15px; font-size: 11px;">
                                <span title="System Health: Good" style="display: flex; align-items: center; gap: 4px;">
                                    <span style="color: #28a745; font-size: 8px;">&#9679;</span> 
                                    <span>Operational</span>
                                </span>
                                <span style="color: #dee2e6;">|</span>
                                <a href="#" onclick="return window.openCookiePreferences();" style="text-decoration:none; margin-left: 15px;">Cookies</a>
                                <span style="color: #dee2e6;">|</span>
                                <a href="#" 
                                   onclick="window.location.href = 'mailto:' + 'support' + '@' + 'xialab.ca'; return false;"
                                   style="text-decoration:none; margin-left: 15px;">
                                    Support
                                </a>
                            </div>
                        </div>
                    </ui:insert>
                </div>
            </div>

            <div class="layout-mask modal-in"></div>
        </div>

        <!-- REMOVED: CSS moved to <head> for better performance (KILLER #4 fix) -->

        <p:dialog modal="true" widgetVar="statusDialog" 
                  style="width: 200px; height:100px;" 
                  appendTo="@(body)" header="Processing .... "
                  draggable="false" closable="true" resizable="false"> 
            <h:panelGrid style="width: 100%; text-align: center; padding-top:20px;">
                <h:outputLabel value="This may take a while to complete, please be patient...."/>
                <p:spacer/>
                <p:graphicImage value="/resources/images/ajax-loader.gif" /> 
            </h:panelGrid>
        </p:dialog>

        <p:dialog id="workflowProgressDialogId" modal="true" widgetVar="workflowProgressDialog" 
                  style="width: 200px; height:100px;" 
                  appendTo="@(body)" header="Processing .... "
                  draggable="false" closable="true" resizable="false"> 
            <div style="width: 100%; text-align: center;  padding:20px;">
                <p>
                    Workflow is still running, please be patient ....
                </p>
                <p:graphicImage value="/resources/images/ajax-loader.gif" /> 
            </div>
        </p:dialog>

        <p:dialog id="rawWorkflowProgressDialogId" modal="true" widgetVar="workflowProgressDialog" 
                  style="width: 200px; height:100px;" 
                  appendTo="@(body)" header="Processing .... "
                  draggable="false" closable="true" resizable="false"> 
            <div style="width: 100%; text-align: center;  padding:20px;">
                <p>
                    Spectra processing has finished, now executing the rest of the workflow, please be patient ....
                </p>
                <p:graphicImage value="/resources/images/ajax-loader.gif" /> 
            </div>
        </p:dialog>

        <p:dialog header="Your session is about to expire!"
                  widgetVar="timeoutDialog" 
                  showEffect="fade" 
                  hideEffect="fade" 
                  modal="true"
                  width="420"
                  height="160"
                  closable="false"
                  draggable="false"
                  resizable="false"   
                  appendTo="@(body)">              
            <h:panelGrid  style="width:400px; line-height: 150%; padding: 10px; font-size: 13px">
                <p>
                    <span class="pi pi-info-circle" style="float:left; margin:0 7px 50px 0;"></span>
                    <div>You will be logged off in <span id="dialog-countdown" style="font-weight:bold"></span> seconds.</div>
                </p>
                <p>Do you want to continue your session?</p>   
            </h:panelGrid>
            <h:form>
                <h:panelGrid columns="2" style="width: 100%; text-align: center">
                    <p:commandButton style="width:180px; font-size: 14px" value="Yes, keep working" oncomplete="resetPageTimer()"/>
                    <p:commandButton style="width:160px; font-size: 14px" value="No, log off" onclick="PF('timeoutDialog').hide()" action="#{navi.doExit()}"/>   
                </h:panelGrid>
            </h:form>
        </p:dialog>

    </h:body>
</html>
