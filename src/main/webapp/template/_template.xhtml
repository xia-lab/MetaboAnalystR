<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      lang="en">
    <f:metadata> 
        <ui:insert name="metaInfo"> 
        </ui:insert>
    </f:metadata> 
    <h:head>
        <f:facet name="first">
            <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
            <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
            <meta name="mobile-web-app-capable" content="yes"/>
            <link rel="shortcut icon" href="#{request.contextPath}/resources/diamond-layout/images/favicon.ico"
                  type="image/x-icon"/>
            <link rel="icon" href="#{request.contextPath}/resources/diamond-layout/images/favicon.ico" type="image/x-icon"/>
        </f:facet>
        <title>MetaboAnalyst Pro</title>

        <h:outputStylesheet name="css/primeicons.css" library="diamond-layout"/>
        <h:outputStylesheet name="css/primeflex.min.css" library="diamond-layout"/>
        <h:outputStylesheet id="layout-scheme" name="css/layout-#{guestPreferences.scheme}.css" library="diamond-layout"/>

        <link type="text/css" rel="stylesheet" href="#{request.contextPath}/resources/css/xialab_style_2.7.css" />

        <!-- Google tag (gtag.js) -->
        <script async='async' src="https://www.googletagmanager.com/gtag/js?id=G-WNPNCNH1RT"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag('js', new Date());

            gtag('config', 'G-WNPNCNH1RT');
        </script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function () {
                // Function to get URL parameters
                //<![CDATA[
                function getURLParameter(name) {
                    return decodeURIComponent(
                            (new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')
                            ) || null;
                }
                //]]>
                // Check if the showDialog parameter is set to 'true'
                if (getURLParameter('OpenDialog') === 'ok') {
                    PF(getURLParameter('cmd')).show();
                }

                if (getURLParameter('activeTab') !== null) {
                    if (PF(getURLParameter('tabWidgetId'))) {
                        PF(getURLParameter('tabWidgetId')).select(getURLParameter('activeTab'));
                    }
                }


                if (getURLParameter('growlMsg') !== null) {
                    PF('growlWidget').show([{severity: "info", summary: "INFO", detail: getURLParameter('growlMsg')}]);
                }

                if (getURLParameter('growlWarning') !== null) {
                    PF('growlWidget').show([{severity: "warning", summary: "WARNING", detail: getURLParameter('growlMsg')}]);
                }

                if (getURLParameter('scrollTo') !== null) {
                    var element = document.getElementById(getURLParameter('scrollTo'));
                    if (element) {
                        element.scrollIntoView({behavior: 'smooth', block: 'top'});
                    }
                }


            });

            function delayShow() {
                setTimeout("PF('statusDialog').show()", 100);
            }

            function delayHide() {
                setTimeout("PF('statusDialog').hide()", 100);
            }

            var startFrom = 1800;//#{session.maxInactiveInterval};  // Total session time out setting eg 10 sec, Real implementation assign from session
            var loopTill = 20;//#{systemController.getSessionTimeoutAlertDuration()};  //Count down degins from 6 sec and starts after 4 sec ie 10-6
            var reduce = 1;
            var handleDialog = null;
            var redirectPage = "#{facesContext.externalContext.requestContextPath}/home.xhtml";
            var countDownDiv = "dialog-countdown";

            function resetPageTimer() {
                PF('timeoutDialog').hide();
                startPageTimer(startFrom, loopTill);
                clearInterval(handleDialog);
            }

            function startDialogTimer(wCounter, timeOutPage) {
                var e = null;
                if (!e)
                    e = document.getElementById(countDownDiv);
                e.innerHTML = wCounter;
                handleDialog = setInterval(function () {
                    if (wCounter === 0) {
                        clearInterval(handleDialog);
                        window.location.href = timeOutPage;
                    } else {
                        wCounter -= reduce;
                        e.innerHTML = wCounter;
                    }
                }, reduce * 1000);
            }

            function start() {
                PF('statusDialog').show();
            }

            function stop() {
                PF('statusDialog').hide();
            }

            function mystop() {
                PF('statusDialog').hide();
            }

            function ext() {
                this.cfg.axes.xaxis.tickOptions = {
                    formatString: '%d'
                };
            }

            function startPageTimer(wFrom, wReach) {
                var handle = null;
                handle = setInterval(function () {
                    if (wFrom === wReach) {
                        clearInterval(handle);
                        PF('timeoutDialog').show();
                        startDialogTimer(loopTill, redirectPage);
                    } else {
                        wFrom -= reduce;
                    }
                }, reduce * 1000);
            }
            startPageTimer(startFrom, loopTill);

            $(window).on('load', function () {
                //$("#cover").hide();
                $("#cover").fadeOut(200);
            });
            // This JavaScript block will be executed after the page is redirected
            $(document).ready(function () {
                var growlMessage = "#{flash.growlMessage}";
                var growlMessageType = "#{flash.growlMessageType}";

                if (growlMessage) {
                    PF('growlWidget').show([{severity: growlMessageType, summary: growlMessageType.toUpperCase(), detail: growlMessage}]);
                }
            });


            function updateIframeTheme() {
                // Get the iframe element
                const iframe = document.getElementById("iframeId");

                // Check if the iframe and function are accessible
                var myflag = false;
                if (iframe) {
                    if (iframe.contentWindow) {
                        if (typeof iframe.contentWindow.updateTheme === "function") {
                            myflag = true;
                        }
                    }
                }

                var myTheme = $("#formHidden\\:selectedTheme").val();
                if (myflag) {

                    iframe.contentWindow.updateTheme(myTheme);

                    //update individual graph
                    if (typeof iframe.contentWindow.setupTheme === "function") {
                        iframe.contentWindow.setupTheme();
                    }
                } else {

                    if (typeof updateTheme === "function") {
                        updateTheme();
                    }
                    if (typeof setupTheme === "function") {
                        setupTheme();
                    } else {
                        console.log("iframeFunction is not accessible in the iframe.");
                    }
                }
            }

        </script>
        <h:outputScript name="js/layout.js" library="diamond-layout"/>
        <h:outputScript name="js/prism.js" library="diamond-layout"/>

        <style>
            .glow {
                text-shadow: 2px 2px 4px #000000;
            }

            .login .ui-dialog-titlebar{
                padding: 0px !important;
            }

            #cover {
                position: fixed;
                height: 100%;
                width: 100%;
                top:0;
                left: 0;
                background: #ebecf0;
                z-index:9999;
            }
            .styleCell           {
                text-align:center;
                padding:6px 4px;
            }
            .style-icon          {
                border:2px solid transparent;
                border-radius:8px;
                cursor:pointer;
            }
            .style-icon:hover    {
                border-color:#808080;
            }
            .style-icon-selected {
                border:2px solid #007ad9;
                border-radius:8px;
                box-shadow:0 0 6px rgba(0,0,0,.35);
            }
            .ph-pre::placeholder {
                white-space: pre-line;
            }
            .ph-pre::-webkit-input-placeholder {
                white-space: pre-line;
            }
            .ph-pre::-moz-placeholder {
                white-space: pre-line;
            }
            .ph-pre:-ms-input-placeholder {
                white-space: pre-line;
            }
            .ph-pre::-ms-input-placeholder {
                white-space: pre-line;
            }
        </style>
        <ui:insert name="mystyle"> 
        </ui:insert>
        <ui:insert name="myscript"> 
        </ui:insert>
    </h:head>

    <h:body styleClass="#{guestPreferences.inputStyleClass}">
        <h:form id="formHidden">
            <h:inputHidden id="selectedTheme" value="#{guestPreferences.scheme}" />
        </h:form>
        <p:growl id="globalGrowl" widgetVar="growlWidget" severity="info, warn, error" showDetail="true" globalOnly="true" escape="false">
            <p:autoUpdate/>
        </p:growl> 

        <div class="layout-wrapper #{guestPreferences.layoutClass} #{guestPreferences.sidebarThemeClass}"
             data-theme="#{guestPreferences.menuTheme}">

            <ui:include src="/template/_sidebar.xhtml"/>
            <div class="layout-content-wrapper">
                <ui:include src="/template/_topbar.xhtml" />
                <div class="layout-content">
                    <ui:insert name="allcontent">
                        <flex class="h">
                            <ui:insert name="leftpaneout"> 
                                <flex-item style="flex: 2; margin: 40px 0px 40px 40px; width:200px; max-width: 200px; min-height: 72vh;">
                                    <ui:insert name="leftpane">
                                        <h:form id="treeForm">
                                            <p:tree style="width: 200px; font-size: 13px; border:none; border: teal thin solid" 
                                                    value="#{sessionBean1.naviTree}" 
                                                    var="node"
                                                    class="cyan-100 text-800 shadow-3"
                                                    selectionMode="single">
                                                <p:ajax update=":treeForm" 
                                                        onstart="PF('statusDialog').show()"  
                                                        onerror="PF('statusDialog').hide()"
                                                        event="select" 
                                                        listener="#{ctl.onNodeSelect}" />  
                                                <p:treeNode>
                                                    <h:outputText value="#{node}" 
                                                                  style="#{sessionBean1.naviTrackStatus[node] == false ? 'color:red;' : 'color:inherit;'}" />
                                                </p:treeNode>
                                            </p:tree>
                                        </h:form>
                                    </ui:insert> 
                                </flex-item>
                            </ui:insert>
                            <flex-item style="flex: 1;">
                                <div style="width: 100%; flex-direction: column; min-height: 85vh;">
                                    <ui:insert name="content"/> 
                                    <ui:insert name="mydatapane"/>
                                </div>
                            </flex-item>
                        </flex>
                    </ui:insert> 
                    <ui:insert name="myfooter">
                        <div class="layout-footer">
                            <div class="footer-logo-container">
                                <p:graphicImage id="footer-logo" library="diamond-layout"
                                                name="images/xialab_logo_s.png"/>
                                <span styleClass="copyright" style="margin-left:10px">MetaboAnalyst Pro</span>
                            </div>
                            <h:outputText styleClass="copyright" value="&#169; XiaLab Analytics - 2025"/>
                        </div>
                    </ui:insert>
                </div>
            </div>

            <div class="layout-mask modal-in"></div>
        </div>

        <!-- REMOVED: CSS moved to <head> for better performance (KILLER #4 fix) -->

        <p:dialog modal="true" widgetVar="statusDialog" 
                  style="width: 200px; height:100px;" 
                  appendTo="@(body)" header="Processing .... "
                  draggable="false" closable="true" resizable="false"> 
            <h:panelGrid style="width: 100%; text-align: center; padding-top:20px;">
                <h:outputLabel value="This may take a while to complete, please be patient...."/>
                <p:spacer/>
                <p:graphicImage value="/resources/images/ajax-loader.gif" /> 
            </h:panelGrid>
        </p:dialog>

        <p:dialog id="workflowProgressDialogId" modal="true" widgetVar="workflowProgressDialog" 
                  style="width: 200px; height:100px;" 
                  appendTo="@(body)" header="Processing .... "
                  draggable="false" closable="true" resizable="false"> 
            <div style="width: 100%; text-align: center;  padding:20px;">
                <p>
                    Workflow is still running, please be patient ....
                </p>
                <p:graphicImage value="/resources/images/ajax-loader.gif" /> 
            </div>
        </p:dialog>

        <p:dialog id="rawWorkflowProgressDialogId" modal="true" widgetVar="workflowProgressDialog" 
                  style="width: 200px; height:100px;" 
                  appendTo="@(body)" header="Processing .... "
                  draggable="false" closable="true" resizable="false"> 
            <div style="width: 100%; text-align: center;  padding:20px;">
                <p>
                    Spectra processing has finished, now executing the rest of the workflow, please be patient ....
                </p>
                <p:graphicImage value="/resources/images/ajax-loader.gif" /> 
            </div>
        </p:dialog>

        <p:dialog header="Your session is about to expire!"
                  widgetVar="timeoutDialog" 
                  showEffect="fade" 
                  hideEffect="fade" 
                  modal="true"
                  width="420"
                  height="160"
                  closable="false"
                  draggable="false"
                  resizable="false"   
                  appendTo="@(body)">              
            <h:panelGrid  style="width:400px; line-height: 150%; padding: 10px; font-size: 13px">
                <p>
                    <span class="pi pi-info-circle" style="float:left; margin:0 7px 50px 0;"></span>
                    <div>You will be logged off in <span id="dialog-countdown" style="font-weight:bold"></span> seconds.</div>
                </p>
                <p>Do you want to continue your session?</p>   
            </h:panelGrid>
            <h:form>
                <h:panelGrid columns="2" style="width: 100%; text-align: center">
                    <p:commandButton style="width:180px; font-size: 14px" value="Yes, keep working" oncomplete="resetPageTimer()"/>
                    <p:commandButton style="width:160px; font-size: 14px" value="No, log off" onclick="PF('timeoutDialog').hide()" action="#{navi.doExit()}"/>   
                </h:panelGrid>
            </h:form>
        </p:dialog> 
        <p:dialog modal="true" id="graphDialogId" widgetVar="graphDialog" header="Graphics Center"
                  width="590"
                  height="540"
                  appendTo="@(body)"
                  dynamic="true"
                  draggable="true" closable="true" resizable="true"
                  onShow="PrimeFaces.ajax.Request.handle({source: this.id, update: 'myGraphPane:formgraph myGraphPane:rPlotCustomizationForm'});">

            <p:tabView id="myGraphPane" style="width:100%; border: none; font-size: 13px" class="surface-card shadow-1 p-0 text-800">
                <p:ajax event="tabChange" update=":myGraphPane"/>
                <p:tab title ="Resolution">
                    <h:form id="formgraph">
                        <h:panelGrid style="width:100%;">
                            <h:panelGrid columns="2" style="padding-top: 10px; padding-left: 20px">

                                <h:panelGroup layout="block" style="width:100px">
                                    <h:outputLabel value="Type:"/>
                                    <h:outputLink id="typeHelp" style="margin-left:6px; cursor:help;" onclick="return false;">
                                        <i class="pi pi-info-circle" style="font-size:1rem;"></i>
                                    </h:outputLink>
                                </h:panelGroup>

                                <p:selectOneRadio id="themeOpts" value="#{sessionBean1.graphTypeOptAI}">
                                    <f:selectItem itemValue="default" itemLabel="Default image"/>
                                    <f:selectItem itemValue="ai"      itemLabel="AI-generated"/>
                                </p:selectOneRadio>

                                <h:outputLabel value="Resolution:"/>
                                <p:selectOneRadio value="#{sessionBean1.dpiOpt}">
                                    <f:selectItem itemLabel="96 DPI" itemValue="96"/>  
                                    <f:selectItem itemLabel="150 DPI" itemValue="150"/>  
                                    <f:selectItem itemLabel="300 DPI" itemValue="300"/>  
                                </p:selectOneRadio> 

                                <h:outputLabel value="Format:"/>
                                <p:selectOneMenu value="#{sessionBean1.formatOpt}">
                                    <f:selectItem itemLabel="PNG" itemValue="png"/> 
                                    <f:selectItem itemLabel="TIFF" itemValue="tiff"/> 
                                    <f:selectItem itemLabel="PDF" itemValue="pdf"/> 
                                    <f:selectItem itemLabel="SVG" itemValue="svg"/> 
                                    <f:selectItem itemLabel="PostScript" itemValue="ps"/> 
                                </p:selectOneMenu> 

                                <h:outputLabel value="Size:"/>
                                <p:selectOneMenu value="#{sessionBean1.sizeOpt}">
                                    <f:selectItem itemLabel="Default" itemValue="NA"/>  
                                    <f:selectItem itemLabel="7 inches" itemValue="7"/>  
                                    <f:selectItem itemLabel="12 inches" itemValue="12"/>  
                                </p:selectOneMenu>
                                <p:tooltip for="typeHelp" styleClass="helpTip" position="right" showEffect="fade" hideEffect="fade">
                                    <p>
                                        Note: a customized function must be generated first in the
                                        <strong>Customization</strong> tab. After saving, choose
                                        <em>AI-generated</em> to use it; otherwise the default plot is used.
                                    </p>
                                </p:tooltip>
                            </h:panelGrid>

                            <h:panelGrid style="width:100%; text-align: center; padding-top: 10px; padding-bottom: 20px">
                                <p:commandButton value="Submit" 
                                                 style="margin:10px"
                                                 update=":myGraphPane:formgraph"
                                                 onclick="PF('statusDialog').show()" 
                                                 oncomplete="PF('statusDialog').hide()"
                                                 actionListener="#{graphBean.graphBn_action()}"/>

                                <p:divider align="center">
                                    <span class="ui-tag">Download Link</span>
                                </p:divider>
                                <h:panelGroup id="glinkWrap">
                                    <!-- Show real link when present -->
                                    <h:outputText id="glink"
                                                  escape="false"
                                                  value="#{sessionBean1.imgDownloadTxt}"
                                                  rendered="#{not empty sessionBean1.imgDownloadTxt}" />

                                    <!-- Show placeholder when empty -->
                                    <h:outputText id="glinkPlaceholder"
                                                  styleClass="text-muted"
                                                  value="No download link yet."
                                                  rendered="#{empty sessionBean1.imgDownloadTxt}" />
                                </h:panelGroup>
                            </h:panelGrid>
                        </h:panelGrid>
                    </h:form>
                </p:tab>
                <p:tab title ="Colors &amp; Shapes" rendered="#{graphBean.renderStatus}">
                    <h:form>
                        <h:panelGrid columns="2" rendered="#{sessionBean1.analType eq 'mf'}">
                            <h:outputLabel value="Experimental Factor:"/>
                            <p:selectOneMenu value="#{sessionBean1.expFac}">  
                                <f:selectItems value="#{multifacBean.boxMetaOpts}"/>  
                                <p:ajax event="change" update=":myGraphPane" />
                            </p:selectOneMenu>  
                        </h:panelGrid>
                        <h:panelGrid style="text-align: center; width: 100%; ">
                            <p:dataTable id="colTbl" style="margin-bottom: 20px; width: 500px !important; text-align: left" 
                                         var="colorBean" value="#{sessionBean1.colorBeanLists}">  
                                <p:column headerText="Group" style="width:30%">  
                                    <h:outputLabel value="#{colorBean.grpName}" />  
                                </p:column>  
                                <p:column headerText="Color" style="width:40%">  
                                    <p:colorPicker value="#{colorBean.colorPopup}"/>
                                </p:column>  
                                <p:column headerText="Shape*" style="width:30%">  
                                    <p:inputText style="width:80px" value="#{colorBean.shapeType}"/>
                                </p:column> 
                            </p:dataTable>
                            <p:commandButton value="Submit" 
                                             onclick="PF('statusDialog').show()" 
                                             oncomplete="PF('statusDialog').hide()"
                                             actionListener="#{graphBean.updateColorScheme()}"/>    
                        </h:panelGrid>
                        <p:divider align="center">
                            <span class="ui-tag">Notes</span>
                        </p:divider>
                        <h:panelGrid columns="2" style="text-align: left">
                            <h:panelGrid style="width: 200px; line-height: 22px">
                                <ul style="margin-left: 0; padding-left: 0">
                                    <li>
                                        This setting only affects those graphics with group-specific color scheme
                                    </li>
                                    <li>
                                        The <b>shape</b> option currently only affects <u>scores plots</u> in PCA and PLS-DA. 
                                    </li>
                                    <li>
                                        Use shape code <b>0</b> will set it to default shapes. 
                                    </li>
                                </ul>
                            </h:panelGrid>
                            <h:panelGrid style="padding-left:20px; text-align:center">
                                <b style="font-size:1.2em;">*Shape Code*</b>
                                <img src="#{facesContext.externalContext.requestContextPath}/resources/images/symbolsw.png"
                                     style="width:220px" alt="Symbols"/>
                            </h:panelGrid>
                        </h:panelGrid>
                    </h:form>
                </p:tab>

                <p:tab title ="Customization">
                    <h:form id="rPlotCustomizationForm">

                        <h:panelGrid style="width:100%;">
                            <p:outputLabel for="customizationPrompt" value="Enter your instructions:" style="font-weight:bold" />
                            <p:inputTextarea id="customizationPrompt" 
                                             value="#{rPlotCustomizationBean.prompt}"
                                             rows="7" 
                                             style="width:90%"
                                             styleClass="ph-pre"
                                             placeholder="#{rPlotCustomizationBean.placeholder}" 
                                             />

                            <h:panelGrid style="width:100%; text-align: center; padding: 10px" columns="2">
                                <p:commandButton value="Reset"
                                                 icon="pi pi-refresh"
                                                 style="display:block;margin:0 auto;"
                                                 actionListener="#{rPlotCustomizationAgent.resetToDefault(sessionBean1.imageSource)}"
                                                 update=":myGraphPane:rPlotCustomizationForm"
                                                 onstart="$('#custProgressBar').show();"
                                                 oncomplete="$('#custProgressBar').hide();" />

                                <p:commandButton value="Submit"
                                                 style="display:block;margin:0 auto;"
                                                 action="#{rPlotCustomizationBean.applyCustomization}"
                                                 update=":myGraphPane:rPlotCustomizationForm"
                                                 onstart="$('#custProgressBar').show();"
                                                 oncomplete="$('#custProgressBar').hide();" />
                            </h:panelGrid>
                            <p:divider align="center">
                                <span class="ui-tag">Preview</span>
                            </p:divider>
                            <p:scrollPanel mode="native" id="previewPanel" style="text-align:center; height:220px;">
                                <h:outputLink value="#{rPlotCustomizationBean.previewImage}" target="_blank">
                                    <img onerror="this.style.display='none'"
                                         src="#{rPlotCustomizationBean.previewImage}"
                                         width="360"
                                         class="shadow-2 surface-border"
                                         alt="Preview"/>
                                </h:outputLink>
                            </p:scrollPanel>
                        </h:panelGrid>
                    </h:form>
                </p:tab>
            </p:tabView> 
            <div id="custProgressBar" style="display:none; margin-bottom:8px;" 
                 class="indeterminate-progress-bar">
                <div class="indeterminate-progress-bar__progress"></div>
            </div>
        </p:dialog>
    </h:body>
</html>
