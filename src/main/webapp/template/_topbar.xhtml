<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui">
    <script type="text/javascript">
        function scrollToBottom() {
            $('#formChat\\:scrollPanel').scrollTop($('#formChat\\:scrollPanel')[0].scrollHeight);
        }

        function copyShareLink() {
            var shareLink = document.getElementById('formShareLink:shareLink');
            if (!shareLink) {
                console.error("Share link element not found.");
                return;
            }

            var fullLink = shareLink.href;
            if (!fullLink || fullLink === "undefined") {
                console.error("Full link not found.");
                return;
            }

            // Helper function for success handling
            var onSuccess = function() {
                PF('partialLinkDialog').hide();
                alert("Shareable link copied to clipboard!");
            };

            // Helper function for fallback copy
            var fallbackCopy = function() {
                var tempInput = document.createElement("input");
                tempInput.style.position = "absolute";
                tempInput.style.left = "-9999px";
                tempInput.value = fullLink;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                onSuccess();
            };

            // Use modern Clipboard API if available, otherwise fallback
            if (navigator.clipboard) {
                navigator.clipboard.writeText(fullLink).then(onSuccess).catch(fallbackCopy);
            } else {
                fallbackCopy();
            }
        }
    </script>
    <style>
        html {
            scroll-behavior: smooth;
        }

        .indeterminate-progress-bar {
            /* Color */
            z-index:100000000;
            background-color: #d1d5db;
            border-radius: 9999px;
            height: 6px;
            top:0px;
            width:100%;
            position: relative;
            overflow: hidden;
        }

        .indeterminate-progress-bar__progress {
            /* Color */
            background-color: #f6523b;

            /* Absolute position */
            padding-top:7px;
            position: absolute;
            bottom: 0;
            top: 0;
            width: 100%;

            /* Move the bar infinitely */
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-name: indeterminate-progress-bar;

            animation-timing-function: ease-in-out;
        }

        @keyframes indeterminate-progress-bar {
            from {
                left: -50%;
            }
            to {
                left: 100%;
            }
        }

        /* General message styling */
        .chat-message {
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
        }

        /* User messages background (white) */
        .user-message {
            background:var(--surface-100);
            color: inherit !important;
        }


        /* Assistant messages background (grey) */
        .assistant-message {
            background: inherit !important;
            color: inherit !important;
        }

        /* Table styling for markdown tables */
        .assistant-message table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        .assistant-message table th,
        .assistant-message table td {
            border: 1px solid var(--surface-300);
            padding: 8px;
            text-align: left;
        }

        .assistant-message table th {
            background-color: var(--surface-200);
            font-weight: bold;
        }

        .assistant-message table tr:nth-child(even) {
            background-color: var(--surface-50);
        }

        /* Floating Chat Button - Manual colors for reliable rendering */
        .floating-chat-button {
            position: fixed !important;
            bottom: 50px;
            right: 20px;
            z-index: 9999;
            width: 72px !important;
            height: 72px !important;
            border-radius: 50% !important;
            background-color: tomato !important;
            color: white !important;
            font-size: 2.2rem !important;
            border: none !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3) !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0 !important;
        }

        .floating-chat-button:hover {
            background-color: #ff6347 !important;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4) !important;
            transform: scale(1.1) !important;
        }

        .floating-chat-button .ui-button-text {
            display: none !important;
        }

        .floating-chat-button .ui-button-icon-left {
            font-size: 2.2rem !important;
            margin: 0 !important;
            position: static !important;
        }

        /* Responsive Design - Tablet (768px and below) */
        @media (max-width: 768px) {
            .floating-chat-button {
                width: 60px !important;
                height: 60px !important;
                font-size: 1.8rem !important;
                right: 15px;
                bottom: 15px;
            }

            .floating-chat-button .ui-button-icon-left {
                font-size: 1.8rem !important;
            }

            /* Make dialog fill most of screen on tablets */
            .ui-dialog.ui-widget {
                width: 95vw !important;
                max-width: 95vw !important;
            }

            /* Adjust chat dialog height for tablets */
            #formChat\\:scrollPanel {
                width: 100% !important;
                height: 50vh !important;
            }

            /* Adjust input field width */
            #formChat\\:chatInput {
                width: 100% !important;
                min-width: auto !important;
            }
        }

        /* Responsive Design - Mobile (480px and below) */
        @media (max-width: 480px) {
            .floating-chat-button {
                width: 56px !important;
                height: 56px !important;
                font-size: 1.6rem !important;
                right: 10px;
                bottom: 10px;
            }

            .floating-chat-button .ui-button-icon-left {
                font-size: 1.6rem !important;
            }

            /* Full screen dialog on mobile */
            .ui-dialog.ui-widget {
                width: 100vw !important;
                max-width: 100vw !important;
                height: 100vh !important;
                max-height: 100vh !important;
                margin: 0 !important;
                top: 0 !important;
                left: 0 !important;
            }

            /* Adjust chat panel for mobile */
            #formChat\\:scrollPanel {
                width: 100% !important;
                height: calc(100vh - 250px) !important;
            }

            /* Full width input on mobile */
            #formChat\\:chatInput {
                width: 100% !important;
                min-width: auto !important;
            }
        }
    </style>
    <div class="layout-topbar">
        <div class="topbar-left">
            <h:form id="formTrace">
                <ui:insert name="toptrack">
                    <p:breadCrumb id="traceNavi" style="border:none" model="#{ctl.simpleMenuModel}"/>
                </ui:insert>
            </h:form>
        </div>
        <div class="topbar-right">
            <ul class="topbar-menu">
                <li>
                    <h:form id="formColor">
                        <p:selectOneRadio id="colorSel" value="#{guestPreferences.scheme}">
                            <f:selectItem itemLabel="Dim" itemValue="dim"/>
                            <f:selectItem itemLabel="Light" itemValue="light"/>
                            <f:selectItem itemLabel="Dark" itemValue="dark"/>
                            <p:ajax onstart="PrimeFaces.DiamondConfigurator.beforeResourceChange()" update="formHidden:selectedTheme" 
                                    oncomplete="updateIframeTheme()"
                                    listener="#{guestPreferences.onSchemeChange}"/>
                        </p:selectOneRadio>  
                    </h:form>
                </li>
                <li>                    
                    <h:form id="formBell">
                        <p:badge severity="danger" value="#{sessionBean1.noticeSize}" visible="#{sessionBean1.noticeSize gt 0}">
                            <p:commandLink onclick="PF('noticeDialog').show()" actionListener="#{diagramView.setShowNotif(false)}" update=":formNotice :formBell">
                                <i class="pi pi-bell" style="color: tomato !important; font-size: 1.8rem;"/>
                            </p:commandLink>
                        </p:badge>
                    </h:form>
                </li>
                <li class="right-sidebar-item">
                    <a tabindex="0">
                        <i class="pi pi-align-right"></i>
                    </a>
                </li>
            </ul>
            <p:commandButton id="sideCloseBtn" style="display: none" />
            <p:commandButton id="safeLogoutBtn" action="#{fireBaseController.checkLogout()}" style="display: none"/>
            <p:commandButton id="safeLogoutBtnModule" action="#{fireBaseController.checkLogoutModule()}" style="display: none"/>
            <p:commandButton id="checkWorkflowInput" action="#{workflowBean.checkWorkflowInput()}" style="display: none"/>
        </div>
    </div>

    <!-- Floating Chat Button (Bottom Right) -->
    <p:commandButton id="chatFloatingBtn"
                     icon="pi pi-comments"
                     styleClass="floating-chat-button"
                     title="Talk to OmicsBot"
                     onclick="PF('OmicsBotDialog').show();" />

    <p:dialog modal="false" widgetVar="OmicsBotDialog" 
              style="height:600px;width:670px;display: flex;flex-direction: column;" 
              dynamic="true"
              appendTo="@(body)" header="OmicsBot" 
              draggable="true" closable="true" resizable="true"> 
        <h:form id="formChat">
            <h:panelGroup layout="block" style="text-align: right; padding-right: 10px;">
                <p:commandButton value="Reset"
                                 icon="pi pi-refresh"
                                 actionListener="#{myBot.initAssistant()}" style="margin-right: 10px;"
                                 styleClass="mt-3" update="formChat"
                                 title="Reset conversation and start a new chat session"/>
                <p:commandButton value="#{myBot.altMdlName}"  style="margin-right: 10px;"
                                 actionListener="#{myBot.modifyModel()}" styleClass="mt-3"
                                 update="formChat"
                                 title="Toggle between Gemini 3.0 and 2.5 Flash models"/>
                <i class="pi pi-question-circle" alt="help" style="font-size: 1.5rem; padding-top: 2px"
                   title="OmicsBot runs on Gemini 3.0 Flash with our knowledge base. Try to reset or switch to gemini-2.5-flash when there is any issue."/>
            </h:panelGroup>

            <p:scrollPanel id="scrollPanel" style="height: 50vh; width: 670px; line-height: 23px; font-family: Arial, Helvetica, Geneva;" mode="native">
                <p:dataView var="message" value="#{myBot.messages}" 
                            style="padding-bottom:10px;width:100%;" rows="12" paginator="false" 
                            emptyMessage="#{myBot.welcomeMsg}" layout="list">
                    <p:dataViewListItem> 
                        <div class="chat-message #{message.user eq 'User' ? 'user-message' : 'assistant-message'}" style="max-width: 100%; word-wrap: break-word; overflow-wrap: break-word;">
                            <div class="message-content">
                                <p:outputLabel value="#{message.user}" escape="false" style="font-weight:bold; color: salmon"/>:
                                <p:outputLabel value="#{message.content}" escape="false"/>
                            </div>
                        </div>
                    </p:dataViewListItem>
                </p:dataView>
            </p:scrollPanel>
            <div id="progressBar" style="display:none;" class="indeterminate-progress-bar">
                <div class="indeterminate-progress-bar__progress"></div>
            </div>
            <h:panelGrid columns="2" style="padding-top: 4px; width: 90%">
                <p:inputText id="chatInput" value="#{myBot.promptMsg}"
                             style="width:80%; min-width: 560px"
                             class="surface-100"
                             placeholder="Enter your query here ..."
                             title="Type your question about MetaboAnalyst"/>

                <p:commandButton id="sendButton" value="Send"
                                 icon="pi pi-send"
                                 actionListener="#{myBot.sendUserQuery}"
                                 onstart="$('#progressBar').show();"
                                 oncomplete="scrollToBottom();$('#progressBar').hide();"
                                 update="formChat"
                                 title="Send your message to the Omics Assistant" />

                <p:defaultCommand target="sendButton" />
            </h:panelGrid>
        </h:form>
    </p:dialog>

    <p:dialog modal="true" widgetVar="noticeDialog" 
              width="500" 
              dynamic="true"
              appendTo="@(body)" header="System Messages" 
              draggable="false" closable="true" resizable="false"> 

        <p:scrollPanel id="formNotice" mode="native" style="width: 100%; padding: 10px; height:480px; text-align: left; margin-top:20px" 
                       class="surface-card">
            <h:dataTable id="msgPane" var="msg" value="#{sessionBean1.notice}" style="font-size: 13px;">
                <h:column>
                    <h:outputText escape="false" style="width:100%;" value="#{msg}"/>        
                </h:column>
            </h:dataTable>
        </p:scrollPanel>
    </p:dialog>

</ui:composition>
