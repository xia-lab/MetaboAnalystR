<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui">

    <p:dialog modal="true" id="graphDialogId" widgetVar="graphDialog" header="Graphics Center"
              width="590"
              height="540"
              appendTo="@(body)"
              dynamic="true"
              draggable="true" closable="true" resizable="true"
              onShow="PrimeFaces.ajax.Request.handle({source: this.id, update: 'myGraphPane:formgraph myGraphPane:rPlotCustomizationForm'});">

        <p:tabView id="myGraphPane" style="width:100%; border: none; font-size: 13px" class="surface-card shadow-1 p-0 text-800">
            <p:ajax event="tabChange" update=":myGraphPane"/>
            <p:tab title ="Resolution">
                <h:form id="formgraph">
                    <h:panelGrid style="width:100%;">
                        <h:panelGrid columns="2" style="padding-top: 10px; padding-left: 20px">

                            <h:panelGroup layout="block" style="width:100px">
                                <h:outputLabel value="Type:"/>
                                <h:outputLink id="typeHelp" style="margin-left:6px; cursor:help;" onclick="return false;">
                                    <i class="pi pi-info-circle" style="font-size:1rem;"></i>
                                </h:outputLink>
                            </h:panelGroup>

                            <p:selectOneRadio id="themeOpts" value="#{sessionBean1.graphTypeOptAI}">
                                <f:selectItem itemValue="default" itemLabel="Default image"/>
                                <f:selectItem itemValue="ai"      itemLabel="AI-generated"/>
                            </p:selectOneRadio>

                            <h:outputLabel value="Resolution:"/>
                            <p:selectOneRadio value="#{sessionBean1.dpiOpt}">
                                <f:selectItem itemLabel="96 DPI" itemValue="96"/>  
                                <f:selectItem itemLabel="150 DPI" itemValue="150"/>  
                                <f:selectItem itemLabel="300 DPI" itemValue="300"/>  
                            </p:selectOneRadio> 

                            <h:outputLabel value="Format:"/>
                            <p:selectOneMenu value="#{sessionBean1.formatOpt}">
                                <f:selectItem itemLabel="PNG" itemValue="png"/> 
                                <f:selectItem itemLabel="TIFF" itemValue="tiff"/> 
                                <f:selectItem itemLabel="PDF" itemValue="pdf"/> 
                                <f:selectItem itemLabel="SVG" itemValue="svg"/> 
                                <f:selectItem itemLabel="PostScript" itemValue="ps"/> 
                            </p:selectOneMenu> 

                            <h:outputLabel value="Size:"/>
                            <p:selectOneMenu value="#{sessionBean1.sizeOpt}">
                                <f:selectItem itemLabel="Default" itemValue="NA"/>  
                                <f:selectItem itemLabel="7 inches" itemValue="7"/>  
                                <f:selectItem itemLabel="12 inches" itemValue="12"/>  
                            </p:selectOneMenu>
                            <p:tooltip for="typeHelp" styleClass="helpTip" position="right" showEffect="fade" hideEffect="fade">
                                <p>
                                    Note: a customized function must be generated first in the
                                    <strong>Customization</strong> tab. After saving, choose
                                    <em>AI-generated</em> to use it; otherwise the default plot is used.
                                </p>
                            </p:tooltip>
                        </h:panelGrid>

                        <h:panelGrid style="width:100%; text-align: center; padding-top: 10px; padding-bottom: 20px">
                            <p:commandButton value="Submit" 
                                             style="margin:10px"
                                             update=":myGraphPane:formgraph"
                                             onclick="PF('statusDialog').show()" 
                                             oncomplete="PF('statusDialog').hide()"
                                             actionListener="#{graphBean.graphBn_action()}"/>

                            <p:divider align="center">
                                <span class="ui-tag">Download Link</span>
                            </p:divider>
                            <h:panelGroup id="glinkWrap">
                                <!-- Show real link when present -->
                                <h:outputText id="glink"
                                              escape="false"
                                              value="#{sessionBean1.imgDownloadTxt}"
                                              rendered="#{not empty sessionBean1.imgDownloadTxt}" />

                                <!-- Show placeholder when empty -->
                                <h:outputText id="glinkPlaceholder"
                                              styleClass="text-muted"
                                              value="No download link yet."
                                              rendered="#{empty sessionBean1.imgDownloadTxt}" />
                            </h:panelGroup>
                        </h:panelGrid>
                    </h:panelGrid>
                </h:form>
            </p:tab>
            <p:tab title ="Colors &amp; Shapes" rendered="#{graphBean.renderStatus}">
                <h:form>
                    <h:panelGrid columns="2" rendered="#{sessionBean1.analType eq 'mf'}">
                        <h:outputLabel value="Experimental Factor:"/>
                        <p:selectOneMenu value="#{sessionBean1.expFac}">  
                            <f:selectItems value="#{multifacBean.boxMetaOpts}"/>  
                            <p:ajax event="change" update=":myGraphPane" />
                        </p:selectOneMenu>  
                    </h:panelGrid>
                    <h:panelGrid style="text-align: center; width: 100%; ">
                        <p:dataTable id="colTbl" style="margin-bottom: 20px; width: 500px !important; text-align: left" 
                                     var="colorBean" value="#{sessionBean1.colorBeanLists}">  
                            <p:column headerText="Group" style="width:30%">  
                                <h:outputLabel value="#{colorBean.grpName}" />  
                            </p:column>  
                            <p:column headerText="Color" style="width:40%">  
                                <p:colorPicker value="#{colorBean.colorPopup}"/>
                            </p:column>  
                            <p:column headerText="Shape*" style="width:30%">  
                                <p:inputText style="width:80px" value="#{colorBean.shapeType}"/>
                            </p:column> 
                        </p:dataTable>
                        <p:commandButton value="Submit" 
                                         onclick="PF('statusDialog').show()" 
                                         oncomplete="PF('statusDialog').hide()"
                                         actionListener="#{graphBean.updateColorScheme()}"/>    
                    </h:panelGrid>
                    <p:divider align="center">
                        <span class="ui-tag">Notes</span>
                    </p:divider>
                    <h:panelGrid columns="2" style="text-align: left">
                        <h:panelGrid style="width: 200px; line-height: 22px">
                            <ul style="margin-left: 0; padding-left: 0">
                                <li>
                                    This setting only affects those graphics with group-specific color scheme
                                </li>
                                <li>
                                    The <b>shape</b> option currently only affects <u>scores plots</u> in PCA and PLS-DA. 
                                </li>
                                <li>
                                    Use shape code <b>0</b> will set it to default shapes. 
                                </li>
                            </ul>
                        </h:panelGrid>
                        <h:panelGrid style="padding-left:20px; text-align:center">
                            <b style="font-size:1.2em;">*Shape Code*</b>
                            <img src="#{facesContext.externalContext.requestContextPath}/resources/images/symbolsw.png"
                                 style="width:220px" alt="Symbols"/>
                        </h:panelGrid>
                    </h:panelGrid>
                </h:form>
            </p:tab>

            <p:tab title ="Customization">
                <h:form id="rPlotCustomizationForm">

                    <h:panelGrid style="width:100%;">
                        <p:outputLabel for="customizationPrompt" value="Enter your instructions:" style="font-weight:bold" />
                        <p:inputTextarea id="customizationPrompt" 
                                         value="#{rPlotCustomizationBean.prompt}"
                                         rows="7" 
                                         style="width:90%"
                                         styleClass="ph-pre"
                                         placeholder="#{rPlotCustomizationBean.placeholder}" 
                                         />

                        <h:panelGrid style="width:100%; text-align: center; padding: 10px" columns="2">
                            <p:commandButton value="Reset"
                                             icon="pi pi-refresh"
                                             style="display:block;margin:0 auto;"
                                             actionListener="#{rPlotCustomizationAgent.resetToDefault(sessionBean1.imageSource)}"
                                             update=":myGraphPane:rPlotCustomizationForm"
                                             onstart="$('#custProgressBar').show();"
                                             oncomplete="$('#custProgressBar').hide();" />

                            <p:commandButton value="Submit"
                                             style="display:block;margin:0 auto;"
                                             action="#{rPlotCustomizationBean.applyCustomization}"
                                             update=":myGraphPane:rPlotCustomizationForm"
                                             onstart="$('#custProgressBar').show();"
                                             oncomplete="$('#custProgressBar').hide();" />
                        </h:panelGrid>
                        <p:divider align="center">
                            <span class="ui-tag">Preview</span>
                        </p:divider>
                        <p:scrollPanel mode="native" id="previewPanel" style="text-align:center; height:220px;">
                            <h:outputLink value="#{rPlotCustomizationBean.previewImage}" target="_blank">
                                <img onerror="this.style.display='none'"
                                     src="#{rPlotCustomizationBean.previewImage}"
                                     width="360"
                                     class="shadow-2 surface-border"
                                     alt="Preview"/>
                            </h:outputLink>
                        </p:scrollPanel>
                    </h:panelGrid>
                </h:form>
            </p:tab>
        </p:tabView> 
        <div id="custProgressBar" style="display:none; margin-bottom:8px;"
             class="indeterminate-progress-bar">
            <div class="indeterminate-progress-bar__progress"></div>
        </div>
    </p:dialog>

</ui:composition>

