<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/template/_template_workflow.xhtml">
    <ui:define name="metaInfo">
        <f:event type="preRenderView" listener="#{sessionBean1.addNaviTrack('Upload', '/Secure/workflow/upload/UploadView.xhtml')}"/>
        <f:event type="preRenderView" listener="#{workflowBean.loadDefaultWorkflows()}"></f:event> 

    </ui:define>  
    <ui:define name="content">
        <style>
            /* Ensure the file upload button remains consistent in size */
            .file-upload-custom .ui-fileupload-button {
                width: 120px; /* Set a fixed width for the button */
                display: inline-block;
                white-space: nowrap;
            }

            /* Control the filename display to avoid shrinking */
            .file-upload-custom .ui-fileupload-filename {
                display: inline-block;
                /* Limit the filename display */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                vertical-align: middle;
                padding-left: 10px; /* Add space between the button and the filename */
            }

            /* Style to adjust the overall file upload container */
            .file-upload-custom .ui-fileupload {
                display: inline-block;
                width: auto;
                vertical-align: middle;
            }

            /* Ensure the file upload input remains consistent */
            .file-upload-custom .ui-fileupload-choose {
                width: 200px; /* Same width for the button */
                height: 30px; /* Adjust the height if necessary */
            }

            .ui-inputtextarea:disabled {
                color: white !important; /* Set font color to white */
                background-color: #333333; /* Optionally, set a dark background for contrast */
                opacity: 1 !important; /* Remove dimming effect on the text */
            }

            .ui-tabs-nav li.ui-state-disabled {
                opacity: 1 !important;     /* Removes the dimmed appearance */
                pointer-events: none;      /* Ensures the tab remains unclickable */
                color: inherit;            /* Maintains original text color */
            }
        </style>
        <h:panelGrid styleClass="my-content-panel">

            <p:tabView id="tabId" widgetVar="tabWidget" activeIndex="#{workflowBean.activeIndex}">

                <p:tab id="personal" title="Upload" disabled="true">
                    <h:form id="form" enctype="multipart/form-data" >

                        <h3>
                            Prepare your data
                        </h3>
                        <ul>
                            <li>
                                <p:outputLabel id="formatIcon" style="font-size:13px; font-weight: bold; text-decoration: underline;" value="Data">
                                </p:outputLabel>
                                file in .csv or .txt.  
                            </li>
                            <li>                                
                                <p:outputLabel id="formatIcon2" style="font-size:13px; font-weight: bold; text-decoration: underline;" value="Metadata">
                                </p:outputLabel> file (optional), named as metadata.csv or metadata.txt. 
                            </li>
                        </ul>
                        <h:panelGrid columns="2" style="margin-top: 10px;  margin-left: 30px">
                            <h:panelGrid columns="2" style="padding: 30px 60px 30px 60px;  width: 720px; margin-right: 60px;" cellpadding="5">
                                <h:panelGroup layout="block" style="width:120px">
                                    <p:outputLabel style="font-size:12px; font-weight: bold" value="Data Type:"/>
                                </h:panelGroup>
                                <p:selectOneRadio value="#{wfUploadBean.dataType}">
                                    <f:selectItems value="#{optBean.tableTypeOpts}" />
                                </p:selectOneRadio>   

                                <p:outputLabel style="font-size:12px; font-weight: bold" value="Data Format:"/>
                                <p:selectOneMenu styleClass="menu" panelStyleClass="panel" style="width:165px" value="#{wfUploadBean.dataFormat}">
                                    <f:selectItem itemValue="colmf" itemLabel="Samples in columns"/>    
                                    <f:selectItem itemValue="rowmf" itemLabel="Samples in rows"/>                    
                                </p:selectOneMenu>

                                <h:panelGroup layout="block" style="min-width:180px; padding-right: 60px;">
                                    <p:outputLabel  style="font-size:13px; font-weight: bold" value="File Upload">
                                    </p:outputLabel>
                                </h:panelGroup>
                                <p:fileUpload mode="advanced" listener="#{wfUploadBean.handleFileUploadWorkflow}" 
                                              multiple="true"  style="line-height: 18px;"/>

                                <p:spacer style="margin-top: -10px"/>
                            </h:panelGrid>

                            <p:commandButton value="Submit" 
                                             style="width:110px; font-size: 14px !important" 
                                             update=":tabId:form"
                                             id="procBn"
                                             icon="pi pi-upload"
                                             onclick="PF('statusDialog').show(); localStorage.clear();"
                                             oncomplete="PF('statusDialog').hide()"
                                             actionListener="#{wfUploadBean.processFiles()}"/>

                        </h:panelGrid>
                        <h:panelGrid style="width: 880px; padding-top: 30px; padding-left: 30px">
                            <p:outputLabel id="uploadInfo" escape="false"
                                           style="font-size: 16px !important; color: darksalmon"
                                           value="#{wfUploadBean.uploadInfo}"/>
                        </h:panelGrid>

                        <p:tooltip for="formatIcon" styleClass="helpTip">
                            <p>
                                Upload your data as a tab-delimited text file (.txt).
                                The maximum allowed file size is 200MB. The sample names must be in the 
                                first line, followed by the metadata labels. Each metadata
                                starts with a new line beginning with "#CLASS:". A small example data 
                                with two metadata is shown below:
                                <pre>
#NAME           Sample1	Sample2	Sample3	Sample4	Sample5	Sample6	Sample7	Sample8 Sample9
#CLASS:Type	IDC	AC	IDC	DC	DC	IDC	AC	DC      DC
#CLASS:Survive	Y   	N	N	Y	N	Y	Y	N       N
100_g_at        -3.06	-2.25	-1.15	-6.64	0.4	1.08	1.22	1.02    1.15
1000_at         -1.36	-0.67	-0.17	-0.97	-2.32	-5.06	0.28	1.32    0.73
1002_f_at       1.61	-0.27	0.71	-0.62	0.14		0.11	0.98    0.54
1008_f_at       0.93	1.29	-0.23	-0.74	-2	-1.25	1.07	1.27    1.02
                                </pre>
                            </p>
                        </p:tooltip>
                        <p:tooltip for="formatIcon2" styleClass="helpTip">
                            <p>
                                Upload your sample data information as a tab-delimited text file (.txt) or comma-seperated values (.csv) format.
                                The sample names must be in the first column with "#NAME" as header, followed by the sample variable names from 2nd column onwards. 
                                Sample names must be same in both files. A small example data is shown below:
                                <pre>
 #NAME       SampleType   Survive
 Sample1     IDC          Y
 Sample2     AC           N
 Sample3     IDC          N                                                                                    
 Sample4     DC           Y                                 
 Sample5     DC           N
 Sample6     IDC          Y
 Sample7     AC           Y
 Sample8     DC           N
                                </pre>
                            </p>
                        </p:tooltip>
                    </h:form>

                </p:tab>
                <p:tab id="datacheck" title="Integrity Check" disabled="true">
                    <h:form id="formCheck">

                        <h2>Data Integrity Check:</h2>
                        <ul>
                            <li>
                                Checking sample names - spaces will replaced with underscore, and special characters will be removed;
                            </li>
                            <li>
                                Checking the class labels - at least three replicates are required in each class.
                            </li>
                            <li>
                                The data (except class labels) must not contain non-numeric values.
                            </li>
                            <li>
                                If the samples are paired, the pair labels must conform to the specified format.
                            </li>
                            <li>
                                The presence of missing values or features with constant values (i.e. all zeros).                
                            </li>
                        </ul>

                        <h:panelGrid columns="2">
                            <h:panelGrid style="padding-right: 20px">
                                <h:panelGrid style="margin-left: 20px; border: solid gray thin; padding: 20px; width: 780px" class="surface-card surface-border shadow-1 p-4 text-800">
                                    <h:outputLabel value="#{procBean.msgText}" escape="false"/>
                                </h:panelGrid>
                                <h:panelGrid id="btnPane" columns="5" style="width: 780px; text-align: center; padding-left: 60px; padding-top: 20px; padding-right: 40px">        
                                    <p:commandButton value="View Data"  style="width:140px;" 
                                                     icon="pi pi-external-link"
                                                     onclick="PF('viewDataDialog').show()"/>

                                    <p:commandButton value="Edit Groups" style="width:120px;" 
                                                     onclick="PF('smplGrpDialog').show()"
                                                     disabled="#{procBean.editBnDisabled}"
                                                     update="smplGrpForm"
                                                     />
                                    <p:commandButton value="Missing Values" ajax="false" style="width:150px;" 
                                                     onclick="PF('statusDialog').show()"
                                                     disabled="#{procBean.missingDisabled}"
                                                     action="#{procBean.imputeButton_action()}"/>
                                </h:panelGrid> 
                            </h:panelGrid>
                            <p:commandButton styleClass="btnCirc ui-button-help"
                                             rendered="false"
                                             action = "WorkflowView"
                                             style="margin-left: 80px; font-weight: bold; font-size: 15px"
                                             value="Workflow"/>

                        </h:panelGrid>

                        <p:dialog widgetVar="viewDataDialog" header="Data View" dynamic="true" modal="true" appendTo="@(body)" height="460"
                                  width="800px" hideEffect="explode" resizable="true">
                            <p>
                                Your uploaded (raw) data are shown below for manual inspection. It represents the computer's view of your data. 
                                The first column is the row number. For large data, a max of 10 columns and 100 rows will be displayed. 
                                <ul>
                                    <li>
                                        If this is in tabular format, make sure that you correctly specify samples in rows or samples in columns 
                                    </li>
                                    <li>
                                        If this is in tabular format, make sure that the group labels are correctly entered with unique sample IDs and unique feature IDs
                                    </li>
                                    <li>
                                        If this is <b>NOT</b> in tabular format, please spend some time to 
                                        understand how to save your data to CSV (UTF-8) file. For instance, 
                                        <a href="https://www.ablebits.com/office-addins-blog/convert-excel-csv/" target="_blank">this link may be helpful</a>. 
                                    </li>
                                </ul>
                            </p>
                            <iframe id="iframeId" frameborder="0" width="100%" height="600" src="#{facesContext.externalContext.requestContextPath}/Secure/viewer/_data_viewer.html"></iframe>

                        </p:dialog>
                    </h:form>
                </p:tab>
                <p:tab id="select" title="Workflow" disabled="true">
                    <h4>
                        Please select your workflow. 
                    </h4>
                    <p>
                        You can try our default workflow or load a previously saved workflow. Note that you can click on "Description" column to view and edit detailed descriptions.
                    </p>
                    <h:panelGrid columns="2">
                        <p>
                            Current workflow:
                        </p>
                        <h:outputText value="#{workflowBean.currentWorkflow}" />
                    </h:panelGrid>

                    <h:form id="form2">
                        <p:dataTable id="workflowTable" 
                                     var="workflow" 
                                     value="#{workflowBean.workflowList}" 
                                     rowsPerPageTemplate="10"
                                     rowKey="#{workflow['id']}"
                                     editable="true">
                            <p:column headerText="Selection" style="text-align:center;">  
                                <p:selectOneRadio value="#{workflowBean.selectedWorkflow}" converter="mapConverter">
                                    <f:selectItem itemValue="#{workflow}" />
                                    <p:ajax update=":tabId:form2" listener="#{workflowBean.loadWorkflow}" 
                                            onstart="PF('statusDialog').show();" 
                                            oncomplete="PF('statusDialog').hide();" />
                                </p:selectOneRadio>
                            </p:column>

                            <p:column headerText="Name" style="text-align:center;">
                                <h:outputText value="#{workflow['name']}" />
                            </p:column>

                            <p:column headerText="Description" style="text-align:center; width: 50%;">
                                <p:commandLink value="#{workflow['description']}" 
                                               oncomplete="PF('descriptionDialog').show();"
                                               update="::dialogForm">
                                    <f:setPropertyActionListener value="#{workflow}" 
                                                                 target="#{workflowBean.selectedWorkflow}" />
                                </p:commandLink>
                            </p:column>

                            <p:column headerText="Module" style="text-align:center;">
                                <h:outputText value="#{workflow['module']}" />
                            </p:column>


                            <p:column headerText="Delete" style="text-align:center;"> 
                                <p:commandLink value="" id="delActBn" onstart="PF('statusDialog').show()" oncomplete="PF('statusDialog').hide();PF('workflowDelDialog').show();">
                                    <i class="pi pi-trash" style="font-size: 1.4rem; color: orangered"></i>
                                    <f:setPropertyActionListener value="#{workflow}" target="#{workflowBean.selectedWorkflow}" />
                                </p:commandLink>
                            </p:column>
                        </p:dataTable>
                    </h:form>
                </p:tab>

            </p:tabView>


        </h:panelGrid>
        <p:dialog widgetVar="smplGrpDialog" 
                  header="Edit Group"
                  dynamic="true" modal="true" appendTo="@(body)" height="460"
                  hideEffect="explode" resizable="true">
            <h:form id="smplGrpForm">
                <h:panelGrid id="smplGrpView" style="padding:10px; font-size: 12px; width:480px;">
                    <p:dataTable style="width:100%; font-size: 12px" var="smpl" 
                                 class="surface-card shadow-1 p-0 text-800"
                                 rowIndexVar="rowInx" value="#{sessionBean1.sampleBeans}">  
                        <p:column headerText="Sample ID">  
                            <h:outputText value="#{smpl.name}"/>  
                        </p:column>   
                        <p:column headerText="Group Label">  
                            <h:inputText value="#{smpl.group}"/>
                        </p:column>   
                    </p:dataTable>
                    <h:panelGrid columns="2" style="width:100%; font-size: 14px; text-align: center">
                        <p:commandButton value="Update" 
                                         actionListener="#{procBean.updateSmplGroup()}" 
                                         update=":tabId:formCheck"
                                         onclick="PF('smplGrpDialog').hide()"/>
                        <p:commandButton value="Cancel" onclick="PF('smplGrpDialog').hide()"/>
                    </h:panelGrid> 
                </h:panelGrid>
            </h:form>         
        </p:dialog>
    </ui:define>
    <ui:define name="myfooter">
        <h:form id="southform">
            <!-- Button set for "Upload" tab -->
            <p:outputPanel rendered="#{workflowBean.activeIndex == 0}">
                <h:panelGrid columns="2" style="width:100%; text-align: center; border-top: orange 2px groove; padding-top: 6px; padding-bottom: 4px">
                    <p:commandButton value="Try Examples"
                                     id="testBn" style="width:160px"
                                     icon="pi pi-star"            
                                     onclick="PF('testDataDialog').show();"
                                     />

                    <p:commandButton id="visBnUpload" value="Proceed" style="width:160px"
                                     icon="pi pi-angle-double-right" 
                                     disabled="#{not wfUploadBean.fileUploaded}"
                                     actionListener="#{workflowBean.setActiveIndex(1)}"
                                     update="southform tabId:form tabId:formCheck"
                                     oncomplete="PF('tabWidget').select(1);"/>
                </h:panelGrid>
            </p:outputPanel>

            <p:outputPanel rendered="#{workflowBean.activeIndex == 1}">
                <h:panelGrid columns="3" style="width:100%; text-align: center; border-top: orange 2px groove; padding-top: 6px; padding-bottom: 4px">
                    <p:commandButton value="Back" style="width:160px"
                                     icon="pi pi-angle-double-left"
                                     update="southform tabId"
                                     actionListener="#{workflowBean.setActiveIndex(0)}"
                                     oncomplete="PF('tabWidget').select(0);"/>
                    <p:commandButton id="visBnCheck" value="Proceed" style="width:160px"
                                     icon="pi pi-angle-double-right" 
                                     update="southform tabId"
                                     actionListener="#{workflowBean.setActiveIndex(2)}"
                                     oncomplete="PF('tabWidget').select(2);"/>
                </h:panelGrid>
            </p:outputPanel>
            <p:outputPanel rendered="#{workflowBean.activeIndex == 2}">
                <h:panelGrid columns="3" style="width:100%; text-align: center; border-top: orange 2px groove; padding-top: 6px; padding-bottom: 4px">
                    <p:commandButton value="Back" style="width:160px"
                                     icon="pi pi-angle-double-left"
                                     update="southform"
                                     actionListener="#{workflowBean.setActiveIndex(1)}"
                                     oncomplete="PF('tabWidget').select(1);"/>
                    <p:commandButton value="Finish"
                                     id="runAnalysisBn" style="width:160px"
                                     icon="pi pi-cog"       
                                     action="#{workflowBean.finishPreparation()}"
                                     update="southform tabId:form2"
                                     />
                </h:panelGrid>
            </p:outputPanel>
            <!--
            <p:outputPanel rendered="#{workflowBean.activeIndex == 3}">
                <h:panelGrid columns="3" style="width:100%; text-align: center; border-top: orange 2px groove; padding-top: 6px; padding-bottom: 4px">
                    <p:commandButton value="Back" style="width:160px"
                                     icon="pi pi-angle-double-left"
                                     update="southform tabId:form2"
                                     actionListener="#{workflowBean.setActiveIndex(2)}"
                                     oncomplete="PF('tabWidget').select(2);"/>
                    <p:commandButton value="Finish"
                                     id="selectionFinish" style="width:160px"
                                     icon="pi pi-cog"          
                                     action="WorkflowView"/>

                </h:panelGrid>
            </p:outputPanel>
            -->
        </h:form>
        <h:panelGroup rendered="#{sessionBean1.naviType eq 'mf'}">
            <ui:include src="../example_sel/_mf.xhtml" />
        </h:panelGroup>
        <h:panelGroup rendered="#{sessionBean1.naviType eq 'stat'}">
            <ui:include src="../example_sel/_stat.xhtml" />
        </h:panelGroup>
        <h:panelGroup rendered="#{sessionBean1.naviType eq 'roc'}">
            <ui:include src="../example_sel/_roc.xhtml" />
        </h:panelGroup>
        <h:panelGroup rendered="#{sessionBean1.naviType eq 'dose'}">
            <ui:include src="../example_sel/_dose.xhtml" />
        </h:panelGroup>

    </ui:define>
</ui:composition>
