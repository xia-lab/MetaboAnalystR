<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:c="jakarta.tags.core">


    <p:dialog header="Files in Dataset" widgetVar="filesDialog" modal="true" appendTo="@(body)" resizable="true" width="720">
        <h:form id="filesForm">
            <p:dataTable value="#{datasetController.selected.getFiles()}" var="f" rows="10">
                <p:column headerText="Name">
                    <h:outputText value="#{f.filename}"/>
                </p:column>
                <p:column headerText="Role" style="width:10rem; text-align:center;">
                    <h:outputText value="#{f.role}"/>
                </p:column>
                <p:column headerText="Type" style="width:8rem; text-align:center;">
                    <h:outputText value="#{f.type}"/>
                </p:column>
                <p:column headerText="Size" style="width:8rem; text-align:right;">
                    <h:outputText value="#{f.humanSize}"/>
                </p:column>
                <p:column headerText="Actions" style="width:8rem; text-align:center;">
                    <p:commandLink title="Download" ajax="false" onclick="PrimeFaces.monitorDownload(start, stop);">
                        <i class="pi pi-download"></i>
                        <f:setPropertyActionListener value="#{f}" target="#{datasetController.selectedFile}"/>
                        <p:fileDownload value="#{datasetController.downloadSelectedFile}"/>
                    </p:commandLink>
                </p:column>
            </p:dataTable>
            <div style="text-align:right; margin-top:8px;">
                <p:commandButton value="Close" onclick="PF('filesDialog').hide();return false;"/>
            </div>
        </h:form>
    </p:dialog>
    <p:dialog header="Upload Help" widgetVar="uploadHelp" modal="true" appendTo="@(body)">
        <h:panelGrid style="width:520px; line-height:1.5; font-size: 14px;">
            <ul>
                <li>Supported formats: CSV, TSV, TXT, or a ZIP containing one of these.</li>
                <li>Recommended: first row = header (feature names); first column = unique IDs or sample names.</li>
                <li>Max size per file: 100 MB. Up to 20 files per batch.</li>
                <li>Use the <b>CSV Template</b> button to download a starter file with the expected columns.</li>
            </ul>
        </h:panelGrid>
    </p:dialog>

    <p:dialog header="Edit Dataset Info" widgetVar="editDialog" dynamic="true" modal="true" appendTo="@(body)" hideEffect="fade" resizable="true">
        <h:form id="editForm">
            <h:panelGrid styleClass="surface-card shadow-1 p-4 text-800" style="width:460px;">
                <p:outputLabel for="edTitle" value="Title" style="font-weight:bold"/>
                <p:inputText id="edTitle" value="#{datasetController.selected.title}" style="width:100%"/>

                <p:outputLabel for="edDesc" value="Description" style="font-weight:bold; margin-top:8px;"/>
                <p:inputTextarea id="edDesc" value="#{datasetController.selected.description}" rows="6" autoResize="true" style="width:100%"/>

                <p:outputLabel for="edTags" value="Tags (comma-separated)" style="font-weight:bold; margin-top:8px;"/>
                <p:chips id="edTags" value="#{datasetController.selected.tags}"/>
            </h:panelGrid>
            <h:panelGrid columns="2" style="width:100%; text-align:center; margin-top:8px;">
                <p:commandButton value="Cancel" onclick="PF('editDialog').hide();return false;"/>
                <p:commandButton value="Update" styleClass="ui-button-success" onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();PF('editDialog').hide();" update=":msgs :dataTableForm" actionListener="#{datasetController.updateDatasetInfo}"/>
            </h:panelGrid>
        </h:form>
    </p:dialog>

    <p:dialog widgetVar="delDialog" modal="true" header="Delete Dataset" appendTo="@(body)" closable="true">
        <h:form id="delForm">
            <h:panelGrid style="width:420px; line-height:1.6; font-size:14px;">
                <h:panelGrid columns="2" style="width:100%;" cellspacing="10">
                    <h:panelGroup>
                        <i class="pi pi-exclamation-triangle" style="font-size:42px;color:#f57c00"></i>
                    </h:panelGroup>
                    <h:panelGroup>
                        This action will permanently delete <b>#{datasetController.selected.title}</b>.
                        Proceed?
                    </h:panelGroup>
                </h:panelGrid>
                <h:panelGrid columns="2" style="width:100%; text-align:center;">
                    <p:commandButton value="Cancel" onclick="PF('delDialog').hide();return false;"/>
                    <p:commandButton value="Yes, delete" styleClass="ui-button-danger" onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();PF('delDialog').hide();" ajax="false" actionListener="#{datasetController.deleteSelected}"/>
                </h:panelGrid>
            </h:panelGrid>
        </h:form>
    </p:dialog>

    <p:dialog header="View / Edit File"
              widgetVar="editorDlg"
              modal="true" resizable="true" width="920" appendTo="@(body)"
              dynamic="true" focus="none">


        <h:form id="editorForm">
            <p:tabView id="editorTabs">
                <!-- ========== DATA TAB (READ ONLY) ========== -->
                <p:tab title="Data">
                    <pe:sheet id="dataSheet"
                              widgetVar="dataSheetW"
                              value="#{datasetController.dataSheetRows}" var="r"
                              rowKey="#{r.id}"
                              height="420"
                              minCols="#{datasetController.dataCols.size()}"
                              showRowHeaders="true"
                              readOnly="true"> <!-- everything read-only -->
                        <c:forEach items="#{datasetController.dataCols}" var="col" varStatus="s">
                            <pe:sheetcolumn headerText="#{col}"
                                            value="#{r.cells[s.index]}"
                                            readOnly="true"/>
                        </c:forEach>
                    </pe:sheet>
                </p:tab>


                <!-- ========== METADATA TAB (EDITABLE, first col locked) ========== -->
                <p:tab title="Metadata" rendered="#{datasetController.hasMetadataTab}">
                    <h:panelGroup>
                        <!-- Editable headers (except first col) -->
                        <h:panelGrid columns="#{datasetController.metaCols.size()}" style="margin-bottom:8px; width:100%;">
                            <ui:repeat value="#{datasetController.metaCols}" var="mh" varStatus="ms">
                                <p:inputText value="#{datasetController.metaCols[ms.index]}"
                                             style="width:100%"
                                             disabled="#{ms.index == 0}"> <!-- lock first col header -->
                                    <p:ajax event="blur"
                                            listener="#{datasetController.applyMetaHeaderEdits}"
                                            update="editorForm:metaSheet :msgs"/>
                                </p:inputText>
                            </ui:repeat>
                        </h:panelGrid>

                        <pe:sheet id="metaSheet"
                                  widgetVar="metaSheetW"
                                  value="#{datasetController.metaSheetRows}" var="mr"
                                  rowKey="#{mr.id}"
                                  height="420"
                                  minCols="#{datasetController.metaCols.size()}"
                                  showRowHeaders="true"
                                  readOnly="false"> <!-- allow edits -->
                            <p:ajax event="change"
                                    listener="#{datasetController.onSheetChangeMeta}"
                                    update=":msgs"/>
                            <c:forEach items="#{datasetController.metaCols}" var="mcol" varStatus="ms">
                                <pe:sheetcolumn headerText="#{mcol}"
                                                value="#{mr.cells[ms.index]}"
                                                readOnly="#{ms.index == 0}"/> <!-- lock first col -->
                            </c:forEach>
                        </pe:sheet>
                    </h:panelGroup>
                </p:tab>

                <p:tab title="Study design" rendered="#{datasetController.hasMetadataTab}">
                    <h:panelGroup style="padding: 18px 20px 10px 30px; width:720px; line-height:1.7;">
                        <p style="font-size:12px;">
                            The stored study design feeds into workflows. Choose a primary metadata factor and any covariates you want to lock for this dataset.
                            Leave them blank to keep the systemâ€™s automatic selections.
                        </p>
                    </h:panelGroup>
                    <h:panelGrid columns="2" cellpadding="3" style="padding: 0 20px 20px 30px; width:720px; line-height:2;">
                        <h:panelGroup layout="block" style="width:180px">
                            <h:outputLabel style="font-weight: bold" value="Primary metadata factor"/>
                        </h:panelGroup>
                        <p:selectOneMenu value="#{datasetController.studyDesignPrimary}" styleClass="menu" panelStyleClass="panel" style="max-width:360px;">
                            <f:selectItem itemValue="#{null}" itemLabel="Auto-detect from metadata"/>
                            <f:selectItems var="col" value="#{datasetController.studyDesignMetaOptions}" itemLabel="#{col}" itemValue="#{col}"/>
                        </p:selectOneMenu>

                        <h:panelGroup layout="block" style="width:180px">
                            <h:outputLabel style="font-weight: bold" value="Covariates"/>
                        </h:panelGroup>
                        <p:selectCheckboxMenu value="#{datasetController.studyDesignCovariates}" styleClass="menu" panelStyleClass="panel" multiple="true" label="&nbsp;-- None selected --&nbsp;" style="max-width:360px;">
                            <f:selectItems var="col" value="#{datasetController.studyDesignMetaOptions}" itemLabel="#{col}" itemValue="#{col}"/>
                        </p:selectCheckboxMenu>
                    </h:panelGrid>
                </p:tab>

            </p:tabView>

            <h:panelGrid columns="2" style="width:100%; text-align:center; margin-top:8px;">
                <p:commandButton value="Save"
                                 actionListener="#{datasetController.saveEditedFile}"
                                 update="@form :msgs"
                                 onstart="PF('statusDialog').show();"
                                 oncomplete="PF('statusDialog').hide(); PF('editorDlg').hide();"
                                 disabled="#{!datasetController.canSave}"
                                 title="#{datasetController.hasMetadataTab ? 'Save metadata changes' : 'No metadata available to save'}"/>
                <p:commandButton value="Close" onclick="PF('editorDlg').hide();return false;"/>
            </h:panelGrid>
        </h:form>
    </p:dialog>

</ui:composition>
