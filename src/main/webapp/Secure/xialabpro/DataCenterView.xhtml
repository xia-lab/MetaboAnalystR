<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pe="http://primefaces.org/ui/extensions"
                template="/template/_template_workflow.xhtml"
                xmlns:c="jakarta.tags.core">


    <ui:define name="metaInfo">
        <f:event type="preRenderView" listener="#{sessionBean1.addNaviTrack('Datasets', '/Secure/xialabpro/DataCenterView.xhtml')}"/>
        <f:event type="preRenderView" listener="#{datasetController.refresh}"/>
    </ui:define>

    <ui:define name="mystyle">
        <h:outputStylesheet library="css" name="dataset-cards.css"/>
        <script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/resources/jscripts/xialabpro/datacenter.js"></script> 

        <script type="text/javascript">
            // Optional helpers for downloads (used by exporter/template buttons)
            function start() {
                PF('statusDialog').show();
            }
            function stop() {
                PF('statusDialog').hide();
            }
        </script>
    </ui:define>

    <ui:define name="content">
        <h:panelGrid styleClass="my-content-panel">
            <p:growl id="msgs" showDetail="true" life="3500"/>

            <h2>Data Management</h2>
            <p>
                Your saved dataset files appear in the table below, where you can use them to start new analysis or workflow. To add a new dataset you need to run upload your data normally and check "Dataset" option under save when saving your project.
            </p>
            

            <p:tabView widgetVar="tabWidget" id="acTab" style="margin: 20px; width:90%; border: none; font-size: 13px; line-height: 23px; min-height: 70vh" >

                <p:tab title="Datasets">
                    <h:form id="dataTableForm">
                        <h:panelGroup id="cardsGrid" layout="block" styleClass="cards-grid">
                            <ui:repeat value="#{datasetController.datasetTableAll}" var="ds">
                                <p:fieldset legend="#{ds.title}" styleClass="ds-card surface-card shadow-1 p-3">

                                    <!-- Header row: show only for Examples -->
                                    <div class="flex align-items-center justify-content-between mb-2">
                                        <span class="text-700 text-sm">
                                            <h:panelGroup rendered="#{ds.origin eq 'Example'}">
                                                From Example Library
                                            </h:panelGroup>
                                        </span>
                                        <h:panelGroup rendered="#{ds.origin eq 'Example'}">
                                            <p:tag value="Example" severity="info"/>
                                        </h:panelGroup>
                                    </div>

                                    <!-- Description (clickable for user datasets i.e., no origin) -->
                                    <div style="margin-bottom:.25rem;">
                                        <h:panelGroup rendered="#{ds.origin eq 'Custom'}">
                                            <p:commandLink value="#{ds.description}" styleClass="title-link"
                                                           update=":editForm"
                                                           oncomplete="PF('editDialog').show();">
                                                <f:setPropertyActionListener value="#{ds}" target="#{datasetController.selected}"/>
                                            </p:commandLink>
                                        </h:panelGroup>
                                        <h:panelGroup rendered="#{ds.origin eq 'Custom'}">
                                            <h:outputText value="#{ds.description}"/>
                                        </h:panelGroup>
                                    </div>

                                    <div class="ds-meta">
                                        <h:panelGroup rendered="#{ds.origin eq 'Custom'}">
                                            <div><b>ID:</b> #{ds.id}</div>
                                        </h:panelGroup>

                                        <div><b>File:</b> #{ds.filename}</div>
                                        <div><b>Size:</b> #{ds.humanSize}</div>
                                        <div><b>Files:</b> #{ds.fileCountAdjusted}</div>
                                        <div><b>Samples:</b> #{ds.samplenum == 0 ? 'NA' : ds.samplenum}</div>
                                        <h:panelGroup rendered="#{not empty ds.uploadedAtStr}">
                                            <div><b>Uploaded:</b> #{ds.uploadedAtStr}</div>
                                        </h:panelGroup>
                                    </div>

                                    <p:toolbar styleClass="dataset-toolbar">
                                        <f:facet name="left">
                                            <!-- Delete only for user datasets -->
                                            <p:commandLink id="deleteBn" title="Delete"
                                                           rendered="#{ds.origin eq 'Custom'}"
                                                           update=":delForm"
                                                           oncomplete="PF('delDialog').show();">
                                                <i class="pi pi-trash" style="color:orangered;"></i>
                                                <f:setPropertyActionListener value="#{ds}" target="#{datasetController.selected}"/>
                                            </p:commandLink>

                                            <p:commandLink id="editBn" title="Explore"
                                                           update=":editorForm :dataTableForm"
                                                           onstart="PF('statusDialog').show();"
                                                           oncomplete="PF('editorDlg').show();PF('statusDialog').hide();"
                                                           actionListener="#{datasetController.loadForEditor(ds, 'metadata')}">
                                                <i class="pi pi-compass"/>
                                            </p:commandLink>

                                            <p:commandLink id="filesBn"
                                                           title="Files"
                                                           process="@this"
                                                           update=":filesForm"
                                                           onstart="PF('statusDialog').show();"
                                                           oncomplete="PF('filesDialog').show();PF('statusDialog').hide();"
                                                           action="#{datasetController.populateFilesForDialog(ds)}">
                                                <i class="pi pi-folder-open"></i>
                                            </p:commandLink>
                                        </f:facet>

                                        <f:facet name="right">
                                            <p:commandLink id="loadBn" title="Load"
                                                           onstart="PF('statusDialog').show();"
                                                           oncomplete="PF('statusDialog').hide();"
                                                           update=":acTab:dataTableForm"
                                                           action="#{datasetController.loadDefault(ds)}">
                                                <i class="pi pi-caret-right" style="color:#16a34a;"></i>
                                            </p:commandLink>

                                            <p:commandLink id="loadWorkflowBn" title="Load workflow"
                                                           onstart="PF('statusDialog').show();"
                                                           oncomplete="PF('statusDialog').hide();"
                                                           update=":acTab:dataTableForm"
                                                           action="#{datasetController.loadWorkflow(ds, true)}">
                                                <i class="pi pi-sitemap" style="color:#16a34a;"></i>
                                            </p:commandLink>
                                        </f:facet>
                                    </p:toolbar>

                                    <!-- Tooltips -->
                                    <p:tooltip for="deleteBn" value="Delete this dataset" rendered="#{ds.origin eq 'Custom'}"/>
                                    <p:tooltip for="editBn" value="View / edit file"/>
                                    <p:tooltip for="filesBn" value="Show all files in this dataset"/>
                                    <p:tooltip for="loadBn" value="Load this dataset"/>
                                    <p:tooltip for="loadWorkflowBn" value="Load this dataset and select a workflow"/>
                                </p:fieldset>
                            </ui:repeat>
                        </h:panelGroup>
                    </h:form>
                </p:tab>


                <p:tab title ="Data Upload" rendered="false">
                    <h:form id="uploadform" enctype="multipart/form-data">

                        <div style="padding: 20px; line-height: 23px; width:90%;">
                            <p:remoteCommand name="validateFiles" actionListener="#{uploadBean.checkIntegrity}"/>

                            <p>
                                <b>Drag-and-drop</b> your data below (maximum 200MB per file). 
                            </p>

                            <p:fileUpload listener="#{uploadBean.handleFileUploadMulti}"
                                          sequential="true"
                                          update=":acTab:uploadform"
                                          auto="false" 
                                          label="Choose" 
                                          mode="advanced" 
                                          style="width:75%; margin: 20px; line-height: 18px"
                                          multiple="true" 
                                          oncomplete="handleMultiFileUploadRequest(PF('importFile'), validateFiles);"
                                          widgetVar="importFile">
                                <p:validateFile sizeLimit="#{applicationBean1.FILE_SIZE_BYTE}"
                                                fileLimit="10"           
                                                allowTypes="/(\.|\/)(csv|txt|zip)$/"/>
                            </p:fileUpload>

                        </div>
                        <div style="text-align: center; width:75%;">
                            <p:commandButton value="Done!" onclick="PF('uploadDialog').hide()"/>
                        </div>
                    </h:form>
                </p:tab>
            </p:tabView>


        </h:panelGrid>
        <ui:include src="/Secure/xialabpro/_DataDialogs.xhtml" />



    </ui:define>
</ui:composition>
