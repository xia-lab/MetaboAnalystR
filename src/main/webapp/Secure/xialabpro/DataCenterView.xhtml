<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/template/_template_workflow.xhtml">


    <ui:define name="metaInfo">
        <f:event type="preRenderView" listener="#{sessionBean1.addNaviTrack('Data Manager', '/Secure/xialabpro/DataCenterView.xhtml')}"/>
        <f:event type="preRenderView" listener="#{datasetController.refresh}"/>
    </ui:define>

    <ui:define name="mystyle">
        <style>
            .warnHighlight {
                color: #d32f2f !important;
            }
            .my-content-panel {
                width: 100%;
            }
            .button-panel {
                width: 100%;
                padding: 2px;
                font-size: 13px;
                text-align:center;
            }
            .col-label  {
                width: 140px;
                text-align: right;
                padding-right: 10px;
                vertical-align: middle;
            }
            .col-input  {
                width: 520px;
                vertical-align: middle;
            }
            .col-action {
                text-align: left;
                vertical-align: middle;
            }
            .narrow-column {
                width: 40px;
                text-align: center;
            }
            .wide-column   {
                text-align: left;
            }
            .soft-note {
                color:#546e7a;
                font-size: 0.95rem;
            }
            .icon-btn {
                font-size: 1.3rem;
            }
            .cards-grid {
                display: grid;
                grid-template-columns: repeat(4, minmax(0, 1fr));
                gap: 1rem;
            }
            @media (max-width: 1400px){
                .cards-grid{
                    grid-template-columns: repeat(3, 1fr);
                }
            }
            @media (max-width: 1000px){
                .cards-grid{
                    grid-template-columns: repeat(2, 1fr);
                }
            }
            @media (max-width: 700px) {
                .cards-grid{
                    grid-template-columns: 1fr;
                }
            }

            .ds-card .ds-meta {
                font-size: .9rem;
                color: #607d8b;
            }
            .badge {
                display:inline-block;
                padding:2px 6px;
                font-size:.75rem;
                border-radius:4px;
                background:#e0e0e0;
            }
            .badge-info {
                background:#b3e5fc;
            }
            .card-actions i {
                font-size:1.3rem;
                vertical-align:middle;
            }
            .card-actions .spacer{
                display:inline-block;
                width:16px;
            }
        </style>
        <script type="text/javascript">
            // Optional helpers for downloads (used by exporter/template buttons)
            function start() {
                PF('statusDialog').show();
            }
            function stop() {
                PF('statusDialog').hide();
            }
        </script>
    </ui:define>

    <ui:define name="content">
        <h:panelGrid styleClass="my-content-panel">
            <p:growl id="msgs" showDetail="true" life="6000"/>

            <h2>Data Management</h2>
            <p>
                Upload one or more datasets (CSV/TSV/TXT or ZIP). Your uploaded files appear in the table below, where you can
                download, edit metadata, or delete them.
            </p>

            <ui:include src="/template/_dataset_overlaypanel.xhtml" />
            <h:form id="dataTableForm">
                <!--
                <p:toolbar>
                    <p:toolbarGroup align="right">
                        <p:commandButton value="Refresh" icon="pi pi-refresh" update=":dataTableForm:dsTable :msgs" actionListener="#{datasetController.refresh}"/>
                        <p:spacer width="8"/>
                        <p:commandButton value="Delete Selected" icon="pi pi-trash" styleClass="ui-button-danger"
                                         onclick="PF('bulkDelDialog').show();return false;"
                                         disabled="#{empty datasetController.selectedDatasets}"/>
                        <p:spacer width="8"/>
                        <p:commandButton type="button" value="Export CSV" icon="pi pi-file"
                                         onclick="PrimeFaces.monitorDownload(start, stop);" styleClass="ui-button-outlined">
                            <p:dataExporter type="csv" target=":dataTableForm:dsTable" fileName="datasets"/>
                        </p:commandButton>
                    </p:toolbarGroup>
                </p:toolbar>
                -->

                <h:panelGroup id="cardsGrid" layout="block" styleClass="cards-grid">
                    <ui:repeat value="#{datasetController.datasetTable}" var="ds">
                        <p:fieldset legend="#{ds.title}" styleClass="ds-card surface-card shadow-1 p-3">

                            <!-- title link to edit -->
                            <div style="margin-bottom:.25rem;">
                                <p:commandLink value="#{ds.description}" styleClass="title-link"
                                               update=":editForm"
                                               oncomplete="PF('editDialog').show();">
                                    <f:setPropertyActionListener value="#{ds}" target="#{datasetController.selected}"/>
                                </p:commandLink>
                            </div>

                            <div class="ds-meta">
                                <div><b>File:</b> #{ds.filename}</div>
                                <div><b>Size:</b> #{ds.humanSize}</div>
                                <div>
                                    <b>Files:</b> #{ds.fileCountAdjusted}
                                    <h:panelGroup rendered="#{ds.hasMetadata}">
                                        <span class="badge badge-info" style="margin-left:6px;">meta</span>
                                    </h:panelGroup>
                                </div>
                                <div><b>Samples:</b> #{ds.samplenum}</div>
                                <div><b>Uploaded:</b> #{ds.uploadedAtStr}</div>
                            </div>

                            <div class="card-actions" style="margin-top:.75rem; display:flex; align-items:center;">
                                <p:commandLink id="downloadBn" title="Download" ajax="false" onclick="PrimeFaces.monitorDownload(start, stop);">
                                    <i class="pi pi-download"></i>
                                    <f:setPropertyActionListener value="#{ds}" target="#{datasetController.selected}"/>
                                    <p:fileDownload value="#{datasetController.downloadSelected}"/>
                                    <p:tooltip for="downloadBn" value="Download primary file"/>
                                </p:commandLink>

                                <span class="spacer"/>

                                <p:commandLink id="filesBn" title="Files" update=":filesForm" oncomplete="PF('filesDialog').show();">
                                    <i class="pi pi-folder-open"></i>
                                    <f:setPropertyActionListener value="#{ds}" target="#{datasetController.selected}"/>
                                    <p:tooltip for="filesBn" value="Show all files in this dataset"/>
                                </p:commandLink>

                                <span class="spacer"/>

                                <p:commandLink id="loadBn" title="Load"
                                               onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();"
                                               update=":dataTableForm"
                                               action="#{datasetController.load(ds)}">
                                    <i class="pi pi-caret-right" style="color:#16a34a;"></i>
                                    <p:tooltip for="loadBn" value="Load this dataset"/>
                                </p:commandLink>

                                <span class="spacer"/>

                                <p:commandLink id="deleteBn" title="Delete" update=":delForm" oncomplete="PF('delDialog').show();">
                                    <i class="pi pi-trash" style="color:orangered;"></i>
                                    <f:setPropertyActionListener value="#{ds}" target="#{datasetController.selected}"/>
                                    <p:tooltip for="deleteBn" value="Delete this dataset"/>
                                </p:commandLink>
                            </div>
                        </p:fieldset>
                    </ui:repeat>
                </h:panelGroup>
            </h:form>

        </h:panelGrid>
        <p:dialog header="Files in Dataset" widgetVar="filesDialog" modal="true" appendTo="@(body)" resizable="true" width="720">
            <h:form id="filesForm">
                <p:dataTable value="#{datasetController.getFiles(datasetController.selected.id)}" var="f" rows="10">
                    <p:column headerText="Name">
                        <h:outputText value="#{f.filename}"/>
                    </p:column>
                    <p:column headerText="Role" style="width:10rem; text-align:center;">
                        <h:outputText value="#{f.role}"/>
                    </p:column>
                    <p:column headerText="Type" style="width:8rem; text-align:center;">
                        <h:outputText value="#{f.type}"/>
                    </p:column>
                    <p:column headerText="Size" style="width:8rem; text-align:right;">
                        <h:outputText value="#{f.humanSize}"/>
                    </p:column>
                    <p:column headerText="Actions" style="width:8rem; text-align:center;">
                        <p:commandLink title="Download" ajax="false" onclick="PrimeFaces.monitorDownload(start, stop);">
                            <i class="pi pi-download"></i>
                            <f:setPropertyActionListener value="#{f}" target="#{datasetController.selectedFile}"/>
                            <p:fileDownload value="#{datasetController.downloadSelectedFile}"/>
                        </p:commandLink>
                    </p:column>
                </p:dataTable>
                <div style="text-align:right; margin-top:8px;">
                    <p:commandButton value="Close" onclick="PF('filesDialog').hide();return false;"/>
                </div>
            </h:form>
        </p:dialog>
        <p:dialog header="Upload Help" widgetVar="uploadHelp" modal="true" appendTo="@(body)">
            <h:panelGrid style="width:520px; line-height:1.5; font-size: 14px;">
                <ul>
                    <li>Supported formats: CSV, TSV, TXT, or a ZIP containing one of these.</li>
                    <li>Recommended: first row = header (feature names); first column = unique IDs or sample names.</li>
                    <li>Max size per file: 100 MB. Up to 20 files per batch.</li>
                    <li>Use the <b>CSV Template</b> button to download a starter file with the expected columns.</li>
                </ul>
            </h:panelGrid>
        </p:dialog>

        <p:dialog header="Edit Dataset Info" widgetVar="editDialog" dynamic="true" modal="true" appendTo="@(body)" hideEffect="fade" resizable="true">
            <h:form id="editForm">
                <h:panelGrid styleClass="surface-card shadow-1 p-4 text-800" style="width:460px;">
                    <p:outputLabel for="edTitle" value="Title" style="font-weight:bold"/>
                    <p:inputText id="edTitle" value="#{datasetController.selected.title}" style="width:100%"/>

                    <p:outputLabel for="edDesc" value="Description" style="font-weight:bold; margin-top:8px;"/>
                    <p:inputTextarea id="edDesc" value="#{datasetController.selected.description}" rows="6" autoResize="true" style="width:100%"/>

                    <p:outputLabel for="edTags" value="Tags (comma-separated)" style="font-weight:bold; margin-top:8px;"/>
                    <p:chips id="edTags" value="#{datasetController.selected.tags}"/>
                </h:panelGrid>
                <h:panelGrid columns="2" style="width:100%; text-align:center; margin-top:8px;">
                    <p:commandButton value="Cancel" onclick="PF('editDialog').hide();return false;"/>
                    <p:commandButton value="Update" styleClass="ui-button-success" onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();PF('editDialog').hide();" update=":msgs :dataTableForm:dsTable" actionListener="#{datasetController.updateDatasetInfo}"/>
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog widgetVar="delDialog" modal="true" header="Delete Dataset" appendTo="@(body)" closable="true">
            <h:form id="delForm">
                <h:panelGrid style="width:420px; line-height:1.6; font-size:14px;">
                    <h:panelGrid columns="2" style="width:100%;" cellspacing="10">
                        <h:panelGroup>
                            <i class="pi pi-exclamation-triangle" style="font-size:42px;color:#f57c00"></i>
                        </h:panelGroup>
                        <h:panelGroup>
                            This action will permanently delete <b>#{datasetController.selected.title}</b>.
                            Proceed?
                        </h:panelGroup>
                    </h:panelGrid>
                    <h:panelGrid columns="2" style="width:100%; text-align:center;">
                        <p:commandButton value="Cancel" onclick="PF('delDialog').hide();return false;"/>
                        <p:commandButton value="Yes, delete" styleClass="ui-button-danger" onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();PF('delDialog').hide();" update=":msgs :dataTableForm:dsTable" actionListener="#{datasetController.deleteSelected}"/>
                    </h:panelGrid>
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog widgetVar="bulkDelDialog" modal="true" header="Delete Selected Datasets" appendTo="@(body)">
            <h:form>
                <h:panelGrid style="width:460px; line-height:1.6; font-size:14px;">
                    <p>
                        You are about to delete <b>#{datasetController.selectedDatasets.size()}</b> items. This cannot be undone. Continue?
                    </p>
                    <h:panelGrid columns="2" style="width:100%; text-align:center;">
                        <p:commandButton value="Cancel" onclick="PF('bulkDelDialog').hide();return false;"/>
                        <p:commandButton value="Delete" styleClass="ui-button-danger" onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();PF('bulkDelDialog').hide();" update=":msgs :dataTableForm:dsTable" actionListener="#{datasetController.deleteBatch}"/>
                    </h:panelGrid>
                </h:panelGrid>
            </h:form>
        </p:dialog>


    </ui:define>
</ui:composition>
