<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pe="http://primefaces.org/ui/extensions"
                template="/template/_template_workflow.xhtml"
                xmlns:c="jakarta.tags.core">


    <ui:define name="metaInfo">
        <f:event type="preRenderView" listener="#{sessionBean1.addNaviTrack('Data Manager', '/Secure/xialabpro/DataCenterView.xhtml')}"/>
        <f:event type="preRenderView" listener="#{datasetController.refresh}"/>
    </ui:define>

    <ui:define name="mystyle">
        <h:outputStylesheet library="css" name="dataset-cards.css"/>
        <script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/resources/jscripts/xialabpro/datacenter.js"></script> 

        <script type="text/javascript">
            // Optional helpers for downloads (used by exporter/template buttons)
            function start() {
                PF('statusDialog').show();
            }
            function stop() {
                PF('statusDialog').hide();
            }
        </script>
    </ui:define>

    <ui:define name="content">
        <h:panelGrid styleClass="my-content-panel">
            <p:growl id="msgs" showDetail="true" life="6000"/>

            <h2>Data Management</h2>
            <p>
                Your saved dataset files appear in the table below, where you can use them to start new analysis or workflow.
            </p>
            <!--
            <ui:include src="/template/_dataset_overlaypanel.xhtml" />
            -->
            <p:tabView widgetVar="tabWidget" id="acTab" style="margin: 20px; width:90%; border: none; font-size: 13px; line-height: 23px; min-height: 70vh" >
                
                <p:tab title ="Example Dataset">
                    <h:form id="dataTableExampleForm">

                        <h:panelGroup id="cardsGrid" layout="block" styleClass="cards-grid">
                            <ui:repeat value="#{datasetController.datasetTableExample}" var="ds">
                                <p:fieldset legend="#{ds.title}" styleClass="ds-card surface-card shadow-1 p-3">
                                        
                                    <div style="margin-bottom:.25rem;">
                                        <h:outputText value="#{ds.description}"/>
                                    </div>

                                    <div class="ds-meta">
                                        <div><b>File:</b> #{ds.filename}</div>
                                        <div><b>Size:</b> #{ds.humanSize}</div>
                                        <div>
                                            <b>Files:</b> #{ds.fileCountAdjusted}
                                        </div>
                                        <div><b>Samples:</b> #{ds.samplenum == 0 ? 'NA' : ds.samplenum}</div>
                                    </div>

                                    <p:toolbar styleClass="dataset-toolbar">
                                        <f:facet name="left">
                                            <p:commandLink id="editBn" title="Explore"
                                                           update=":editorForm :dataTableForm"
                                                           onstart="PF('statusDialog').show();"
                                                           oncomplete="PF('editorDlg').show();PF('statusDialog').hide();"
                                                           actionListener="#{datasetController.loadForEditor(ds, 'metadata')}">
                                                <i class="pi pi-compass"/>
                                            </p:commandLink>


                                            <p:commandLink id="filesBn" 
                                                           title="Files"
                                                           process="@this"
                                                           update=":filesForm"
                                                           onstart="PF('statusDialog').show();"
                                                           oncomplete="PF('filesDialog').show();PF('statusDialog').hide();"
                                                           action="#{datasetController.populateFilesForDialog(ds)}">
                                                <i class="pi pi-folder -open"></i>
                                            </p:commandLink>

                                        </f:facet>

                                        <f:facet name="right">
                                            <p:commandLink id="loadBn" title="Load"
                                                           onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();"
                                                           update=":acTab:dataTableForm"
                                                           action="#{datasetController.loadDefault(ds)}">
                                                <i class="pi pi-caret-right" style="color:#16a34a;"></i>
                                            </p:commandLink>
                                            <p:commandLink id="loadWorkflowBn" title="Load"
                                                           onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();"
                                                           update=":acTab:dataTableForm"
                                                           action="#{datasetController.loadWorkflow(ds)}">
                                                <i class="pi pi-sitemap" style="color:#16a34a;"></i>
                                            </p:commandLink>
                                        </f:facet>
                                    </p:toolbar>

                                    <!-- Tooltips -->
                                    <p:tooltip for="editBn" value="View / edit file"/>

                                    <p:tooltip for="filesBn" value="Show all files in this dataset"/>
                                    <p:tooltip for="loadBn" value="Load this dataset"/>
                                    <p:tooltip for="loadWorkflowBn" value="Load this dataset and select a workflow"/>

                                </p:fieldset>
                            </ui:repeat>
                        </h:panelGroup>
                    </h:form>

                </p:tab>
                <p:tab title ="User Dataset">
                    <h:form id="dataTableForm">

                        <h:panelGroup id="cardsGrid" layout="block" styleClass="cards-grid">
                            <ui:repeat value="#{datasetController.datasetTable}" var="ds">
                                <p:fieldset legend="#{ds.title}" styleClass="ds-card surface-card shadow-1 p-3">

                                    <!-- title link to edit -->
                                    <div style="margin-bottom:.25rem;">
                                        <p:commandLink value="#{ds.description}" styleClass="title-link"
                                                       update=":editForm"
                                                       oncomplete="PF('editDialog').show();">
                                            <f:setPropertyActionListener value="#{ds}" target="#{datasetController.selected}"/>
                                        </p:commandLink>
                                    </div>

                                    <div class="ds-meta">
                                        <h:panelGroup rendered="#{applicationBean1.onZgyPc}">
                                            <div><b>ID:</b> #{ds.id}</div>
                                        </h:panelGroup>


                                        <div><b>File:</b> #{ds.filename}</div>
                                        <div><b>Size:</b> #{ds.humanSize}</div>
                                        <div>
                                            <b>Files:</b> #{ds.fileCountAdjusted}
                                        </div>
                                        <div><b>Samples:</b> #{ds.samplenum == 0 ? 'NA' : ds.samplenum}</div>
                                        <div><b>Uploaded:</b> #{ds.uploadedAtStr}</div>
                                    </div>

                                    <p:toolbar styleClass="dataset-toolbar">
                                        <f:facet name="left">
                                            <p:commandLink id="deleteBn" title="Delete" update=":delForm" oncomplete="PF('delDialog').show();">
                                                <i class="pi pi-trash" style="color:orangered;"></i>
                                                <f:setPropertyActionListener value="#{ds}" target="#{datasetController.selected}"/>
                                            </p:commandLink>
                                            <p:commandLink id="editBn" title="Explore"
                                                           update=":editorForm :dataTableForm"
                                                           onstart="PF('statusDialog').show();"
                                                           oncomplete="PF('editorDlg').show();PF('statusDialog').hide();"
                                                           actionListener="#{datasetController.loadForEditor(ds, 'metadata')}">
                                                <i class="pi pi-compass"/>
                                            </p:commandLink>
                                            <p:commandLink id="filesBn"
                                                           title="Files"
                                                           process="@this"
                                                           update=":filesForm"
                                                           oncomplete="PF('filesDialog').show();"
                                                           action="#{datasetController.populateFilesForDialog(ds)}">
                                                <i class="pi pi-folder-open"></i>
                                            </p:commandLink>
                                        </f:facet>

                                        <f:facet name="right">
                                            <p:commandLink id="loadBn" title="Load"
                                                           onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();"
                                                           update=":acTab:dataTableForm"
                                                           action="#{datasetController.loadDefault(ds)}">
                                                <i class="pi pi-caret-right" style="color:#16a34a;"></i>
                                            </p:commandLink>
                                            <p:commandLink id="loadWorkflowBn" title="Load"
                                                           onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();"
                                                           update=":acTab:dataTableForm"
                                                           action="#{datasetController.loadWorkflow(ds)}">
                                                <i class="pi pi-sitemap" style="color:#16a34a;"></i>
                                            </p:commandLink>

                                        </f:facet>
                                    </p:toolbar>

                                    <!-- Tooltips -->
                                    <p:tooltip for="filesBn" value="Show all files in this dataset"/>
                                    <p:tooltip for="loadBn" value="Load this dataset"/>
                                    <p:tooltip for="loadWorkflowBn" value="Load this dataset and select a workflow"/>

                                    <p:tooltip for="deleteBn" value="Delete this dataset"/>
                                </p:fieldset>
                            </ui:repeat>
                        </h:panelGroup>
                    </h:form>
                </p:tab>
                <p:tab title ="Data Upload" rendered="false">
                    <h:form id="uploadform" enctype="multipart/form-data">

                        <div style="padding: 20px; line-height: 23px; width:90%;">
                            <p:remoteCommand name="validateFiles" actionListener="#{uploadBean.checkIntegrity}"/>

                            <p>
                                <b>Drag-and-drop</b> your data below (maximum 200MB per file). 
                            </p>

                            <p:fileUpload listener="#{uploadBean.handleFileUploadMulti}"
                                          sequential="true"
                                          update=":acTab:uploadform"
                                          auto="false" 
                                          label="Choose" 
                                          mode="advanced" 
                                          style="width:75%; margin: 20px; line-height: 18px"
                                          multiple="true" 
                                          oncomplete="handleMultiFileUploadRequest(PF('importFile'), validateFiles);"
                                          widgetVar="importFile">
                                <p:validateFile sizeLimit="#{applicationBean1.FILE_SIZE_BYTE}"
                                                fileLimit="10"           
                                                allowTypes="/(\.|\/)(csv|txt|zip)$/"/>
                            </p:fileUpload>

                        </div>
                        <div style="text-align: center; width:75%;">
                            <p:commandButton value="Done!" onclick="PF('uploadDialog').hide()"/>
                        </div>
                    </h:form>
                </p:tab>
            </p:tabView>


        </h:panelGrid>
        <p:dialog header="Files in Dataset" widgetVar="filesDialog" modal="true" appendTo="@(body)" resizable="true" width="720">
            <h:form id="filesForm">
                <p:dataTable value="#{datasetController.selected.getFiles()}" var="f" rows="10">
                    <p:column headerText="Name">
                        <h:outputText value="#{f.filename}"/>
                    </p:column>
                    <p:column headerText="Role" style="width:10rem; text-align:center;">
                        <h:outputText value="#{f.role}"/>
                    </p:column>
                    <p:column headerText="Type" style="width:8rem; text-align:center;">
                        <h:outputText value="#{f.type}"/>
                    </p:column>
                    <p:column headerText="Size" style="width:8rem; text-align:right;">
                        <h:outputText value="#{f.humanSize}"/>
                    </p:column>
                    <p:column headerText="Actions" style="width:8rem; text-align:center;">
                        <p:commandLink title="Download" ajax="false" onclick="PrimeFaces.monitorDownload(start, stop);">
                            <i class="pi pi-download"></i>
                            <f:setPropertyActionListener value="#{f}" target="#{datasetController.selectedFile}"/>
                            <p:fileDownload value="#{datasetController.downloadSelectedFile}"/>
                        </p:commandLink>
                    </p:column>
                </p:dataTable>
                <div style="text-align:right; margin-top:8px;">
                    <p:commandButton value="Close" onclick="PF('filesDialog').hide();return false;"/>
                </div>
            </h:form>
        </p:dialog>
        <p:dialog header="Upload Help" widgetVar="uploadHelp" modal="true" appendTo="@(body)">
            <h:panelGrid style="width:520px; line-height:1.5; font-size: 14px;">
                <ul>
                    <li>Supported formats: CSV, TSV, TXT, or a ZIP containing one of these.</li>
                    <li>Recommended: first row = header (feature names); first column = unique IDs or sample names.</li>
                    <li>Max size per file: 100 MB. Up to 20 files per batch.</li>
                    <li>Use the <b>CSV Template</b> button to download a starter file with the expected columns.</li>
                </ul>
            </h:panelGrid>
        </p:dialog>

        <p:dialog header="Edit Dataset Info" widgetVar="editDialog" dynamic="true" modal="true" appendTo="@(body)" hideEffect="fade" resizable="true">
            <h:form id="editForm">
                <h:panelGrid styleClass="surface-card shadow-1 p-4 text-800" style="width:460px;">
                    <p:outputLabel for="edTitle" value="Title" style="font-weight:bold"/>
                    <p:inputText id="edTitle" value="#{datasetController.selected.title}" style="width:100%"/>

                    <p:outputLabel for="edDesc" value="Description" style="font-weight:bold; margin-top:8px;"/>
                    <p:inputTextarea id="edDesc" value="#{datasetController.selected.description}" rows="6" autoResize="true" style="width:100%"/>

                    <p:outputLabel for="edTags" value="Tags (comma-separated)" style="font-weight:bold; margin-top:8px;"/>
                    <p:chips id="edTags" value="#{datasetController.selected.tags}"/>
                </h:panelGrid>
                <h:panelGrid columns="2" style="width:100%; text-align:center; margin-top:8px;">
                    <p:commandButton value="Cancel" onclick="PF('editDialog').hide();return false;"/>
                    <p:commandButton value="Update" styleClass="ui-button-success" onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();PF('editDialog').hide();" update=":msgs :dataTableForm:dsTable" actionListener="#{datasetController.updateDatasetInfo}"/>
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog widgetVar="delDialog" modal="true" header="Delete Dataset" appendTo="@(body)" closable="true">
            <h:form id="delForm">
                <h:panelGrid style="width:420px; line-height:1.6; font-size:14px;">
                    <h:panelGrid columns="2" style="width:100%;" cellspacing="10">
                        <h:panelGroup>
                            <i class="pi pi-exclamation-triangle" style="font-size:42px;color:#f57c00"></i>
                        </h:panelGroup>
                        <h:panelGroup>
                            This action will permanently delete <b>#{datasetController.selected.title}</b>.
                            Proceed?
                        </h:panelGroup>
                    </h:panelGrid>
                    <h:panelGrid columns="2" style="width:100%; text-align:center;">
                        <p:commandButton value="Cancel" onclick="PF('delDialog').hide();return false;"/>
                        <p:commandButton value="Yes, delete" styleClass="ui-button-danger" onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();PF('delDialog').hide();" update=":msgs :dataTableForm:dsTable" actionListener="#{datasetController.deleteSelected}"/>
                    </h:panelGrid>
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog widgetVar="bulkDelDialog" modal="true" header="Delete Selected Datasets" appendTo="@(body)">
            <h:form>
                <h:panelGrid style="width:460px; line-height:1.6; font-size:14px;">
                    <p>
                        You are about to delete <b>#{datasetController.selectedDatasets.size()}</b> items. This cannot be undone. Continue?
                    </p>
                    <h:panelGrid columns="2" style="width:100%; text-align:center;">
                        <p:commandButton value="Cancel" onclick="PF('bulkDelDialog').hide();return false;"/>
                        <p:commandButton value="Delete" styleClass="ui-button-danger" onstart="PF('statusDialog').show();" oncomplete="PF('statusDialog').hide();PF('bulkDelDialog').hide();" update=":msgs :dataTableForm:dsTable" actionListener="#{datasetController.deleteBatch}"/>
                    </h:panelGrid>
                </h:panelGrid>
            </h:form>
        </p:dialog>
        <p:dialog header="View / Edit File"
                  widgetVar="editorDlg"
                  modal="true" resizable="true" width="920" appendTo="@(body)"
                  dynamic="true" focus="none">


            <h:form id="editorForm">
                <p:tabView id="editorTabs">
                    <!-- ========== DATA TAB (READ ONLY) ========== -->
                    <p:tab title="Data">
                        <pe:sheet id="dataSheet"
                                  widgetVar="dataSheetW"
                                  value="#{datasetController.dataSheetRows}" var="r"
                                  rowKey="#{r.id}"
                                  height="420"
                                  minCols="#{datasetController.dataCols.size()}"
                                  showRowHeaders="true"
                                  readOnly="true"> <!-- everything read-only -->
                            <c:forEach items="#{datasetController.dataCols}" var="col" varStatus="s">
                                <pe:sheetcolumn headerText="#{col}"
                                                value="#{r.cells[s.index]}"
                                                readOnly="true"/>
                            </c:forEach>
                        </pe:sheet>
                    </p:tab>


                    <!-- ========== METADATA TAB (EDITABLE, first col locked) ========== -->
                    <p:tab title="Metadata" rendered="#{datasetController.hasMetadataTab}">
                        <h:panelGroup>
                            <!-- Editable headers (except first col) -->
                            <h:panelGrid columns="#{datasetController.metaCols.size()}" style="margin-bottom:8px; width:100%;">
                                <ui:repeat value="#{datasetController.metaCols}" var="mh" varStatus="ms">
                                    <p:inputText value="#{datasetController.metaCols[ms.index]}"
                                                 style="width:100%"
                                                 disabled="#{ms.index == 0}"> <!-- lock first col header -->
                                        <p:ajax event="blur"
                                                listener="#{datasetController.applyMetaHeaderEdits}"
                                                update="editorForm:metaSheet :msgs"/>
                                    </p:inputText>
                                </ui:repeat>
                            </h:panelGrid>

                            <pe:sheet id="metaSheet"
                                      widgetVar="metaSheetW"
                                      value="#{datasetController.metaSheetRows}" var="mr"
                                      rowKey="#{mr.id}"
                                      height="420"
                                      minCols="#{datasetController.metaCols.size()}"
                                      showRowHeaders="true"
                                      readOnly="false"> <!-- allow edits -->
                                <p:ajax event="change"
                                        listener="#{datasetController.onSheetChangeMeta}"
                                        update=":msgs"/>
                                <c:forEach items="#{datasetController.metaCols}" var="mcol" varStatus="ms">
                                    <pe:sheetcolumn headerText="#{mcol}"
                                                    value="#{mr.cells[ms.index]}"
                                                    readOnly="#{ms.index == 0}"/> <!-- lock first col -->
                                </c:forEach>
                            </pe:sheet>
                        </h:panelGroup>
                    </p:tab>

                </p:tabView>

                <h:panelGrid columns="2" style="width:100%; text-align:center; margin-top:8px;">
                    <p:commandButton value="Save"
                                     actionListener="#{datasetController.saveEditedFile}"
                                     update="@form :msgs"
                                     onstart="PF('statusDialog').show();"
                                     oncomplete="PF('statusDialog').hide(); PF('editorDlg').hide();"
                                     disabled="#{!datasetController.canSave}"
                                     title="#{datasetController.hasMetadataTab ? 'Save metadata changes' : 'No metadata available to save'}"/>
                    <p:commandButton value="Close" onclick="PF('editorDlg').hide();return false;"/>
                </h:panelGrid>
            </h:form>
        </p:dialog>



    </ui:define>
</ui:composition>
