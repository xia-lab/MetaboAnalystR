<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/template/_template_workflow.xhtml">
    <ui:define name="metaInfo">
        <f:event type="preRenderView" listener="#{workflowBean.initUserProjects()}"></f:event> 
        <f:event type="preRenderView" listener="#{sessionBean1.addNaviTrack('Projects', '/Secure/xialabpro/ProjectView.xhtml')}"/> 
    </ui:define>
    <ui:define name="mystyle">    
        <style>
            .warnHighlight {
                color: red !important;
            }

            .button-panel {
                width: 100%;
                padding: 2px;
                font-size: 13px;
                text-align:center;
            }


            .button-panel p:commandButton {
                margin: 0 20px;  /* Adjust the margin as needed */
            }

            /* Narrow column */
            .narrow-column {
                width: 35px; /* Adjust width as needed */
                text-align: right;
            }

            /* Wide column */
            .wide-column {
                text-align: left;
            }

            /* Make all items appear “active” within this steps instance */
            #wfSteps .ui-steps-item .ui-menuitem-link {
                background: var(--primary-color, #3B82F6);
                border-color: var(--primary-color, #3B82F6);
                color: #fff;
            }
            #wfSteps .ui-steps-number {
                color:#fff;
            }
        </style>
    </ui:define>
    <ui:define name="myscript">
        <h:outputStylesheet library="css" name="dataset-cards.css"/>

        <link type="text/css" rel="stylesheet" href="#{facesContext.externalContext.requestContextPath}/resources/css/workflow.css" />

        <script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/resources/jscripts/xialabpro/workflow_diagram.js"></script> 
        <script type="text/javascript">
            window.onload = function () {

                try {
                    if (!window.__initUserProjectsDone) {
                        window.__initUserProjectsDone = true;
                        // call the remoteCommand defined below
                        if (typeof inituserprojects === 'function') {
                            //inituserprojects();
                        }
                    }
                } catch (e) {
                }

                PF("workflowProgressDialog").hide();
                localStorage.removeItem('pagesToVisit');

                var reportEndBool = localStorage.getItem('reportEndBool');
                //console.log(reportEndBool + "=====reportEndBool");
                if (reportEndBool) {
                    //PF("resDialog").show();
                    PF('growlWidget').show([{severity: "info", summary: "INFO", detail: "Execution Finished! Click 'Dashboard' button to view results."}]);

                    localStorage.removeItem('reportEndBool');
                }

                //<![CDATA[
                function getURLParameter(name) {
                    return decodeURIComponent(
                            (new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')
                            ) || null;
                }
                //]]>
                if (getURLParameter('callFunc') !== null) {
                    checkPagesToVisit([]);
                }

                /*
                 const POLL_MS = 10000;
                 const pollTimer = setInterval(() => {
                 try {
                 pingJob();
                 } catch (e) {
                 }
                 }, POLL_MS);
                 */
            };


        </script>

    </ui:define>
    <ui:define name="content">

        <h:form id="initForm">
            <!-- Remote command to replace preRenderView -->
            <p:remoteCommand name="inituserprojects"
                             process="@this"
                             update=":dataTableForm"
                             actionListener="#{workflowBean.initUserProjects}" />
        </h:form>
        <h:form id="formHidden1">

            <p:remoteCommand name="afterResetCmd"
                             process="@this"
                             update=""
                             actionListener="#{datasetController.afterResetInit}" />
            <h:inputHidden id="domainUrl" value="#{applicationBean1.domainURL}" />
            <h:inputHidden id="analType" value="#{sessionBean1.analType}" />
            <h:inputHidden id="dataType" value="#{sessionBean1.dataType}" />
            <h:inputHidden id="funcArr" value="#{workflowBean.calledWorkflows}" />
            <h:inputHidden id="funcArrErr" value="#{workflowBean.calledWorkflowsError}" />
            <h:inputHidden id="libOpt" value="#{pathBean.libOpt}" />
            <h:inputHidden id="netVisMode" value="#{sessionBean1.visMode}" />
            <h:inputHidden id="naviType" value="#{sessionBean1.naviType}" />
            <h:inputHidden id="loggedIn" value="#{sessionBean1.loggedIn}" />
            <!--  stop="#{jobExecution.stopStatusCheck}" -->

        </h:form>
        <h:form id="pollForm">
            <p:poll interval="15" listener="#{jobExecution.checkJobStatus}" update="pollForm :formWorkflowInfo formBell :designForm" widgetVar="pollWidget" />
        </h:form>
        <h:panelGrid styleClass="my-content-panel">


            <h:form id="dataTableForm">
                <p:growl id="msgs" showDetail="true" /> 
                <h2>
                    Workflow Project
                </h2>
                <p>
                    You can analyze your data using a workflow (batch processing). To do this, you need to 
                    create a workflow project. The basic steps:
                    <ol>
                        <li>
                            Define a <b>Project</b>: you can use <b>Add New</b>; or directly edit an existing projects (listed below)
                        </li>
                        <li>
                            Select a <b>Data</b> from the available datasets. You add data by uploading a data or saving data from your previous project to the <a href="./DataCenterView.xhtml">Data Center</a>;
                        </li>
                        <li>
                            Select a <b>Workflow</b> from the available and compatible workflows. You can add workflows by creating a workflow from the <a href="./WorkflowView.xhtml">Workflow Center</a>;
                        </li>
                        <li>
                            Click the icon in the <b>Start</b> column
                        </li>
                    </ol>
                </p>
                <p:steps styleClass="mb-3">
                    <p:menuitem id="stepDataset" value="Dataset" icon="pi pi-database"
                                title="Choose the input files and/or metadata."  styleClass="ui-state-highlight"/>
                    <p:menuitem id="stepWorkflow" value="Workflow" icon="pi pi-sitemap"
                                title="Pick a template and parameters to run." styleClass="ui-state-highlight"/>
                    <p:menuitem id="stepResult" value="Result" icon="pi pi-wallet"
                                title="View analysis results, figures, and downloadable outputs." styleClass="ui-state-highlight"/>
                </p:steps>

                <p:tooltip for="stepDataset" showEffect="fade" position="top" />
                <p:tooltip for="stepWorkflow" showEffect="fade" position="top" />
                <p:tooltip for="stepResult"  showEffect="fade" position="top" />

                <p:dataTable id="dtTable"
                             var="run"
                             value="#{workflowBean.workflowRunsTable}"
                             editable="true" editMode="cell"
                             paginator="true" rows="25" rowsPerPageTemplate="25,50,100"
                             paginatorPosition="bottom"
                             class="surface-card shadow-1 p-0 text-800"
                             sortBy="#{run.id}"
                             rowKey="#{run.id}"
                             rowStyleClass="#{workflowBean.isSelected(run) ? 'row-selected' : ''}">

                    <!-- fire once per edited cell -->
                    <p:ajax event="cellEdit"
                            listener="#{workflowBean.onRunCellEdit}" />

                    <f:facet name="header">
                        <div class="flex justify-content-between align-items-center w-full">
                            <span class="text-900 font-medium">Workflow Runs</span>

                            <p:commandButton id="btnAddRun"
                                             value="Add New"
                                             icon="pi pi-plus"
                                             styleClass="p-button-success p-button-raised p-button-sm"
                                             action="#{workflowBean.prepareNewRun}"
                                             process="@this"
                                             update=":dataTableForm :runEditDialogForm"
                                             onstart="PF('statusDialog').show();"
                                             oncomplete="PF('statusDialog').hide(); PF('runEditDialog').show();" />
                        </div>
                    </f:facet>

                    <p:column headerText="Run ID" style="text-align:center;" width="100px">
                        <p:commandLink value="#{run.id}"
                                       oncomplete="PF('runEditDialog').show();"
                                       update=":dataTableForm :runEditDialogForm">
                            <f:setPropertyActionListener value="#{run}" target="#{workflowBean.selectedWorkflowRun}" />
                        </p:commandLink>
                    </p:column>

                    <p:column headerText="Name" style="width:10%" sortBy="#{run.name}">
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{empty run.name ? run.workflowId : run.name}" />
                            </f:facet>
                            <f:facet name="input">
                                <p:inputText value="#{run.name}" style="width:95%"/>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>


                    <!-- Dataset column → open “By Dataset” dialog (works for placeholder rows too) -->
                    <p:column headerText="Dataset" width="14%">
                        <p:commandLink id="dsPick"
                                       value="#{run.datasetName eq 'NA' or empty run.datasetName ? '[Select Dataset]' : run.datasetName}"
                                       process="@this"
                                       update=":dataTableForm :formByDataset"
                                       actionListener="#{workflowBean.prepareDialogByDataset(run)}"
                                       onstart="PF('statusDialog').show();"
                                       oncomplete="PF('statusDialog').hide(); PF('dlgByDataset').show();">
                            <f:setPropertyActionListener value="#{run}" target="#{workflowBean.selectedWorkflowRun}" />
                        </p:commandLink>
                        <p:tooltip for="dsPick" value="Pick dataset, then choose a compatible workflow"/>
                    </p:column>

                    <!-- Workflow column → open “By Workflow” dialog (works for placeholder rows too) -->
                    <p:column headerText="Workflow" width="16%">
                        <p:commandLink id="wfPick"
                                       value="#{empty run.module or run.module eq 'NA' ? '[Select Workflow]' : workflowView.getReadableType(run.module)}"
                                       process="@this"
                                       update=":dataTableForm :formByWorkflow"
                                       actionListener="#{workflowBean.prepareDialogByWorkflow(run)}"
                                       onstart="PF('statusDialog').show();"
                                       oncomplete="PF('statusDialog').hide(); PF('dlgByWorkflow').show();">
                            <f:setPropertyActionListener value="#{run}" target="#{workflowBean.selectedWorkflowRun}" />
                        </p:commandLink>
                        <p:tooltip for="wfPick" value="Pick workflow, then choose a compatible dataset"/>
                    </p:column>


                    <p:column headerText="Status">
                        <!-- normalize to lowercase once and compare -->
                        <h:panelGroup rendered="#{run.status eq 'pending' or run.status eq 'Pending'}">
                            <span class="mr-4">
                                <i class="pi pi-hourglass text-orange-500" style="vertical-align:middle;"></i>
                                <span class="ml-1">Pending</span>
                            </span>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{run.status eq 'running' or run.status eq 'Running'}">
                            <span class="mr-4">
                                <i class="pi pi-spinner pi-spin text-blue-500" style="vertical-align:middle;"></i>
                                <span class="ml-1">Running</span>
                            </span>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{run.status eq 'completed' or run.status eq 'Completed'}">
                            <span class="mr-4">
                                <i class="pi pi-check-circle text-green-500" style="vertical-align:middle;"></i>
                                <span class="ml-1">Completed</span>
                            </span>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{run.status eq 'failed' or run.status eq 'Failed'}">
                            <span class="mr-4">
                                <i class="pi pi-times-circle text-red-500" style="vertical-align:middle;"></i>
                                <span class="ml-1">Failed</span>
                            </span>
                        </h:panelGroup>
                    </p:column>

                    <p:column headerText="Last Updated" sortBy="#{run.lastUpdated}" width="160px">
                        <h:outputText value="#{run.lastUpdated}" />
                    </p:column>

                    <p:column headerText="Start" style="text-align:center;">
                        <p:commandLink actionListener="#{workflowBean.startRun(run)}"
                                       onclick="PF('workStartDialog').hide();
                                               PF('statusDialog').show();"
                                       update=":dataTableForm"
                                       oncomplete="PF('statusDialog').hide();">
                            <i class="pi pi-arrow-circle-right" style="font-size:1.4rem; color: orangered"></i>
                        </p:commandLink>
                    </p:column>

                    <p:column headerText="View" style="text-align:center;" width="100px">
                        <p:commandLink id="viewBn"
                                       title="View results"
                                       disabled="#{empty run.projectId}"
                                       action="#{workflowBean.viewRunResults(run)}"
                                       update=":dataTableForm"
                                       onstart="PF('statusDialog').show();"
                                       oncomplete="PF('statusDialog').hide();">
                            <i class="pi pi-eye" style="font-size:1.4rem; color:#2563eb;"></i>
                            <f:setPropertyActionListener value="#{run}" target="#{workflowBean.selectedWorkflowRun}" />
                            <f:param name="projectId" value="#{run.projectId}" />
                        </p:commandLink>

                        <p:tooltip for="viewBn"
                                   value="#{empty run.projectId ? 'Results not available (no project yet)' : 'Open analysis results'}"/>
                    </p:column>

                    <p:column headerText="Delete" style="text-align:center;">
                        <p:commandLink id="delRunBn" onclick="PF('runDelDialog').show();">
                            <i class="pi pi-trash" style="font-size:1.4rem; color:orangered"></i>
                            <f:setPropertyActionListener value="#{run}" target="#{workflowBean.selectedWorkflowRun}" />
                        </p:commandLink>
                    </p:column>

                </p:dataTable>
            </h:form>
        </h:panelGrid>

        <p:dialog widgetVar="projectDelDialog" dynamic="true" modal="true" 
                  header="Delete Project"
                  appendTo="@(body)" onShow="PF('statusDialog').hide()"
                  hideEffect="fade" resizable="true"> 

            <h:form>
                <h:panelGrid  style="width:400px; line-height: 150%; padding: 10px; font-size: 14px">
                    <h:panelGrid columns="2" style="width:100%;" cellspacing="10">
                        <h:panelGroup>
                            <i class="pi pi-exclamation-circle" style="font-size:48px;color:red"></i>
                        </h:panelGroup>
                        <h:panelGroup>
                            Once deleted, a project cannot be recovered. Are you sure to delete this project?
                        </h:panelGroup>
                    </h:panelGrid>
                    <h:panelGrid columns="2" style="text-align: center; width:100%;">
                        <p:commandButton value="Cancel" id="okBn"
                                         onclick="PF('projectDelDialog').hide()"/>   
                        <p:commandButton value="Yes, delete" style="width:120px;"
                                         id="delBn"
                                         onclick="PF('statusDialog').show();"
                                         action="#{fireProjectBean.callProjectDelete()}"
                                         ajax="false"
                                         update=":projForm:checkboxDT"
                                         oncomplete ="PF('statusDialog').hide(); PF('projectDelDialog').hide()"
                                         />
                    </h:panelGrid>
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog header="Update Project Info" widgetVar="projectEditDialog" dynamic="true" modal="true" appendTo="@(body)" onShow="PF('statusDialog').hide()"
                  hideEffect="explode" resizable="true"> 
            <h:form id="editDialogForm"> 
                <h:panelGrid style="padding:10px; width:420px;"> 
                    <h:panelGrid style="width: 100%;" class="surface-card shadow-1 p-4 text-800">
                        <p:outputLabel for="title" value="Title" style="font-weight: bold;"/>
                        <p:inputText id="title" value="#{fireProjectBean.selectedProject.title}" style="width: 100%"/>

                        <p:outputLabel for="description" value="Description"  style="font-weight: bold;"/>
                        <p:inputTextarea id="description" value="#{fireProjectBean.selectedProject.description}" 
                                         rows="8" cols="48"/>

                    </h:panelGrid>

                    <h:panelGrid columns="2" style="width:100%; text-align: center">
                        <p:commandButton value="Cancel" id="okBn"
                                         onclick="PF('volcanoDialog').hide()"/>   
                        <p:commandButton id="facBn" value="Update" style="width:80px" ajax="false"
                                         onclick="PF('statusDialog').show();"
                                         action="#{fireProjectBean.updateProjectInfo}"
                                         styleClass="procBn"
                                         /> 
                    </h:panelGrid>
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog header="You are about to log off!"
                  widgetVar="logoutProjDialog"
                  showEffect="fade"
                  hideEffect="fade"
                  modal="true"
                  width="580"
                  height="180"
                  closable="true"
                  draggable="false"
                  resizable="false"
                  appendTo="@(body)">
            <h:form>
                <h:panelGrid  style="width:500px; line-height: 150%; padding: 2px; font-size: 13px">
                    <p>
                        <span icon="pi pi-info-circle" style="float:left; margin:0 7px 50px 0;"></span>
                        <div>You are about to log off. Your current progress will be save automatically! If you want to modify any settings, welcome back!</div>
                    </p>
                    <p>Please choose one of the following options:</p>
                </h:panelGrid>
                <p:commandButton style="width:160px; font-size: 13px; margin-left: 20%; margin-right: 0px" value="Save and log off"
                                 onclick="PF('logoutProjDialog').hide();PF('statusDialog').show();"
                                 action="#{projCtrl.saveProject()}"
                                 oncomplete ="PF('statusDialog').hide();"/>

                <p:commandButton style="width:160px; font-size: 13px; margin-left: 20px" value="Keep staying here"
                                 onclick="PF('logoutProjDialog').hide()"/>
            </h:form>
        </p:dialog>

        <p:dialog header="Start Workflow based on selected project" widgetVar="workflowDialog" dynamic="true" modal="true" appendTo="@(body)" onShow="PF('statusDialog').hide()"
                  hideEffect="explode" resizable="true"> 
            <h:form id="workflowForm"> 
                <h:panelGrid style="padding-left:20px; width:350px; height:120px;"> 
                    <h:panelGrid columns="1" style="width: 360px">
                        <p>
                            You are about to start an automated workflow based on the template of selected project: #{fireProjectBean.selectedProject.id}
                        </p>
                        <p>
                            You can choose to use parameters from your project or default ones.
                        </p>
                    </h:panelGrid>
                    <h:panelGrid columns="2" style="padding-left:20px; width:350px;">
                        <h:panelGroup layout="block">
                            <h:outputLabel style="font-weight: bold" value="Parameters:"/> <br/>
                        </h:panelGroup>
                        <p:selectOneRadio layout="pageDirection" value="#{workflowBean.reloadingParameters}">
                            <f:selectItem itemLabel="Saved" itemValue="saved" /> 
                            <f:selectItem itemLabel="Default" itemValue="default" /> 
                        </p:selectOneRadio>
                    </h:panelGrid>

                    <h:panelGrid columns="2" style="padding-left:20px; width:350px;">
                        <p:commandButton value="Cancel" 
                                         onclick="PF('workflowDialog').hide()"/>   
                        <p:commandButton value="Confirm" style="width:80px" ajax="false"
                                         onclick="PF('statusDialog').show();"
                                         action="#{diagramView.initWorkflowBasedOnProject}"
                                         styleClass="procBn"
                                         /> 
                    </h:panelGrid>
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog modal="true" widgetVar="workStartDialog" 
                  style="width: 400px; " 
                  dynamic="true"
                  header="Start a workflow run:" 
                  appendTo="@(body)" 
                  draggable="false" closable="true" resizable="false"> 
            <h:form id="formWorkDoc">
                <h:panelGrid  style="width:100%; line-height: 25px; padding: 10px 20px 20px 20px; font-size: 13px"  class="surface-card shadow-0 p-3 text-600"> 
                    <h:panelGrid columns="2" style="width:100%">
                        <h:outputLabel value="Title"/>
                        <p:inputText id="float-input" style="width:100%" value="#{fireBaseController.fireDocName}"/>
                        <h:outputLabel value="Description"/>
                        <p:inputTextarea rows="10" cols="36" value="#{fireBaseController.fireDocDescription}"/>
                    </h:panelGrid>
                    <h:panelGrid style=" text-align: center; padding-top:10px;width:100%">
                        <p:commandButton value="Save"
                                         actionListener="#{workflowBean.startRun()}"
                                         onclick="PF('workStartDialog').hide();
                                                 PF('statusDialog').show();"
                                         update=":dataTableForm"
                                         oncomplete="PF('statusDialog').hide();"
                                         />
                    </h:panelGrid>
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog header="Edit Workflow Run" widgetVar="runEditDialog" dynamic="true" modal="true"
                  appendTo="@(body)" resizable="true" onShow="PF('statusDialog').hide()">
            <h:form id="runEditDialogForm">
                <ui:fragment rendered="#{not empty workflowBean.selectedWorkflowRun}">
                    <h:panelGrid style="padding:10px; width:420px;">
                        <h:panelGrid style="width: 100%;" class="surface-card shadow-1 p-4 text-800">
                            <h:panelGrid columns="2" style="width:100%; margin-bottom:1rem;" columnClasses="wide-column wide-column">
                                <h:outputText styleClass="text-700" value="Run ID"/>
                                <h:outputText value="#{workflowBean.selectedWorkflowRun.id}" />
                                <h:outputText styleClass="text-700" value="Workflow"/>
                                <h:outputText value="#{empty workflowBean.selectedWorkflowRun.module or workflowBean.selectedWorkflowRun.module eq 'NA' ? '[Not selected]' : workflowView.getReadableType(workflowBean.selectedWorkflowRun.module)}" />
                                <h:outputText styleClass="text-700" value="Dataset"/>
                                <h:outputText value="#{empty workflowBean.selectedWorkflowRun.datasetName or workflowBean.selectedWorkflowRun.datasetName eq 'NA' ? '[Not selected]' : workflowBean.selectedWorkflowRun.datasetName}" />
                            </h:panelGrid>

                            <p:outputLabel for="runName" value="Name" style="font-weight: bold;"/>
                            <p:inputText id="runName" value="#{workflowBean.selectedWorkflowRun.name}" style="width: 100%"/>

                            <p:outputLabel for="runDescription" value="Description"  style="font-weight: bold;"/>
                            <p:inputTextarea id="runDescription" value="#{workflowBean.selectedWorkflowRun.description}"
                                             rows="5" cols="48"/>

                        </h:panelGrid>

                        <h:panelGrid columns="2" style="width:100%; text-align: center">
                            <p:commandButton value="Cancel" type="button"
                                             onclick="PF('runEditDialog').hide()"/>
                            <p:commandButton id="runEditBn" value="Update" style="width:80px"
                                             process="@form"
                                             update=":dataTableForm :msgs"
                                             action="#{workflowBean.updateRunInfo}"
                                             onstart="PF('statusDialog').show();"
                                             oncomplete="PF('statusDialog').hide(); if (args &amp;&amp; args.runUpdateSuccess) { PF('runEditDialog').hide(); }"
                                             styleClass="procBn"/>
                        </h:panelGrid>
                    </h:panelGrid>
                </ui:fragment>
            </h:form>
        </p:dialog>

        <p:dialog id="dlgByDataset" widgetVar="dlgByDataset" header="Select Dataset"
                  modal="true" responsive="true" closable="true" resizable="false" width="900">
            <h:form id="formByDataset">
                <div class="flex gap-2 mb-2">
                    <p:inputText id="dsFilter" value="#{workflowBean.dsFilter}" placeholder="Filter datasets…" />
                    <p:commandButton value="Apply" process="@this dsFilter" update="dsTable"/>
                </div>

                <p:dataTable id="dsTable"
                             value="#{datasetController.datasetTableAll}" var="ds"
                             paginator="true" rows="10" rowsPerPageTemplate="10,20,50"
                             emptyMessage="No datasets found." styleClass="surface-card shadow-1">
                    <p:column headerText="Name" sortBy="#{ds.title}" width="35%">
                        <p:outputPanel layout="flex"
                                       style="align-items:center; justify-content:space-between; width:100%; border:0; padding:0;">
                            <h:outputText value="#{ds.title}" style="flex:1 1 auto;"/>

                            <p:tag value="Example"
                                   severity="info"
                                   rendered="#{ds.origin eq 'Example'}"
                                   style="margin-left:auto;"/>
                        </p:outputPanel>
                    </p:column>

                    <p:column headerText="File" sortBy="#{ds.filename}">
                        <h:outputText value="#{ds.filename}"/>
                    </p:column>
                    <p:column headerText="Samples" width="10%" sortBy="#{ds.samplenum}">
                        <h:outputText value="#{ds.samplenum == 0 ? 'NA' : ds.samplenum}"/>
                    </p:column>
                    <p:column headerText="Action" width="120" style="text-align:center;">
                        <div class="flex justify-content-center align-items-center gap-4">

                            <p:commandLink id="deleteBn" title="Delete"
                                           disabled="#{ds.origin ne 'Custom'}"
                                           update=":delForm"
                                           oncomplete="PF('delDialog').show();">
                                <i class="pi pi-trash" style="color:orangered;"></i>
                                <f:setPropertyActionListener value="#{ds}" target="#{datasetController.selected}"/>
                            </p:commandLink>

                            <p:commandLink id="editBn" title="Explore"
                                           update=":editorForm :dataTableForm"
                                           onstart="PF('statusDialog').show();"
                                           oncomplete="PF('editorDlg').show();PF('statusDialog').hide();"
                                           actionListener="#{datasetController.loadForEditor(ds, 'metadata')}">
                                <i class="pi pi-compass"/>
                            </p:commandLink>

                            <p:commandLink id="filesBn"
                                           title="Files"
                                           process="@this"
                                           update=":filesForm"
                                           onstart="PF('statusDialog').show();"
                                           oncomplete="PF('filesDialog').show();PF('statusDialog').hide();"
                                           action="#{datasetController.populateFilesForDialog(ds)}">
                                <i class="pi pi-folder-open"></i>
                            </p:commandLink>
                            <p:commandLink title="Select" styleClass="p-button-sm p-button-primary"
                                           actionListener="#{workflowBean.selectDatasetOnly(ds)}"
                                           update=":dataTableForm"
                                           onstart="PF('statusDialog').show();"
                                           oncomplete="PF('statusDialog').hide(); PF('dlgByDataset').hide();">
                                <i class="pi pi-play" style="font-size:1.1rem"></i>

                            </p:commandLink>
                        </div>
                    </p:column>
                </p:dataTable>
            </h:form>
        </p:dialog>
        <p:dialog id="dlgByWorkflow" widgetVar="dlgByWorkflow" header="Select Workflow"
                  modal="true" responsive="true" closable="true" resizable="false" width="900">
            <h:form id="formByWorkflow">
                <div class="flex gap-2 mb-2">
                    <p:inputText id="wfFilter" value="#{workflowBean.wfFilter}" placeholder="Filter workflows…" />
                    <p:commandButton value="Apply" process="@this wfFilter" update="wfTable"/>
                </div>

                <p:dataTable id="wfTable"
                             value="#{workflowBean.workflowList}" var="wf"
                             paginator="true" rows="10" rowsPerPageTemplate="10,20,50"
                             emptyMessage="No workflows found." styleClass="surface-card shadow-1">

                    <p:column headerText="Name" sortBy="#{wf['name']}" width="35%">
                        <p:outputPanel layout="flex"
                                       style="align-items:center; justify-content:space-between; width:100%; border:0;">
                            <h:outputText value="#{empty wf['name'] ? '[Untitled Workflow]' : wf['name']}" />
                            <p:tag value="Template"
                                   severity="info"
                                   rendered="#{wf['type'] eq 'Template'}"
                                   style="margin-left:auto;" />
                        </p:outputPanel>
                    </p:column>

                    <p:column headerText="Module" width="35%" sortBy="#{wf['module']}">
                        <h:outputText value="#{workflowView.getReadableType(wf['module'])}"/>
                    </p:column>

                    <p:column headerText="Action" width="120" style="text-align:center;">
                        <div class="flex justify-content-center align-items-center gap-4">
                            <p:commandLink id="viewWfJson"
                                           title="View workflow JSON"
                                           disabled="#{wf['type'] ne 'Custom'}"
                                           process="@this"
                                           actionListener="#{workflowBean.prepareViewWorkflowJson(wf)}"
                                           update=":wfJsonDlgForm"
                                           onstart="PF('statusDialog').show();"
                                           oncomplete="PF('statusDialog').hide(); PF('wfJsonDlg').show();">
                                <i class="pi pi-folder-open"></i>
                                <f:setPropertyActionListener value="#{wf}" target="#{workflowBean.selectedWorkflow}" />
                            </p:commandLink>
                            <p:tooltip for="viewWfJson" value="View JSON" position="top" />

                            <p:commandLink id="viewWf"
                                           title="View and update parameters"
                                           ajax="false"
                                           onclick="PF('statusDialog').show();"
                                           action="#{workflowBean.goToWorkflowDetails}">
                                <i class="pi pi-cog" style="font-size:1.1rem"></i>
                                <f:setPropertyActionListener value="#{wf}" target="#{workflowBean.selectedWorkflow}" />
                            </p:commandLink>
                            <p:tooltip for="viewWf" value="Open workflow details" position="top" />

                            <p:commandLink id="runWf"
                                           title="Use this workflow"
                                           process="@this"
                                           actionListener="#{workflowBean.selectWorkflowOnly(wf)}"
                                           update=":dataTableForm"
                                           onstart="PF('statusDialog').show();"
                                           oncomplete="PF('statusDialog').hide(); PF('dlgByWorkflow').hide();">
                                <i class="pi pi-play" style="font-size:1.1rem"></i>
                            </p:commandLink>
                            <p:tooltip for="runWf" value="Select this workflow" position="top" />
                            <p:tooltip for="runWf" value="Select this workflow" position="top" />
                        </div>
                    </p:column>
                </p:dataTable>
            </h:form>
        </p:dialog>

        <ui:include src="/Secure/xialabpro/_WorkflowDialogs.xhtml" />
        <ui:include src="/Secure/xialabpro/_DataDialogs.xhtml" />


    </ui:define>
</ui:composition>
