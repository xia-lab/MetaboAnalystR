<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="#{sessionBean1.templatePath}">
    <ui:define name="metaInfo">
        <f:event type="preRenderView"  listener="#{sessionBean1.addNaviTrack('View result', '/Secure/dose/FitResultView.xhtml')}"/> 
    </ui:define>
    <ui:define name="footerout"/>
    <ui:define name="content">
        <h:panelGrid style="padding:30px 40px 20px 40px; font-family: Arial, Helvetica, Geneva; line-height: 23px; width:96%;">
            <h2>
                Feature-level BMDs
            </h2>
            <p>
                A density plot shows the distribution of feature-level benchmark doses (BMDs). The coloured vertical lines show the metabolomic-level point-of-departures (mPOD) 
                estimated based on BMD values from the 20th feature, the 10th percentile, or the most frequent BMD of the 1st curve.
                The table below shows at most top 500 features ranked by their BMD values.
                <b>BMDl</b>: denotes the lower confidence limit for the calculated BMD; 
                <b>BMDu</b>: upper limit of BMD reliability
            </p>

            <h:panelGrid style="width:90%; text-align:center;">  
                <h:panelGrid style="width:100px; text-align: right; float:right" columns="2">
                    <p:commandLink   id="img2" 
                                     actionListener="#{sessionBean1.graphicsLnk_action('dr_histogram')}" 
                                     oncomplete="PF('graphDialog').show()">
                        <i class="pi pi-download pi-2x" ></i>
                    </p:commandLink> 
                </h:panelGrid>
                <img onerror='this.style.display="none"'
                     style="width:10in;"
                     src="#{sessionBean1.getCurrentImageURL('dr_histogram')}"
                     alt="CurveFitBar"/>
            </h:panelGrid>
            <hr class="style-one"/>
            <h3>Result Table</h3>
            <h:form>
                <h:panelGrid style="width:100%; text-align: right">
                    <p:commandButton styleClass="ui-button-outlined"
                                     ajax="false" 
                                     onclick="PrimeFaces.monitorDownload(start, stop);"   
                                     icon="pi pi-download">  
                        <p:fileDownload  value="#{doseResponseBean.resTableFile}" />  
                    </p:commandButton> 
                </h:panelGrid>
                <p:dataTable id="resultTable" var="resBean" value="#{doseResponseBean.resBeans}"  style="width:100%; padding-bottom: 30px;"
                             widgetVar="resTable"  emptyMessage="No record found with given criteria"
                             paginator="true" rows="20" rowsPerPageTemplate="20,50,100"  paginatorPosition="top"                                 
                             paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}">                             
                    <p:columns value="#{doseResponseBean.columns}" var="column" sortBy="#{doseResponseBean.getSortValue(resBean, column.property)}" sortable="true">  
                        <f:facet name="header">  
                            #{column.header}  
                        </f:facet>  
                        <h:outputText escape="false" value="#{resBean.getValue(column.property)}"/>
                    </p:columns>
                    <p:column exportable="false" style="width:40px">  
                        <f:facet name="header">  
                            <h:outputText  escape="false" value="View" /> 
                        </f:facet> 
                        <p:commandButton style="height:30px; width: 30px;"
                                         update=":visView"
                                         onclick="PF('statusDialog').show()"
                                         icon="pi pi-image"
                                         oncomplete="PF('statusDialog').hide(); PF('visDialog').show()"
                                         >  
                            <f:setPropertyActionListener value="#{resBean}" target="#{doseResponseBean.selectedFeature}" /> 
                        </p:commandButton>  
                    </p:column>
                </p:dataTable>              
                <h:panelGrid style="width: 100%; text-align: center; padding: 10px;">
                    <p:commandButton value="Proceed" ajax="false" 
                                     icon="pi pi-angle-double-right" 
                                     onclick="PF('statusDialog').show()" 
                                     oncomplete="PF('statusDialog').hide()"                              
                                     action="Download"/>
                </h:panelGrid> 
            </h:form>
            <p:dialog widgetVar="visDialog" dynamic="true" modal="true" appendTo="@(body)" 
                      header="Dose-response curve fitting"
                      hideEffect="explode" resizable="true" position="center top"> 
                <h:panelGrid id="visView" style="width:380px; text-align: center;">

                    <!-- The command panel element placed above the image -->
                    <h:panelGrid id="command" columns="2" style="float:right; text-align: right;">
                        <p:commandLink actionListener="#{sessionBean1.graphicsLnk_action('metabolite_dr_curve')}" 
                                       update=":myGraphPane"
                                       oncomplete="PF('graphDialog').show()"
                                       title="Customize the graphics output">
                            <i class="pi pi-palette" style="font-size: 1.4rem"></i>
                        </p:commandLink>
                        <p:commandLink id="addDoseToReport" actionListener="#{fireBaseController.addDoseFeatureToReport()}" title="Add to report">
                            <i class="pi pi-file" style="font-size: 1.4rem"/>
                        </p:commandLink> 
                    </h:panelGrid> 

                    <!-- The image element placed below the command panel -->
                    <img id="boximage" onerror='this.style.display="none"' 
                         src="#{doseResponseBean.currentFeatureImgPath}" 
                         alt="FeatureImage" style="width: 100%; height: auto;"/>
                </h:panelGrid> 
            </p:dialog>

        </h:panelGrid> 
    </ui:define>
</ui:composition>
