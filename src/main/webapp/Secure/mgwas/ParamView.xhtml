<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pe="http://primefaces.org/ui/extensions" 
                template="#{sessionBean1.templatePath}">
    <ui:define name="metaInfo">   
        <f:event type="preRenderView" listener="#{sessionBean1.addNaviTrack('Set parameter', '/Secure/mgwas/ParamView.xhtml')}"/>
    </ui:define>
    <ui:define name="myscript">
        <style type="text/css">
            .radio-link-grid .align-with-second-option {
                display: flex;
                align-items: center;
                margin-top: 1.5em; /* Adjust this value based on the actual height of your radio options */
            }
        </style>
    </ui:define>
    <ui:define name="footerout"/>
    <ui:define name="content">
        <h:panelGrid style="padding: 30px 20px 20px 50px; font-size:13px; line-height: 23px; width: 95%">
            <h2>SNP Filtering &amp; Harmonization</h2>
            <p>
                The candidate SNPs are shown below. 
                You can <b>scroll down</b> to apply different filtering and harmonization methods. 
                or manually exclude SNPs based on other metadata (such as population etc).
            </p>
            <h:form id="form">
                <h:panelGrid columns="2" style="width:100%;">
                    <h:panelGrid columns="5" class="surface-card shadow-1 p-4 text-800">
                        <h:outputText escape="false" value="Exposure:"/>
                        <h:outputText escape="false" style="font-weight: bold" value="#{mgwasLoadBean.myCmpd}"/>
                        <p:spacer style="width:30px"/>
                        <h:outputText escape="false" value="Outcome:"/>
                        <h:outputText escape="false" style="font-weight: bold" value="#{mgwasLoadBean.outcome}"/>
                    </h:panelGrid>

                    <p:outputPanel style="width:100%; text-align: right;">   
                        <p:commandButton value="Advanced Filter" onclick="PF('filterDialog').show()"
                                         style="margin-right: 30px"
                                         icon="pi pi-cog"/>
                        <p:commandButton value="Reset" update=":form"
                                         actionListener="#{ mgwasBean.resetSNPTable()}"
                                         icon="pi pi-undo"/>

                    </p:outputPanel>
                </h:panelGrid>  

                <p:dataTable id="resultTable"  paginator="true" paginatorPosition="bottom" rows="10" 
                             resizableColumns="true" emptyMessage="No metabolite(s) have been selected!"
                             paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                             style="font-size: 10px; width: 100%; padding-top:10px" var="rb" value="#{mgwasBean.doSNPViewing()}" rowKey="#{rb.get('rowID')}">  

                    <p:column headerText="SNP ID" sortBy="#{rb.get('col2')}" 
                              width="6">
                        <h:outputText escape="false" value="#{rb.get('col2')}" />
                    </p:column>
                    <p:column headerText="Nearest Gene" sortBy="#{rb.get('col12')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('col12')}"/>   
                    </p:column>
                    <p:column rendered="#{mgwasBean.filtPerformed}" headerText="Pval (outcome)" sortBy="" width="40">
                        <h:outputText escape="false" value="#{rb.get('pvaloutcome')}"/>   
                    </p:column>
                    <p:column headerText="Exposure" sortBy="#{rb.get('col11')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('col11')}"/>   
                    </p:column>
                    <p:column headerText="Pval (exposure)" sortBy="#{rb.get('pval')}" width="40">
                        <h:outputText escape="false" value="#{rb.get('pval')}"/>   
                    </p:column>

                    <p:column headerText="Biofluid" sortBy="#{rb.get('biofluid')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('biofluid')}"/>   
                    </p:column>

                    <p:column headerText="Population" sortBy="#{rb.get('pop')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('pop')}"/>   
                    </p:column>

                    <p:column headerText="Study" sortBy="#{rb.get('study')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('study')}"/>   
                    </p:column>
                    <p:column rendered="#{mgwasBean.steigerOpt eq 'use_steiger' and mgwasBean.filtPerformed}" headerText="Steiger direction" sortBy="#{rb.get('dir')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('dir')}"/>   
                    </p:column>


                    <p:column rendered="#{mgwasBean.steigerOpt eq 'use_steiger' and mgwasBean.filtPerformed}" headerText="Steiger direction" sortBy="#{rb.get('dir')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('dir')}"/>   
                    </p:column>


                    <p:column rendered="#{mgwasBean.steigerOpt eq 'use_steiger' and mgwasBean.filtPerformed}" headerText="Pval (steiger)" sortBy="#{rb.get('stn')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('pvalsteiger')}"/>   
                    </p:column>


                    <p:column headerText="Include" width="5">
                        <p:selectBooleanCheckbox value="#{rb['selected']}">
                            <p:ajax listener="#{mgwasBean.handleSelect(rb)}"/>
                        </p:selectBooleanCheckbox>
                    </p:column>
                </p:dataTable>

                <p:spacer/>
                <h3>Available Methods</h3>
                <p>
                    To properly conduct two-sample MR analysis, the instrumental variables (IV) should have <b>strong effect</b>, <b>independent</b> (i.e. not correlated with each other), 
                    and <b>no horizontal pleiotropy</b> (i.e. affect the outcome only through the metabolite). 
                    The following procedures are provided to facilitate proper MR analysis: 
                </p>


                <p:panelGrid columns="2" id="navipane" layout="tabular" style="width:100%">  
                    <h:panelGroup layout="block" style="width:480px">
                        <b>1. LD-based harmonization </b><br/>
                        Acquisition of independent IVs by performing linkage disequilibrium (LD) clumping.  
                        If a SNP query is absent in the outcome GWAS, search for a proxy SNP in LD with the input SNP.
                    </h:panelGroup>
                    <h:panelGroup layout="block"   style="width:540px">
                        <p:selectBooleanCheckbox id="useClump"
                                                 value="#{mgwasBean.performClump}"
                                                 itemLabel="Use clumping to prune SNPs for LD">
                            <p:ajax event="change" update="form"/>
                        </p:selectBooleanCheckbox>

                        <br/>
                        <p:selectBooleanCheckbox id="useProxy"
                                                 value="#{mgwasBean.performProxy}"
                                                 itemLabel="Using proxy SNPs when a direct SNP query is absent">
                            <p:ajax event="change" update="form"/>
                        </p:selectBooleanCheckbox>


                    </h:panelGroup>

                    <h:panelGroup layout="block" style="width:480px">
                        <b>2. Allele Harmonization</b> <br/>
                        To make sure that the effects of the SNPs on exposure and 
                        outcome are associated with the same allele. 
                    </h:panelGroup>                   
                    <h:panelGroup>
                        <p:selectOneRadio id="harmonize" layout="pageDirection" value="#{mgwasBean.harmonizeOpt}">  
                            <f:selectItem itemLabel="Assume all alleles are presented on the forward strand" itemValue="1" />
                            <f:selectItem itemLabel="Try to infer the forward strand alleles using allele frequency information" itemValue="2" />
                            <f:selectItem itemLabel="Correct the strand for non-palindromic SNPs, but drop all palindromic SNPs" itemValue="3" />
                            <p:ajax event="change" update="form"/>
                        </p:selectOneRadio>
                    </h:panelGroup>

                    <h:panelGroup layout="block" style="width:480px">
                        <b>3. Remove Pleiotropic SNPs</b>  <br/>
                        To exclude SNPs that are associated with multiple metabolites
                    </h:panelGroup>                   
                    <h:panelGroup>
                        <p:selectOneRadio id="pleio" layout="pageDirection" value="#{mgwasBean.pleiotropyOpt}">  
                            <f:selectItem itemLabel="Include SNPs associated with multiple metabolites" itemValue="true" />
                            <f:selectItem itemLabel="Exclude SNPs associated with multiple metabolites" itemValue="false" />
                            <p:ajax event="change" update="form"/>
                        </p:selectOneRadio>
                    </h:panelGroup>


                    <h:panelGroup layout="block" style="width:480px">
                        <b>4. Steiger filtering (reverse causality check)</b><br/>
                        To remove SNPs that are more strongly associated with the outcome than the exposure.
                    </h:panelGroup>
                    <p:selectBooleanCheckbox id="steiger"
                                             value="#{mgwasBean.useSteiger}"
                                             itemLabel="Use steiger filtering"/>
                </p:panelGrid>
                <h:panelGrid style="width:90%; padding: 20px; text-align: center;">
                    <p:commandButton value="Update"
                                     style="width:140px"
                                     update=":form"
                                     onclick="PF('statusDialog').show();"
                                     oncomplete="PF('statusDialog').hide()"
                                     actionListener="#{mgwasBean.performSnpFiltering()}"
                                     />

                </h:panelGrid>


                <h:panelGrid columns="2" style="padding: 30px 20px 20px 20px; width:90%; text-align: center;">
                    <p:commandButton value="Previous"
                                     id="testBn" style="width:120px"
                                     styleClass="prevBn"
                                     icon="pi pi-arrow-circle-left"
                                     action="MgwasUploadView"/>

                    <p:commandButton id="visBn" value="Proceed" style="width:120px"
                                     onclick="PF('statusDialog').show();"
                                     oncomplete="PF('statusDialog').hide()"
                                     icon="pi pi-caret-right"
                                     disabled="#{!mgwasBean.harmonized}"
                                     action="MR method"
                                     /> 
                </h:panelGrid>
            </h:form>

            <p:dialog widgetVar="proxyDialog" dynamic="true" modal="true" appendTo="@(body)" header="LD Proxy Settings" 
                      hideEffect="explode" resizable="true" position="center top"> 
                <h:form>
                    <h:panelGrid>
                        <h:panelGrid>
                            <h:panelGrid columns="3">
                                <h:panelGroup  layout="block">
                                    Minimum LD R<sup>2</sup> value:
                                </h:panelGroup>
                                <p:inputText id="txt1" value="#{mgwasBean.ldThresh}" style="width:100px" />
                                <p:slider for="txt1" minValue="0.6" maxValue="1"  step="0.02" style="width: 140px" />
                            </h:panelGrid>
                        </h:panelGrid> 
                        <h:panelGrid>
                            <h:panelGrid columns="3">
                                <h:outputLabel value="MAF threshold for aligning palindromes: palindromic SNPs"/>
                                <p:inputText id="txt2" value="#{mgwasBean.mafThresh}" style="width:100px" />
                                <p:slider for="txt2" minValue="0.01" maxValue="0.49"  step="0.05" style="width: 140px" />
                            </h:panelGrid>
                        </h:panelGrid> 
                        <h:panelGrid style="width:90%; padding: 20px; text-align: center;">
                            <p:commandButton value="OK"
                                             style="width:140px"
                                             onclick="PF('proxyDialog').hide();"
                                             />
                        </h:panelGrid> 

                    </h:panelGrid> 
                </h:form>
            </p:dialog>
            <p:dialog widgetVar="filterDialog" dynamic="true" modal="false" appendTo="@(body)" 
                      header="Data Filter Dialog" hideEffect="explode" resizable="true"> 
                <h:panelGrid style="width:380px; padding: 10px">
                    <h:form id="filterForm">
                        <h:panelGrid columns="2" >
                            <p:outputLabel style="font-weight: bold" value="Target Column: "/>  
                            <p:selectOneMenu styleClass="menu" panelStyleClass="panel" value="#{mgwasBean.filterCol}">
                                <f:selectItem itemLabel="Pval (exposure)" itemValue="P-value" />
                                <f:selectItem itemLabel="Pval (outcome)" itemValue="harmonized.dat" />
                                <f:selectItem itemLabel="Biofluid" itemValue="biofluid" />
                                <f:selectItem itemLabel="Population" itemValue="pop" />
                                <f:selectItem itemLabel="Study" itemValue="study" />
                            </p:selectOneMenu>  

                            <p:outputLabel style="font-weight: bold" value="Value Criterion:"/> 
                            <h:panelGrid>
                                <p:selectOneMenu styleClass="menu" panelStyleClass="panel" value="#{mgwasBean.filterOpt}">
                                    <f:selectItem itemLabel="(Numerics) At least" itemValue="min" />
                                    <f:selectItem itemLabel="(Character) Matching" itemValue="match" /> 
                                    <f:selectItem itemLabel="(Character) Containing" itemValue="contain" />
                                </p:selectOneMenu> 
                                <p:inputText style="width:160px" value="#{mgwasBean.filterValue}"/>
                            </h:panelGrid>

                            <p:outputLabel style="font-weight: bold" value="Action"/> 
                            <p:selectOneRadio value="#{mgwasBean.filterActOpt}">
                                <f:selectItem itemLabel="Remove" itemValue="remove" /> 
                                <f:selectItem itemLabel="Keep" itemValue="keep" />
                            </p:selectOneRadio> 
                        </h:panelGrid>
                        <h:panelGrid style="width:100%; text-align: center">
                            <p:commandButton value="Submit" icon="pi pi-caret-right"
                                             update=":form"
                                             actionListener="#{mgwasBean.updateEntries}"
                                             oncomplete="PF('filterDialog').hide()"
                                             />
                        </h:panelGrid>
                    </h:form>
                </h:panelGrid> 
            </p:dialog>
            <p:dialog widgetVar="keyDialog" dynamic="true" modal="true" appendTo="@(body)" header="OpenGWAS API Token" 
                      hideEffect="explode" resizable="true"> 
                <h:form>
                    <h:panelGrid>
                        <h:panelGrid>
                            <p>
                                OpenGWAS is an open-source and academic database. Please apply for your own API key (<a href="https://api.opengwas.io/" target="_Blank">here</a>) to continue. 
                            </p>
                            <h:panelGrid columns="2">
                                <h:outputLabel value="Paste your API token here: "/>
                                <p:inputText id="txt2" value="#{mgwasBean.current_key}" style="width:400px" />
                            </h:panelGrid>
                        </h:panelGrid> 
                        <h:panelGrid style="width:100%; padding: 10px; text-align: center;" columns="2">
                            <p:commandButton value="OK"
                                             style="width:60px"
                                             onclick="PF('keyDialog').hide();"/>
                            <p:commandButton value="Cancel"
                                             style="width:85px"
                                             onclick="PF('keyDialog').hide();"/>
                        </h:panelGrid> 

                    </h:panelGrid> 
                </h:form>
            </p:dialog>


        </h:panelGrid>
    </ui:define>
</ui:composition>


