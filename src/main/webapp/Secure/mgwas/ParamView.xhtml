<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pe="http://primefaces.org/ui/extensions" 
                template="#{sessionBean1.templatePath}">
    <ui:define name="metaInfo">   
        <f:event type="preRenderView" listener="#{sessionBean1.addNaviTrack('Set parameter', '/Secure/mgwas/ParamView.xhtml')}"/>
    </ui:define>
    <ui:define name="myscript">
        <style type="text/css">
            .radio-link-grid .align-with-second-option {
                display: flex;
                align-items: center;
                margin-top: 1.5em; /* Adjust this value based on the actual height of your radio options */
            }
        </style>
    </ui:define>
    <ui:define name="footerout"/>
    <ui:define name="content">
        <h:panelGrid style="padding: 30px 20px 20px 50px; font-size:13px; line-height: 23px; width: 95%">
            <h2>SNP Filtering &amp; Harmonization</h2>
            <p>
                To properly conduct two-sample MR analysis, the instrumental variables (IV) should be <b>independent</b> (i.e. not correlated with each other), showing <b>strong effect</b> 
                (i.e. significant p-values), and <b>no horizontal pleiotropy</b> (i.e. affect the outcome only through the metabolite). 
                The step provides following procedures to facilitate proper MR analysis: 
                <ul>
                    <li>
                        Acquisition of independent IVs by performing linkage disequilibrium (LD) clumping. 
                    </li>
                    <li>
                        In cases where the SNP query is absent in the outcome GWAS, a proxy SNP in LD with the input SNP, utilizing the 1000 
                        Genomes Project (phase 3). 
                    </li>
                    <li>    
                        Harmonizing exposure and outcome data to make sure that the effects of the SNPs on exposure and 
                        outcome are associated with the same allele. You should also review the table below to perform 
                        further harmonization based on other metadata (such as population, study info, etc)
                    </li>
                    <li>
                        To control horizontal pleiotropy, you can choose to exclude SNPs that are associated with multiple metabolites. It is advised to exclude them because causal analysis's assumption is on SNP associated with single SNP.
                    </li>
                </ul>
            </p>

            <!--
            Three common options are available. The links below are answers to some related questions. 
            <ul>
                <li>
                    <a href="https://omicsforum.ca/t/what-is-ld-clumping/1041" target="_blank">
                        What is LD clumping?
                    </a>
                </li>
                <li>
                    <a href="https://omicsforum.ca/t/what-is-allele-harmonization/1043" target="_blank">
                        What is allele harmonization?
                    </a>
                </li>
                <li>
                    <a href="https://omicsforum.ca/t/what-is-palindromic-snp/1042" target="_blank">
                        What is palindromic SNP?
                    </a>
                </li>
                <li>
                    <a href="https://omicsforum.ca/t/what-are-the-differences-between-the-mr-analysis-methods/1045" target="_blank">
                        What are the differences between the MR analysis methods?
                    </a>
                </li>
            </ul>
            The statistical methods for pre-processing and MR analysis are based on the <b>TwoSampleMR</b> and <b>MRInstruments</b> R packages. 
            -->

            <h:form id="form">
                <p:selectOneRadio id="ldProxies" columns="1" value="#{mgwasBean.ldProxyOpt}" layout="custom">
                    <f:selectItem itemLabel="Do not use proxies" itemValue="no_proxy"/>
                    <f:selectItem itemLabel="Use proxies and allow palindrome SNPs" itemValue="use_proxy"/>
                    <p:ajax event="change" update="form:ldClump"/>
                </p:selectOneRadio>  

                <p:panelGrid columns="2" id="navipane" layout="tabular" style="width:100%">  
                    <h:panelGroup layout="block" style="width:480px">
                        <b>1. LD Clumping</b><br/>
                        Acquisition of independent IVs by performing linkage disequilibrium (LD) clumping. 
                    </h:panelGroup>
                    <h:panelGroup layout="block" style="width:540px">
                        <p:selectOneRadio id="ldClump" layout="pageDirection" columns="1" value="#{mgwasBean.ldclumpOpt}">  
                            <f:selectItem itemLabel="Do not check for LD between SNPs" itemValue="no_ldclump" />
                            <f:selectItem itemLabel="Use clumping to prune SNPs for LD" itemValue="use_ldclump"/>
                            <p:ajax event="change" update="form:ldClump"/>
                        </p:selectOneRadio>
                    </h:panelGroup>

                    <h:panelGroup layout="block" style="width:480px">
                        <b>2. LD Proxies</b><br/>
                        If a SNP query is absent in the outcome GWAS, search for a proxy SNP in LD with the input SNP. 
                    </h:panelGroup>

                    <h:panelGrid columns="2" styleClass="radio-link-grid">
                        <p:radioButton for="ldProxies" itemIndex="0"/>
                        <p:outputLabel value="Do not use proxies"/>

                        <p:radioButton for="ldProxies" itemIndex="1"/>
                        <h:panelGroup layout="block">
                            <p:outputLabel value="Use proxies and allow palindrome SNPs"/>
                            <font style="color:grey; font-size: 11px">(Min LD R<sup>2</sup>: 0.8, and max MAF: 0.3 for palindromic SNPS)</font>
                        </h:panelGroup>
                    </h:panelGrid>

                    <h:panelGroup layout="block" style="width:480px">
                        <b>3. Allele Harmonization</b> <br/>
                        To make sure that the effects of the SNPs on exposure and 
                        outcome are associated with the same allele. 
                    </h:panelGroup>                   
                    <h:panelGroup>
                        <p:selectOneRadio id="harmonize" columns="1" value="#{mgwasBean.harmonizeOpt}" layout="pageDirection">  
                            <f:selectItem itemLabel="Assume all alleles are presented on the forward strand" itemValue="1" />
                            <f:selectItem itemLabel="Try to infer the forward strand alleles using allele frequency information" itemValue="2" />
                            <f:selectItem itemLabel="Correct the strand for non-palindromic SNPs, but drop all palindromic SNPs" itemValue="3" />
                            <p:ajax event="change" update="form"/>
                        </p:selectOneRadio>
                    </h:panelGroup>

                    <h:panelGroup layout="block" style="width:480px">
                        <b>4. Horizontal Pleiotropy</b>  <br/>
                        To exclude SNPs that are associated with multiple metabolites
                    </h:panelGroup>                   
                    <h:panelGroup>
                        <p:selectOneRadio id="pleio" columns="1" value="#{mgwasBean.pleiotropyOpt}" layout="pageDirection">  
                            <f:selectItem itemLabel="Include SNPs associated with multiple metabolites" itemValue="true" />
                            <f:selectItem itemLabel="Exclude SNPs associated with multiple metabolites" itemValue="false" />
                            <p:ajax event="change" update="form"/>
                        </p:selectOneRadio>
                    </h:panelGroup>

                </p:panelGrid>
                <h:panelGrid columns="2" style="width:90%; padding: 20px; text-align: center;">
                    <p:commandButton value="Submit"
                                     style="width:140px"
                                     update="form"
                                     onclick="PF('statusDialog').show();"
                                     oncomplete="PF('statusDialog').hide()"
                                     actionListener="#{mgwasBean.performSnpFiltering()}"
                                     />
                </h:panelGrid>

                <hr class="style-one"/>

                <p:dataTable id="resultTable1"
                             class="surface-card shadow-1 p-0 text-800"
                             resizableColumns="true" emptyMessage="No metabolite(s) have been selected!"
                             paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                             style="font-size: 10px; width: 100%; padding-top:20px" var="rb" value="#{mgwasBean.resTable}" rowKey="#{rb.get('rowID')}">  

                    <p:headerRow field="col1"
                                 expandable="true"
                                 expanded="#{rb.get('expanded')}">

                        <p:column colspan="8">
                            <!-- Custom content for the header row, can be adjusted as needed -->
                            <h:outputText escape="false" value="#{rb.get('col1')} (#{mgwasBean.getGroupCount(rb.get('col1'))})"/>
                        </p:column>
                    </p:headerRow>
                    <p:column headerText="#{ mgwasTableBean.getColHeader(1)}" sortBy="#{rb.get('col2')}" 
                              width="6">
                        <h:outputText escape="false" value="#{rb.get('col2')}" />
                    </p:column>
                    <p:column headerText="Associated Metabolites" sortBy="#{rb.get('col11')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('col11')}"/>   
                    </p:column>
                    <p:column headerText="Nearest Gene" sortBy="#{rb.get('col12')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('col12')}"/>   
                    </p:column>

                    <p:column headerText="P-value" sortBy="#{rb.get('pval')}" width="40"                             
                              >
                        <h:outputText escape="false" value="#{rb.get('pval')}"/>   
                    </p:column>

                    <!--
                    <p:column headerText="P-value Outcome" sortBy="#{rb.get('pvaloutcome')}" rendered="#{ mgwasResBean.tableType eq 'harmonized.dat' }" width="40"                             
                              >
                        <h:outputText escape="false" value="#{rb.get('pvaloutcome')}"/>   
                    </p:column>
                    -->
                    <p:column headerText="Biofluid" sortBy="#{rb.get('biofluid')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('biofluid')}"/>   
                    </p:column>

                    <p:column headerText="Population" sortBy="#{rb.get('pop')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('pop')}"/>   
                    </p:column>

                    <p:column headerText="Study" sortBy="#{rb.get('study')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('study')}"/>   
                    </p:column>
                    <!--
                    <p:column headerText="#{ mgwasTableBean.getColHeader(9)}" sortBy="#{rb.get('col10')}" 
                              width="40">
                        <h:outputText escape="false" value="#{rb.get('col10')}"/>   
                        </p:column> -->
                    <p:column headerText="Include" width="5">
                        <p:selectBooleanCheckbox value="#{rb['selected']}">
                            <p:ajax listener="#{mgwasBean.handleSelect(rb)}"/>
                        </p:selectBooleanCheckbox>
                    </p:column>
                </p:dataTable>

                <h:panelGrid columns="2" style="padding: 30px 20px 20px 20px; width:90%; text-align: center;">
                    <p:commandButton value="Previous"
                                     id="testBn" style="width:120px"
                                     styleClass="prevBn"
                                     icon="pi pi-arrow-circle-left"
                                     action="MgwasUploadView"/>

                    <p:commandButton id="visBn" value="Proceed" style="width:120px"
                                     onclick="PF('statusDialog').show();"
                                     oncomplete="PF('statusDialog').hide()"
                                     icon="pi pi-caret-right"
                                     disabled="#{!mgwasBean.harmonized}"
                                     action="MR method"
                                     /> 
                </h:panelGrid>

            </h:form>

            <p:dialog widgetVar="proxyDialog" dynamic="true" modal="true" appendTo="@(body)" header="LD Proxy Settings" 
                      hideEffect="explode" resizable="true" position="center top"> 
                <h:form>
                    <h:panelGrid>
                        <h:panelGrid>
                            <h:panelGrid columns="3">
                                <h:panelGroup  layout="block">
                                    Minimum LD R<sup>2</sup> value:
                                </h:panelGroup>
                                <p:inputText id="txt1" value="#{mgwasBean.ldThresh}" style="width:100px" />
                                <p:slider for="txt1" minValue="0.6" maxValue="1"  step="0.02" style="width: 140px" />
                            </h:panelGrid>
                        </h:panelGrid> 
                        <h:panelGrid>
                            <h:panelGrid columns="3">
                                <h:outputLabel value="MAF threshold for aligning palindromes: palindromic SNPs"/>
                                <p:inputText id="txt2" value="#{mgwasBean.mafThresh}" style="width:100px" />
                                <p:slider for="txt2" minValue="0.01" maxValue="0.49"  step="0.05" style="width: 140px" />
                            </h:panelGrid>
                        </h:panelGrid> 
                        <h:panelGrid style="width:90%; padding: 20px; text-align: center;">
                            <p:commandButton value="OK"
                                             style="width:140px"
                                             onclick="PF('proxyDialog').hide();"
                                             />
                        </h:panelGrid> 

                    </h:panelGrid> 
                </h:form>
            </p:dialog>

            <p:dialog widgetVar="keyDialog" dynamic="true" modal="true" appendTo="@(body)" header="OpenGWAS API Token" 
                      hideEffect="explode" resizable="true"> 
                <h:form>
                    <h:panelGrid>
                        <h:panelGrid>
                            <p>
                                OpenGWAS is an open-source and academic database. Please apply for your own API key (<a href="https://api.opengwas.io/" target="_Blank">here</a>) to continue. 
                            </p>
                            <h:panelGrid columns="2">
                                <h:outputLabel value="Paste your API token here: "/>
                                <p:inputText id="txt2" value="#{mgwasBean.current_key}" style="width:400px" />
                            </h:panelGrid>
                        </h:panelGrid> 
                        <h:panelGrid style="width:100%; padding: 10px; text-align: center;" columns="2">
                            <p:commandButton value="OK"
                                             style="width:60px"
                                             onclick="PF('keyDialog').hide();"/>
                            <p:commandButton value="Cancel"
                                             style="width:85px"
                                             onclick="PF('keyDialog').hide();"/>
                        </h:panelGrid> 

                    </h:panelGrid> 
                </h:form>
            </p:dialog>


        </h:panelGrid>
    </ui:define>
</ui:composition>


