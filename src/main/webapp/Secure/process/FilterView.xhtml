<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="#{sessionBean1.templatePath}"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <ui:define name="metaInfo">
        <f:event type="preRenderView" listener="#{sessionBean1.addNaviTrack('Data filter', '/Secure/process/FilterView.xhtml')}"/> 
        <f:event type="preRenderView" listener="#{procBean.prepareFilterView()}"/>  
    </ui:define>
    <ui:define name="footerout"/>
    <ui:define name="content">
        <h:panelGrid styleClass="my-content-panel">
            <h2>Data Filtering:</h2>
            <p>
                The purpose of the data filtering is to identify and remove variables that are unlikely to be of use 
                when modeling the data. No phenotype information are used in the filtering process, so the result 
                can be used with any downstream analysis. This step is strongly recommended for untargeted metabolomics 
                datasets (i.e. spectral binning data, peak lists) with large number of variables, many of them are from
                baseline noises. Filtering can usually improve the results. For details, please refer to the paper by  
                <a href='http://www.biomedcentral.com/1471-2105/10/11' target='_blank'>Hackstadt, et al</a>.
            </p>
            <p>
                Non-informative variables can be characterized in three groups: 
                1) variables that show <b>low repeatability</b> - this can be measured using QC samples using the 
                relative standard deviation(RSD = SD/mean). Features with high percent RSD should be removed from the subsequent analysis (the suggested 
                threshold is 20% for LC-MS and 30% for GC-MS); 2) variables that are <b>near-constant</b> throughout the experiment 
                conditions - these variables can be detected using standard deviation (SD); or the robust estimate 
                such as interquantile range (IQR); and 3) variables of <b>very small values</b> (close to baseline or detection limit) - these 
                variables can be detected using mean or median. For data filtering based on the last two categories, you can turn off data filtering 
                by dragging the slider to adjust the percentage to filter out to be 0.
            </p>

            <h:form>
                <p:panelGrid columns="3" layout="tabular" class="surface-card shadow-1 p-4 text-800">

                    <h:panelGroup layout="block" style="width:200px">
                        <h:outputText style="font-weight: bold"
                                      value="Low-quality filter"/>
                    </h:panelGroup>
                    <h:panelGrid>
                        <h:panelGroup layout="block">
                            <p:selectBooleanCheckbox value="#{procBean.doBlankSub}"
                                                     disabled="#{not sessionBean1.containsBlank}"
                                                     itemLabel="#{procBean.blankLbl}"
                                                     style="line-height: 18px"/>
                            <p:graphicImage id="formatIcon3" url="/resources/images/ui-help.png" alt="help"/>
                            <p:tooltip for="formatIcon3" styleClass="helpTip">
                                <p>
                                    The is based on the ratio of the average intensity of the samples to that of the BLANK samples.
                                    <ol>
                                        <li>
                                            A ratio threshold is automatically estimated using a kernel density estimation model. 
                                            If the estimation fails, the user-defined threshold will be used instead
                                        </li>
                                        <li>
                                            All features are evaluated by calculating the ratio of sample (non-BLANK) intensities to BLANK 
                                            sample intensities 
                                        </li>
                                        <li>
                                            Features with ratios below the threshold will be removed 
                                        </li>
                                    </ol>
                                </p>
                            </p:tooltip>
                        </h:panelGroup>
                        <hr/>
                        <h:panelGroup layout="block">
                            <p:selectBooleanCheckbox id="missingChk"
                                                     value="#{procBean.removeMissing}"
                                                     disabled ="#{sessionBean1.missingDisabled}"
                                                     itemLabel="#{procBean.missingLbl}"
                                                     style="line-height: 18px"/>
                        </h:panelGroup>
                    </h:panelGrid>
                    <h:panelGrid>
                        <h:outputText style="font-weight: bold" value="For blank substraction: "/>
                        <h:panelGrid columns="4" style="padding: 10px;">
                            <h:outputText value="Sample/blank ratio threshold:"/>
                            <h:inputHidden id="txtBlank" value="#{procBean.blankCutoff}"/>
                            <p:slider for="txtBlank" display="outputBlank"
                                      minValue="2" maxValue="100"
                                      disabled="#{not sessionBean1.containsBlank}"
                                      style="width:160px; margin-left:4px; margin-right:6px"
                                      displayTemplate="{value}"/>
                            <h:outputText id="outputBlank"
                                          value="#{procBean.blankCutoff}"/>
                        </h:panelGrid>
                        <hr/>
                        <h:outputText style="font-weight: bold;" value="For missing value exclusion: "/>
                        <h:panelGrid columns="3" style="padding: 10px;">
                            <p:outputLabel value="Remove features with &gt;"/>
                            <p:inputText style="width:50px" 
                                         disabled ="#{sessionBean1.missingDisabled}"
                                         value="#{procBean.missingPercent}"/>
                            <p:outputLabel value=" %"/>

                            <p:outputLabel for="grpWiseChk"
                                           value="Use group-wise threshold"
                                           style="margin-top:8px;"/>
                            <p:selectBooleanCheckbox id="grpWiseChk"
                                                     disabled ="#{sessionBean1.missingDisabled}"
                                                     value="#{procBean.grpMissFilter}"/>
                            <p:commandLink value="View" style="text-decoration: underline;"
                                           disabled ="#{sessionBean1.missingDisabled}"
                                           actionListener="#{procBean.imputeButton_action('orig')}"
                                           onclick="PF('statusDialog').show();"
                                           oncomplete="PF('statusDialog').hide();PF('missDialog').show()"/>  
                        </h:panelGrid>
                    </h:panelGrid>

                    <h:outputText style="font-weight: bold" value="Low-repeatability filter"/>

                    <p:selectBooleanCheckbox value="#{procBean.doQCFiltering}" 
                                             disabled="#{not sessionBean1.containsQC}"
                                             itemLabel="#{procBean.qcLbl}"
                                             style="line-height: 18px"/> 

                    <h:panelGrid columns="5" style="padding: 10px;">
                        <h:outputText value="RSDs greater than:"/>
                        <h:inputHidden id="txt2" value="#{procBean.qcCutoff}"/> 
                        <p:slider for="txt2" minValue="10" maxValue="60" display="output" 
                                  disabled="#{not sessionBean1.containsQC}"
                                  style="width:100px; margin-left: 4px; margin-right: 6px" 
                                  displayTemplate="{value}%"/>
                        <h:outputText id="output" value="#{procBean.qcCutoff}%"/>
                        <p:commandLink value="View" style="text-decoration: underline;"
                                       onclick="PF('statusDialog').show();"
                                       disabled="#{not sessionBean1.containsQC}"
                                       oncomplete="PF('statusDialog').hide();PF('rsdDialog').show()"   
                                       update=":hisTab:cmdPane"
                                       actionListener="#{procBean.viewRsdPlot()}"/>  
                    </h:panelGrid>

                    <h:outputText style="font-weight: bold" value="Low-variance filter"/>
                    <p:selectOneRadio layout="pageDirection" value="#{procBean.varFilterOpt}" style="font:Arial,sans-serif; font-size: 13px" styleClass="hideDisabled">
                        <f:selectItem itemLabel="Interquantile range (IQR)" itemValue="iqr" /> 
                        <f:selectItem itemLabel="Standard deviation (SD)" itemValue="sd" /> 
                        <f:selectItem itemLabel="Median absolute deviation (MAD)" itemValue="mad" /> 
                        <f:selectItem itemLabel="Relative standard deviation (RSD = SD/mean)" itemValue="rsd" /> 
                        <f:selectItem itemLabel="Non-parametric relative standard deviation (MAD/median)" itemValue="nrsd" /> 
                    </p:selectOneRadio>
                    <h:panelGrid columns="2" style="padding: 10px;">
                        <h:outputText value="Percentage to filter out:"/>
                        <h:inputHidden id="txt3" value="#{procBean.filterCutoff}"/>
                        <p:slider for="txt3" display="output1" style="width: 160px" 
                                  minValue="#{sessionBean1.filterMin}"
                                  displayTemplate="{value}%"/>
                        <h:outputText id="output1" value="#{procBean.filterCutoff}%"/>
                    </h:panelGrid>

                    <h:outputText style="font-weight: bold" value="Low-abundance filter"/>
                    <p:selectOneRadio layout="pageDirection" value="#{procBean.intFilterOpt}" style="font:Arial,sans-serif; font-size: 13px" styleClass="hideDisabled">
                        <f:selectItem itemLabel="Mean intensity value" itemValue="mean" /> 
                        <f:selectItem itemLabel="Median intensity value" itemValue="median" /> 
                    </p:selectOneRadio>
                    <h:panelGrid columns="2" style="padding: 10px;">
                        <h:outputText value="Percentage to filter out:"/>
                        <h:inputHidden id="txt4" value="#{procBean.intFilterCutoff}"/>
                        <p:slider for="txt4" display="output2" style="width: 160px" 
                                  minValue="0"
                                  displayTemplate="{value}%"/>
                        <h:outputText id="output2" value="#{procBean.intFilterCutoff}%"/>
                    </h:panelGrid>
                </p:panelGrid>

                <h:panelGrid columns="2" style="width: 900px; font-size: 14px; text-align: center; padding-top: 20px;">
                    <p:commandButton value="Submit" style="width:120px"
                                     onclick="PF('statusDialog').show()"
                                     oncomplete="PF('statusDialog').hide()"   
                                     update=":hisTab:cmdPane"
                                     actionListener="#{procBean.filterButton_action()}"/>   
                    <p:commandButton value="Proceed"  
                                     style="width:120px" 
                                     onclick="PF('statusDialog').show()"
                                     oncomplete="PF('statusDialog').hide()"
                                     rendered="#{!workflowBean.editMode}"
                                     ajax="false" 
                                     action="#{procBean.filterProceed_action()}"/>    
                </h:panelGrid> 
            </h:form>
        </h:panelGrid> 
    </ui:define>
</ui:composition>
