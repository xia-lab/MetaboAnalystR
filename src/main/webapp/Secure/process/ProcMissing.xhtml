<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="#{sessionBean1.templatePath}">
    <ui:define name="metaInfo">
        <f:event type="preRenderView" listener="#{procBean.imputeButton_action()}"/> 
        <f:event type="preRenderView"  listener="#{sessionBean1.addNaviTrack('Missing value', '/Secure/process/ProcMissing.xhtml')}"/> 
    </ui:define>
    <ui:define name="content">
        <h:form>
            <h:panelGrid style="padding:30px 40px 20px 50px; font-size: 13px; line-height: 23px; width: 95%; ">
                <h2>Missing value estimation:</h2>
                <p>
                    Too many missing values will cause difficulties for downstream analysis. There are several different 
                    methods for this purpose. 
                </p>
                <p>
                    <b>Univariate statistical methods</b>: Replacing missing values by LoD/mean/median/min. The default method LoD (limit of detection) will replace
                    all the missing values with a small values (i.e. 1/5 of the minimum positive values of individual features) assuming to be the detection limit. 
                    The assumption of this approach is that missing values are due to low abundance (i.e. below the detection limit).
                    By default, LoD/mean/median/min are computed for individual features based on their non-missing data points. 
                </p>
                <p>   
                    <b>Multivariate statistical methods</b>: MetaboAnalyst also offers other advanced statistical methods, such as k-nearest neighbours based on similar features 
                    - KNN (feature-wise), k-nearest neighbours based on similar samples - KNN (sample-wise), probabilistic PCA (PPCA), 
                    Bayesian PCA (BPCA) method, singular value decomposition (SVD) method to impute the missing values 
                    (<a href="http://www.ncbi.nlm.nih.gov/pubmed/17344241">ref.</a>). Note for KNN, k is set to 10 (the default value). 
                    These advanced statistical methods are able to estimate missing values based on patterns of missing value distribution. 
                </p>
                <h:panelGrid id="mvPlotPane" style="width:90%; padding:20px;; text-align: center" 
                             rendered="#{not sessionBean1.missingDisabled}">
                    <h3>
                        Missing value distributions
                    </h3>
                    <p>
                        <h:outputText value="#{procBean.missingMsg}" style="font-size: 14px; color:orange" escape="false"/>. 
                        When missing value distributions are significantly different across groups, 
                        It may be more appropriate to estimate LoD/mean/median/min values for individual groups.
                    </p>
                    <p:commandLink actionListener="#{sessionBean1.graphicsLnk_action('qc_miss')}"
                                   update=":myGraphPane"
                                   style="margin-left: 70%"
                                   oncomplete="PF('graphDialog').show()"
                                   title="Customise the graphics output">
                        <img src="#{facesContext.externalContext.requestContextPath}/resources/images/imgcenter.png"/>
                    </p:commandLink>

                    <img onerror="this.style.display='none'"
                         src="#{sessionBean1.getCurrentImageURL('qc_miss')}"
                         alt="Missing-value lollipop plot"
                         style="width:7in;"/>

                </h:panelGrid>

                <h:panelGrid 
                    class="surface-card shadow-1 p-4 text-800"
                    style="border: 1px dashed grey; padding: 20px 20px 20px 40px; width: 780px; margin-left: 8%">
                    <p:outputLabel value="Step 1. Remove features with too many missing values" style="font-size: 13px; font-weight: bold"/>
                    <h:panelGrid columns="4" style="padding-bottom: 12px">
                        <p:selectBooleanCheckbox value="#{procBean.removeMissing}" style="line-height: 18px"/> 
                        <p:outputLabel value="Remove features with &gt;"/> 
                        <p:inputText style="width:50px" value="#{procBean.missingPercent}"/>
                        <p:outputLabel value="% missing values"/>
                    </h:panelGrid>
                    <p:outputLabel value="Step 2. Estimate the remaining missing values" style="font-size: 13px; font-weight: bold"/>
                    <p:selectOneRadio id="rowRadio" value="#{procBean.missingImputeOpt}" layout="custom">
                        <f:selectItem itemLabel="Exclude variables with missing value" itemValue="exclude"/> 
                        <f:selectItem itemLabel="Replace by a small value (half of the minimum positive value in the original data)" itemValue="min"/>                         
                        <f:selectItem itemLabel="Replace by feature mode" itemValue="replaceCol"/> 
                        <f:selectItem itemLabel="Impute" itemValue="impute"/> 
                    </p:selectOneRadio>
                    <h:panelGrid columns="2" cellpadding="8">
                        <p:radioButton for="rowRadio" itemIndex="0"/>
                        <p:outputLabel value="Exclude variables with missing values"/>
                        <p:radioButton for="rowRadio" itemIndex="1"/>
                        <h:panelGroup>
                            <p:outputLabel value="Replace by LoDs (1/5 of the minimum positive value of each variable)"/> 
                            <p:spacer style="width: 12px"/>
                            <p:selectBooleanCheckbox value="#{procBean.grpLod}" 
                                                     itemLabel="Use group-specific value"
                                                     style="line-height: 18px"/> 
                        </h:panelGroup>
                        <p:radioButton for="rowRadio" itemIndex="2"/>
                        <h:panelGroup>
                            <p:outputLabel value="Replace by column (feature) "/>  
                            <h:panelGroup>
                                <p:selectOneMenu styleClass="menu" panelStyleClass="panel" value="#{procBean.replaceVarOpt}">
                                    <f:selectItem itemLabel="mean" itemValue="mean"/> 
                                    <f:selectItem itemLabel="median" itemValue="median"/> 
                                    <f:selectItem itemLabel="min" itemValue="colmin"/> 
                                </p:selectOneMenu>
                                <p:spacer style="width: 12px"/>
                                <p:selectBooleanCheckbox value="#{procBean.grpMeasure}" 
                                                         itemLabel="Use group-specific value"
                                                         style="line-height: 18px"/> 
                            </h:panelGroup>
                        </h:panelGroup>
                        <p:radioButton for="rowRadio" itemIndex="3"/>
                        <h:panelGroup>
                            <p:outputLabel value="Estimate missing values using "/>        
                            <p:selectOneMenu styleClass="menu" panelStyleClass="panel" value="#{procBean.imputeAlgOpt}">
                                <f:selectItem itemLabel="KNN (feature-wise)" itemValue="knn_var"/> 
                                <f:selectItem itemLabel="KNN (sample-wise)" itemValue="knn_smp"/> 
                                <f:selectItem itemLabel="PPCA" itemValue="ppca"/> 
                                <f:selectItem itemLabel="BPCA" itemValue="bpca"/> 
                                <f:selectItem itemLabel="SVD Impute" itemValue="svdImpute"/> 
                            </p:selectOneMenu>
                        </h:panelGroup>
                    </h:panelGrid>
                </h:panelGrid>
                <h:panelGrid style="width: 670px; text-align: center; margin-left: 10%">
                    <p:commandButton value="Process" ajax="false" 
                                     icon="pi pi-caret-right"
                                     onclick="PF('statusDialog').show()" 
                                     action="#{procBean.performMissingImpute()}"/>
                </h:panelGrid> 
            </h:panelGrid> 
        </h:form>
    </ui:define>
</ui:composition>
