<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="#{sessionBean1.templatePath}">
    <ui:define name="metaInfo">
        <f:event type="preRenderView" listener="#{analBean.performDefaultAnalysis('PCA')}"/> 
        <f:event type="preRenderView"  listener="#{sessionBean1.addNaviTrack('PCA', '/Secure/analysis/PCAView.xhtml')}"/> 
    </ui:define>
    <ui:define name="myscript">
        <script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/resources/jscripts/xialabpro/report_generation.js"></script>
        <script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/resources/jscripts/hammerjs2.0.8.js"></script>
        <script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/resources/jscripts/chartjs-plugin-zoom.min.js"></script>
        <script type="text/javascript" src="#{facesContext.externalContext.requestContextPath}/resources/jscripts/xialabpro/pro_utils.js"></script>  
        <script type="text/javascript">

            var usr = "#{sessionBean1.getUserDir()}";
            usr = usr.replace(/\/\//g, '/');
            var light = $(parent.window.document).find("#formHidden\\:selectedTheme").val();


            function extender() {
                var textColor;
                var gridColor;
                var pcaLoadX = "Loading " + "#{pcaBean.pcaLoadX}";
                var pcaLoadY = "Loading " + "#{pcaBean.pcaLoadY}";
                var pointMap;

                if (light === "light") {
                    textColor = "grey";
                    gridColor = 'lightgrey';
                } else {
                    textColor = "white";
                    gridColor = 'rgb(200, 200, 200,0.2)';
                }
                $.getJSON(usr + "/pointMap.json", function (data) {

                    pointMap = data;

                    var options = {
                        options: {
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    title: {
                                        display: true,
                                        color: textColor,
                                        text: "Loading - Y"
                                    },
                                    ticks: {
                                        color: textColor
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        color: textColor,
                                        text: "Loading - X"
                                    },
                                    ticks: {
                                        color: textColor
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                zoom: {
                                    zoom: {
                                        enabled: true,
                                        drag: {
                                            enabled: true,
                                            borderColor: 'rgb(54, 162, 235)',
                                            borderWidth: 1,
                                            backgroundColor: 'rgba(54, 162, 235, 0.3)'
                                        },
                                        mode: 'xy'
                                    }
                                },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        label: function (tooltipItem, data) {
                                            var pointKey = tooltipItem.datasetIndex + ":" + tooltipItem.dataIndex;
                                            var id = pointMap[pointKey]; // Assuming pointMap is accessible here
                                            return id;
                                        }
                                    }
                                }
                            }
                        }
                    };
                    $.extend(true, this.cfg.config, options);
                    if (this.chart) {
                        this.chart.update();
                    } else {
                        console.error("Chart.js instance not found on PrimeFaces widget.");
                    }
                }.bind(this));
            }
            function setupTheme() {
                var button = $("button[id$='toggleTm']");
                //console.log(button)
                button.each(function () {
                    //console.log("Clicking button: ", this); // Log the button element to be clicked
                    this.click(); // Trigger the click event
                });
            }
            ;

        </script>
        <style>
            .vertical-text {
                display:inline-block;
                white-space: nowrap;
                filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);
                -webkit-transform: rotate(270deg);
                -ms-transform: rotate(270deg);
                transform: rotate(270deg);
            }

            #ac\:chart_canvas { /* Note the escaped colon if ac is a component ID */
                width: 800px !important; /* Your desired width */
                height: 720px !important; /* Your desired height */
                display: block; /* Ensure it behaves as a block element */
            }

            /* If the chart is responsive, you might also need to ensure its parent containers allow it */
            /* This might be needed if the chart still doesn't grow despite the canvas styling */
            .ui-chart { /* The main PrimeFaces chart container div */
                width: 800px !important;
                height: 720px !important;
            }
        </style>
    </ui:define>
    <ui:define name="footerout"/>
    <ui:define name="content">
        <h:inputHidden id="mydir" value="#{sessionBean1.getJsonDir('pca_score3d')}" />
        <h:inputHidden id="mydir2" value="#{sessionBean1.getJsonDir('pca_loading3d')}" />

        <h:panelGrid styleClass="my-content-panel">
            <h2>Principal Component Analysis (PCA)</h2>
            <p:tabView id="ac" widgetVar="tabWidgetVar" style="min-width: 900px; max-width: 1200px; border: none; font-size: 13px;">
                <p:tab title ="Overview">
                    <p>
                        P-values are calculated with PERMANOVA (999 permutations) on the sample scores for each PC pair
                    </p>
                    <h:form id="form1">
                        <h:panelGrid columns="2" style="width: 70%">
                            <h:panelGroup>
                                <h:outputLabel style="font-weight: bold" value="Display pairwise score plot for top "/>
                                <p:selectOneMenu styleClass="menu" panelStyleClass="panel" style="width:50px" value="#{pcaBean.pcaPairNum}">
                                    <f:selectItems value="#{pcaBean.pcaPCs}" />
                                </p:selectOneMenu>
                                <h:outputLabel style="font-weight: bold" value=" PCs"/>
                            </h:panelGroup>
                            <p:commandButton value="Update" update=":ac:form1:pairPane  :hisTab:cmdPane" actionListener="#{pcaBean.pcaPairBtn_action()}"/>   
                        </h:panelGrid>
                        <h:panelGrid id="pairPane" style="text-align: center; width: 1000px;">
                            <h:panelGrid style="text-align: right; padding-left: 700px; width: 760px;">
                                <p:commandLink actionListener="#{sessionBean1.graphicsLnk_action('pca_pair')}" 
                                               update=":myGraphPane"
                                               oncomplete="PF('graphDialog').show()"
                                               title="Customize the graphics output">
                                    <i class="pi pi-palette" style="font-size: 1.1rem"/>
                                </p:commandLink>
                            </h:panelGrid>
                            <img onerror='this.style.display="none"' 
                                 style="width:10in; padding-left: 50px"
                                 src="#{sessionBean1.getCurrentImageURL96('pca_pair')}" alt="PCAPairImage"/>
                        </h:panelGrid>        
                    </h:form>
                </p:tab>
                <p:tab title ="Scree Plot">
                    <h:form id="form2">
                        <h:panelGrid columns="2" style="width: 70%">
                            <h:panelGroup>
                                <h:outputLabel style="font-weight: bold" value="Display the scree plot for top "/>
                                <p:selectOneMenu styleClass="menu" panelStyleClass="panel" style="width:50px" value="#{pcaBean.pcaScreeNum}">
                                    <f:selectItems value="#{pcaBean.pcaPCs}" />
                                </p:selectOneMenu>
                                <h:outputLabel style="font-weight: bold" value=" PCs"/>
                            </h:panelGroup>
                            <p:commandButton value="Update" update=":ac:form2  :hisTab:cmdPane" actionListener="#{pcaBean.pcaScreeBtn_action()}"/>   
                        </h:panelGrid>

                        <h:outputText value ="The green line on top shows the accumulated variance explained; the blue line underneath shows the 
                                      variance explained by individual PC"/>
                        <h:panelGrid id="screePane" style="text-align: right; padding-left: 700px; width: 760px;">
                            <p:commandLink actionListener="#{sessionBean1.graphicsLnk_action('pca_scree')}" 
                                           update=":myGraphPane"
                                           oncomplete="PF('graphDialog').show()"
                                           title="Customize the graphics output">
                                <i class="pi pi-palette" style="font-size: 1.1rem"/>
                            </p:commandLink>
                        </h:panelGrid>
                        <img onerror='this.style.display="none"' 
                             style="width:10in; padding-left: 50px"
                             src="#{sessionBean1.getCurrentImageURL('pca_scree')}" alt="PCAScreeImage"/>

                    </h:form>
                </p:tab>
                <p:tab title ="2D Scores Plot">
                    <p>
                        The statistical significances of the group patterns are evaluated using PERMANOVA. 
                        The distributions are computed using the Euclidean distance based on the two PCs in the current display. 
                        For multiple groups, in addition to the overall significance as displayed, you can also click the 
                        table icon to view pair-wise PERMANOVA results.
                    </p>
                    <h:form id="form3">
                        <h:panelGrid columns="2" style="padding: 2px 20px 10px 20px;">
                            <h:panelGrid columns="2" cellpadding="5" style="width:560px; padding-right: 60px">
                                <h:panelGroup layout="block" style="width:220px">
                                    <h:outputLabel style="font-weight: bold" value="Specify PC on X-axis:"/>
                                </h:panelGroup>
                                <p:selectOneMenu styleClass="menu" panelStyleClass="panel" style="width:50px" value="#{pcaBean.pcaScoreX}">
                                    <f:selectItems value="#{pcaBean.pcaAllPCs}" />
                                </p:selectOneMenu>                             
                                <h:outputLabel style="font-weight: bold" value="Specify PC on Y-axis:"/>
                                <p:selectOneMenu styleClass="menu" panelStyleClass="panel" style="width:50px" value="#{pcaBean.pcaScoreY}">
                                    <f:selectItems value="#{pcaBean.pcaAllPCs}" />
                                </p:selectOneMenu> 
                                <h:outputLabel style="font-weight: bold" value="Display 95% confidence regions:"/>
                                <p:selectBooleanCheckbox value ="#{pcaBean.displayConfs}" style="line-height: 18px"/>    
                                <h:outputLabel style="font-weight: bold" value="Display sample names:"/>
                                <p:selectBooleanCheckbox value ="#{pcaBean.displayNames}" style="line-height: 18px"/>                                
                                <h:outputLabel style="font-weight: bold" value="Use grey-scale colors:"/>
                                <p:selectBooleanCheckbox value ="#{pcaBean.greyScale}" style="line-height: 18px"/>

                                <h:outputLabel style="font-weight: bold" value="Update font/label size"/>
                                <p:selectOneMenu value="#{pcaBean.cexOpt}">
                                    <f:selectItem itemLabel="Default (reset)" itemValue="na" />
                                    <f:selectItem itemLabel="Increase (++)" itemValue="increase" />
                                    <f:selectItem itemLabel="Decrease (--)" itemValue="decrease" />
                                </p:selectOneMenu>

                                <p:commandLink action="#{pcaBean.flipPCA()}" value="Flip Image" style="font-weight: bold" update=":ac:form3:score2dPane :ac:loadPane :ac:syn3d"/>
                                <p:selectOneRadio value="#{pcaBean.flipOpt}">
                                    <f:selectItem itemLabel="X axis" itemValue="x" />
                                    <f:selectItem itemLabel="Y axis" itemValue="y" />
                                    <f:selectItem itemLabel="All" itemValue="all" />
                                </p:selectOneRadio>

                            </h:panelGrid>
                            <p:commandButton value="Update" update=":ac:form3:score2dPane  :hisTab:cmdPane" actionListener="#{pcaBean.pcaScore2dBtn_action()}" partialSubmit="true"/>   
                        </h:panelGrid>

                        <h:panelGrid id="score2dPane" style="text-align: center; width:1000px; padding-top: 20px">
                            <h:panelGrid columns="2" style="text-align: right; padding-left: 700px; width: 760px;">
                                <p:commandLink actionListener="#{sessionBean1.graphicsLnk_action('pca_score2d')}" 
                                               update=":myGraphPane"
                                               oncomplete="PF('graphDialog').show()"
                                               title="Customize the graphics output">
                                    <i class="pi pi-palette" style="font-size: 1.1rem"/>
                                </p:commandLink>

                                <p:commandLink onclick="PF('detailDialog').show()" title="View pair-wise PERMANOVA" rendered="#{sessionBean1.multiGroup}">
                                    <img src="#{facesContext.externalContext.requestContextPath}/resources/images/table.png"/>
                                </p:commandLink>
                            </h:panelGrid>

                            <h:panelGrid style="text-align: center; width:100%">
                                <h:outputText escape="false" value="#{pcaBean.stat4PCA}" style="font-weight: bold; font-size: 14px;"/>
                            </h:panelGrid>
                            <img onerror='this.style.display="none"' 
                                 style="width:9in; padding-left: 50px"
                                 src="#{sessionBean1.getCurrentImageURL('pca_score2d')}" alt="PCAScore2DImage"/>

                            <p:dialog widgetVar="detailDialog" dynamic="true" 
                                      header="Pair-wise PERMANOVA"
                                      modal="true" appendTo="@(body)" width="540" height="280"
                                      hideEffect="explode" resizable="true"> 
                                <h:panelGrid id="detailView" style="width:540px; padding: 10px; font-size: 12px">
                                    <h:outputText escape="false" value="#{pcaBean.permAnovaTxt}"/>
                                </h:panelGrid> 
                            </p:dialog>
                        </h:panelGrid>  
                    </h:form>
                </p:tab>
                <p:tab title ="Loadings Plot">
                    <h:panelGrid columns="2" style="width:1000px">
                        <h:form id="form5">
                            <h:panelGrid columns="2" style="padding: 2px 20px 6px 20px;">
                                <h:panelGrid columns="2" cellpadding="5" style="width:540px; padding-right: 60px">
                                    <h:panelGroup layout="block" style="width: 140px">
                                        <h:outputLabel style="font-weight: bold" value="X-axis PC:"/>
                                    </h:panelGroup>
                                    <p:selectOneMenu styleClass="menu" panelStyleClass="panel" style="width:50px" value="#{pcaBean.pcaLoadX}">
                                        <f:selectItems value="#{pcaBean.pcaAllPCs}" />
                                    </p:selectOneMenu>

                                    <h:outputLabel style="font-weight: bold" value="Y-axis PC:"/>
                                    <p:selectOneMenu styleClass="menu" panelStyleClass="panel" style="width:50px" value="#{pcaBean.pcaLoadY}">
                                        <f:selectItems value="#{pcaBean.pcaAllPCs}" />
                                    </p:selectOneMenu>

                                    <h:panelGroup layout="block">
                                        <h:outputLabel style="font-weight: bold" value="Set annotations:"/> <br/>
                                        <h:outputText style="color:grey" value="(for download image only)"/>
                                    </h:panelGroup>
                                    <p:selectOneRadio layout="pageDirection" value="#{pcaBean.loadOpt}">
                                        <f:selectItem itemLabel="Label all varaibles" itemValue="all" /> 
                                        <f:selectItem itemLabel="Do not label variables" itemValue="none" /> 
                                        <f:selectItem itemLabel="Label only variables of interest" itemValue="custom" /> 
                                    </p:selectOneRadio>
                                </h:panelGrid>

                                <p:commandButton value="Update" 
                                                 update=":ac:loadPane  :hisTab:cmdPane" 
                                                 actionListener="#{pcaBean.pcaLoadBtn_action()}"
                                                 partialSubmit="true"/>

                            </h:panelGrid>
                        </h:form>
                    </h:panelGrid>

                    <h:panelGrid columns="2" style="width: 1000px; text-align: center; padding-top: 20px">
                        <h:panelGrid style="width: 500px; text-align: left">
                            <p:outputLabel style="font-weight:bold; color: #FFAE20" value="Click a point to view; drag to zoom; reset zoom at bottom"/>
                        </h:panelGrid>
                        <h:panelGrid columns="4" style="width:200px; text-align: right;">
                            <p:commandLink action="#{sessionBean1.detailsLnk_action('pca')}" title="View the detailed data table">
                                <img src="#{facesContext.externalContext.requestContextPath}/resources/images/table.png"/>
                            </p:commandLink>
                            <p:commandLink actionListener="#{sessionBean1.graphicsLnk_action('pca_loading')}" 
                                           update=":myGraphPane"
                                           oncomplete="PF('graphDialog').show()"
                                           title="Customize the graphics output">
                                <i class="pi pi-palette" style="font-size: 1.1rem"/>
                            </p:commandLink>
                            <p:commandLink title="Reset Zoom" onclick="PF('chart').chart.resetZoom()">
                                <i class="pi pi-undo"></i>
                            </p:commandLink>
                            <p:graphicImage id="helpIcon" url="/resources/images/ui-help.png"  alt="help"/>
                        </h:panelGrid>
                        <p:tooltip for="helpIcon" styleClass="helpTip">
                            <p>
                                Boxplot of the selected metabolomic feature from the user's uploaded data. The black dots
                                represent the concentrations of the selected feature from all samples. The notch indicates
                                the 95% confidence interval around the median of each group, defined as +/- 1.58*IQR/sqrt(n).
                                The notch can be used to evaluate differences between groups; if the notches 
                                do not overlap, the medians are likely different. Meanwhile, the mean concentration of each group is indicated
                                with a yellow diamond.
                            </p>
                        </p:tooltip>
                    </h:panelGrid>
                    <h:panelGrid id="loadPane" style="text-align: center; width:100%; margin-top: 20px">
                        <p:chart id="chart" widgetVar="chart" 
                                 value="#{detailsBean.getModel1('pca')}"  
                                 extender="extender">
                            <p:ajax event="itemSelect" listener="#{detailsBean.itemSelect}" 
                                    update=":hisTab:cmdPane" oncomplete="PF('FeatureView').show();"/>
                        </p:chart> 
                    </h:panelGrid>
                    <p:commandButton id="toggleTm" style="display:none;" onclick="#{detailsBean.toggleTheme('pca')}" update="chart" />
                </p:tab>
                <p:tab title ="Synchronized 3D Plots">
                    <h:form id="form4">
                        <h:panelGrid style="width: 95%;" columns="2">
                            <ul>
                                <li>
                                    <u>Dragging</u> to rotate the view around the axis; <u>Scrolling</u> to zoom in and out.
                                </li>
                                <li>
                                    For data points on the loading plot, <u>double clicking</u> to view a corresponding summary; 
                                </li>
                                <li>
                                    Click <u>Update</u> if you have updated color schema or flipped image in the 2D score view. 
                                </li>
                                <li>  
                                    The colors of data points in the loading plot are based on their distances to the origin (0,0,0),  
                                    with yellow for close and dark red for distant data points    
                                </li>
                            </ul>
                            <p:commandButton value="Update" update="mydir2 :ac:syn3d :hisTab:cmdPane" actionListener="#{pcaBean.pcaScore3dBtn_action(true)}" partialSubmit="true"/>   

                        </h:panelGrid>
                    </h:form>
                    <h:panelGrid id="syn3d" style="width: 1100px">
                        <iframe id="frameId" style="width: 1100px; height: 840px; margin: 0; padding: 0;" frameborder="0" loading="lazy"
                                src="../viewer/_scatter3D_viewer.html"/>
                    </h:panelGrid>
                </p:tab>
                <p:tab title ="Biplot">
                    <h:form id="form6">
                        <h:panelGrid columns="2" style="padding: 2px 20px 10px 20px;">
                            <h:panelGrid columns="2" cellpadding="5" style="width:480px; padding-right: 60px">
                                <h:outputLabel style="font-weight: bold" value="Select PC for X-axis:"/>
                                <p:selectOneMenu styleClass="menu" panelStyleClass="panel" style="width:50px" value="#{pcaBean.pcaBiplotX}">
                                    <f:selectItems value="#{pcaBean.pcaAllPCs}" />
                                </p:selectOneMenu>
                                <h:outputLabel style="font-weight: bold" value="Select PC for Y-axis:"/>
                                <p:selectOneMenu styleClass="menu" panelStyleClass="panel" style="width:50px" value="#{pcaBean.pcaBiplotY}">
                                    <f:selectItems value="#{pcaBean.pcaAllPCs}" />
                                </p:selectOneMenu>  
                                <h:outputLabel style="font-weight: bold" value="Number of top features:"/>
                                <h:panelGroup>
                                    <p:inputText id="topFeat" value="#{pcaBean.pcaBiplotFeat}" style="width: 50px" required="true" requiredMessage="Set the number of top features!"/>
                                    <p:slider for="topFeat" minValue="1" maxValue="#{sessionBean1.featureNumber}" step="1" style="width: 50px" />
                                </h:panelGroup>
                            </h:panelGrid>
                            <p:commandButton value="Update" update=":ac:form6:biplotPane  :hisTab:cmdPane" actionListener="#{pcaBean.pcaBiplotBtn_action()}"/>   
                        </h:panelGrid>
                        <h:panelGrid id="biplotPane" style="text-align: center; width: 1000px; padding-top: 20px">
                            <h:panelGrid style="text-align: right; padding-left: 700px; width: 760px;">
                                <p:commandLink actionListener="#{sessionBean1.graphicsLnk_action('pca_biplot')}" 
                                               update=":myGraphPane"
                                               oncomplete="PF('graphDialog').show()"
                                               title="Customize the graphics output">
                                    <i class="pi pi-palette" style="font-size: 1.1rem"/>
                                </p:commandLink>
                            </h:panelGrid>
                            <img onerror='this.style.display="none"' 
                                 style="width:9in; padding-left: 50px"
                                 src="#{sessionBean1.getCurrentImageURL('pca_biplot')}" alt="PCABiplotImage"/>
                        </h:panelGrid>  
                    </h:form>
                </p:tab>
            </p:tabView> 
        </h:panelGrid> 
        <p:dialog modal="true" widgetVar="exportDialog" style="width:600px; height: 580px" appendTo="@(body)">  
            <h:outputLabel style="font-size: 13px; font-weight: bold" value="Right click the PNG image to save as your preferred name:"/><br/>
            <image id="downloadimage"></image>  
        </p:dialog> 

        <ui:include src="/template/_feature_dialog.xhtml" />
        <ui:include src="/template/_graphic_dialog.xhtml" />
    </ui:define>
</ui:composition>
